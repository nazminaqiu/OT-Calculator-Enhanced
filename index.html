<!doctype html>
<html lang=en>
<head>
<meta charset=UTF-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>OT Calculator</title>
<script src=https://cdn.tailwindcss.com></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css>
<script src=https://cdn.jsdelivr.net/npm/flatpickr></script>
<script src=https://cdn.jsdelivr.net/npm/chart.js></script>
<style>:root{--primary-indigo:#6366f1;--dark-indigo:#4f46e5;--light-indigo:#e0e7ff;--lightest-indigo:#c7d2fe;--danger-red:#ef4444;--dark-red:#dc2626;--success-green:#10b981;--info-blue:#3b82f6;--warning-orange:#f59e0b;--gray-900:#1f2937;--gray-800:#374151;--gray-700:#4b5563;--gray-600:#6b7280;--gray-500:#9ca3af;--gray-400:#d1d5db;--gray-300:#e5e7eb;--gray-200:#f3f4f6;--gray-100:#f9fafb;--gray-50:#f9fafb}body{font-family:Inter,sans-serif;background-color:var(--gray-200);display:flex;justify-content:center;align-items:flex-start;min-height:100vh;padding:20px;box-sizing:border-box}.main-wrapper{display:flex;flex-direction:column;gap:25px;max-width:1200px;width:100%}@media (min-width:1024px){.main-wrapper{flex-direction:row;align-items:flex-start}}.form-content{background-color:#fff;padding:30px;border-radius:15px;box-shadow:0 10px 25px rgba(0,0,0,.1);flex-grow:1;width:100%}@media (min-width:1024px){.form-content{min-width:600px}}.summary-sidebar{background-color:#fff;padding:25px;border-radius:15px;box-shadow:0 10px 25px rgba(0,0,0,.1);position:sticky;top:20px;align-self:flex-start;width:100%;min-width:300px;flex-shrink:0}@media (min-width:1024px){.summary-sidebar{width:350px}}.input-group label{font-weight:600;color:var(--gray-800);margin-bottom:8px;display:block}.input-group input,.input-group select{width:100%;padding:12px;border:1px solid var(--gray-400);border-radius:8px;font-size:1rem;color:var(--gray-700);transition:border-color .2s ease-in-out,box-shadow .2s ease-in-out}.input-group input:focus,.input-group select:focus{outline:0;border-color:var(--primary-indigo);box-shadow:0 0 0 3px rgba(99,102,241,.2)}.input-group select:disabled{background-color:var(--gray-200);cursor:not-allowed}.btn{padding:12px 20px;border-radius:8px;font-weight:600;cursor:pointer;transition:background-color .2s ease-in-out,transform .1s ease-in-out;display:inline-flex;align-items:center;justify-content:center;gap:8px}.btn-primary{background-color:var(--primary-indigo);color:#fff}.btn-primary:hover{background-color:var(--dark-indigo);transform:translateY(-1px)}.btn-secondary{background-color:var(--light-indigo);color:var(--dark-indigo)}.btn-secondary:hover{background-color:var(--lightest-indigo);transform:translateY(-1px)}.btn-danger{background-color:var(--danger-red);color:#fff}.btn-danger:hover{background-color:var(--dark-red);transform:translateY(-1px)}.results-section h3{font-size:1.5rem;font-weight:700;color:var(--gray-900);margin-bottom:15px}.results-section p{font-size:1.1rem;margin-bottom:8px;color:var(--gray-800)}.results-section p strong{color:var(--gray-900)}.ot-entry-row{display:flex;flex-direction:column;gap:15px;align-items:stretch;margin-bottom:15px;padding:15px;background-color:var(--gray-100);border-radius:8px;border:1px solid var(--gray-300)}.ot-entry-row .input-group{margin-bottom:0}.ot-entry-row .input-group label{font-size:.85rem;margin-bottom:4px}.ot-entry-row input,.ot-entry-row select{padding:8px;font-size:.9rem}.message-box{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background-color:#fff;padding:30px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.2);z-index:1000;text-align:center;min-width:300px;max-width:90%;border:1px solid var(--gray-400);opacity:0;transform:translate(-50%,-50%) scale(.9);transition:opacity .3s ease-out,transform .3s ease-out}.message-box.show{opacity:1;transform:translate(-50%,-50%) scale(1)}.message-box h4{font-size:1.5rem;font-weight:700;color:var(--gray-900);margin-bottom:15px}.message-box p{font-size:1.1rem;color:var(--gray-700);margin-bottom:25px}.message-box-buttons{display:flex;justify-content:center;gap:15px}.message-box button{background-color:var(--primary-indigo);color:#fff;padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer;transition:background-color .2s ease-in-out}.message-box button:hover{background-color:var(--dark-indigo)}.message-box .btn-cancel{background-color:var(--gray-300);color:var(--gray-700)}.message-box .btn-cancel:hover{background-color:var(--gray-400)}.manual-entry-modal{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);display:flex;justify-content:center;align-items:center;z-index:1000;opacity:0;transition:opacity .3s ease-out}.manual-entry-modal.show{opacity:1}.manual-entry-modal-content{background-color:#fff;padding:30px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.2);text-align:center;min-width:350px;max-width:90%;border:1px solid var(--gray-400);transform:scale(.9);transition:transform .3s ease-out}.manual-entry-modal.show .manual-entry-modal-content{transform:scale(1)}.manual-entry-modal-content h4{font-size:1.5rem;font-weight:700;color:var(--gray-900);margin-bottom:15px}.manual-entry-modal-content .input-group{margin-bottom:20px}.manual-entry-modal-content .modal-buttons{display:flex;justify-content:center;gap:15px}@media (max-width:768px){.form-content,.summary-sidebar{padding:20px}.ot-entry-row .remove-btn-container{display:flex;justify-content:flex-end;margin-top:10px}}.ot-group-section{margin-bottom:20px;padding:15px;background-color:#f0f4f8;border-radius:10px;border:1px solid #e2e8f0}.ot-group-section h4{font-size:1.25rem;font-weight:700;color:#2d3748;margin-bottom:10px;border-bottom:1px solid #cbd5e0;padding-bottom:5px}.loading-indicator{margin-left:10px;font-size:.9em;color:var(--primary-indigo);font-weight:500}#userIdDisplay{font-size:.8em;color:var(--gray-600);text-align:right;margin-top:-15px;margin-bottom:15px;word-break:break-all}.highlight-new{animation:highlightFade 2s ease-out forwards}@keyframes highlightFade{from{background-color:#e0f2fe}to{background-color:var(--gray-100)}}.new-badge{background-color:var(--success-green);color:#fff;padding:2px 8px;border-radius:9999px;font-size:.75rem;font-weight:600;margin-left:8px;display:inline-block;vertical-align:middle}.summary-inline-group{display:flex;flex-wrap:wrap;gap:10px;font-size:1rem;color:var(--gray-800);margin-bottom:8px}.summary-inline-group strong{display:block;width:100%;margin-bottom:4px}.summary-inline-item{display:inline-block;padding:4px 8px;background-color:var(--light-indigo);border-radius:6px;color:var(--dark-indigo);font-weight:500}.collapsible-header{display:flex;justify-content:space-between;align-items:center;cursor:pointer;padding:10px 0;border-bottom:1px solid #cbd5e0;margin-bottom:15px}.collapsible-header h3{margin-bottom:0}.collapsible-content{overflow:hidden;transition:max-height .3s ease-out}.collapsible-content.collapsed{max-height:0!important}.collapsible-icon{transition:transform .3s ease-out}.collapsible-icon.rotated{transform:rotate(90deg)}.input-error{border-color:var(--danger-red);box-shadow:0 0 0 3px rgba(239,68,68,.2)}.error-message{color:var(--danger-red);font-size:.85rem;margin-top:4px}.status-message{margin-left:10px;font-size:.9em;font-weight:500;opacity:0;transition:opacity .3s ease-in-out}.status-message.show{opacity:1}.status-message.loading{color:var(--primary-indigo)}.status-message.success{color:var(--success-green)}.status-message.error{color:var(--danger-red)}.no-entries-message{text-align:center;color:var(--gray-600);padding:20px;border:1px dashed var(--gray-400);border-radius:8px;margin-top:15px}.input-with-clear{position:relative;display:flex;align-items:center}.input-with-clear input{padding-right:36px}.clear-input-btn{position:absolute;right:8px;background:0 0;border:none;cursor:pointer;color:var(--gray-500);padding:4px;border-radius:50%;transition:background-color .2s ease-in-out,color .2s ease-in-out;display:flex;align-items:center;justify-content:center}.clear-input-btn:hover{background-color:var(--gray-300);color:var(--gray-700)}.allocation-choice-modal .modal-buttons button{width:100%}.allocation-choice-modal .modal-buttons{flex-direction:column}.toggle-switch{position:relative;display:inline-block;width:60px;height:34px}.toggle-switch input{opacity:0;width:0;height:0}.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;-webkit-transition:.4s;transition:.4s;border-radius:34px}.slider:before{position:absolute;content:"";height:26px;width:26px;left:4px;bottom:4px;background-color:#fff;-webkit-transition:.4s;transition:.4s;border-radius:50%}input:checked+.slider{background-color:var(--primary-indigo)}input:focus+.slider{box-shadow:0 0 1px var(--primary-indigo)}input:checked+.slider:before{-webkit-transform:translateX(26px);-ms-transform:translateX(26px);transform:translateX(26px)}#toastContainer{position:fixed;bottom:1rem;right:1rem;z-index:2000;display:flex;flex-direction:column;gap:.5rem;max-width:300px}.toast{background-color:#333;color:#fff;padding:.75rem 1rem;border-radius:.5rem;box-shadow:0 4px 12px rgba(0,0,0,.2);opacity:0;transform:translateY(20px);transition:opacity .3s ease-out,transform .3s ease-out}.toast.show{opacity:1;transform:translateY(0)}.toast.info{background-color:var(--info-blue)}.toast.success{background-color:var(--success-green)}.toast.error{background-color:var(--danger-red)}.toast.warning{background-color:var(--warning-orange)}#loadingOverlay{transition:opacity .3s ease-in-out}.loader{border-top-color:var(--primary-indigo);animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}.tooltip-container{position:relative;display:inline-flex;align-items:center;margin-left:.5rem;cursor:help}.tooltip-content{position:absolute;bottom:100%;left:50%;transform:translateX(-50%) translateY(-.5rem);background-color:#333;color:#fff;padding:.5rem .75rem;border-radius:.375rem;font-size:.875rem;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .2s ease-out,transform .2s ease-out;z-index:10}.tooltip-container:hover .tooltip-content{opacity:1;transform:translateX(-50%) translateY(-1rem)}.chart-container{position:relative;width:100%;height:256px;display:flex;align-items:center;justify-content:center;background-color:var(--gray-50);border-radius:8px;overflow:hidden}.chart-placeholder{color:var(--gray-500);font-style:italic;text-align:center;padding:1rem}</style>
</head>
<body>
<div class=main-wrapper>
<div class=form-content>
<h2 class="text-3xl font-extrabold text-center text-gray-900 mb-6">OT Calculator</h2>
<div id=userIdDisplay class=hidden></div>
<div class="bg-blue-50 p-6 rounded-xl border border-blue-200 mb-6">
<div class=collapsible-header data-target=howToUseContent>
<h3 class="text-xl font-bold text-blue-800">How to Use This Calculator</h3>
<svg class="collapsible-icon h-6 w-6 text-blue-600" fill=none viewBox="0 0 24 24" stroke=currentColor>
<path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M9 5l7 7-7 7"/>
</svg>
</div>
<div id=howToUseContent class=collapsible-content>
<ul class="list-disc list-inside text-gray-700 space-y-2">
<li><strong>1. Employee Settings:</strong> Enter your basic monthly salary. Optionally, set a target OT pay.</li>
<li><strong>2. OT Planning Date Range:</strong> Define the period for which you want to calculate or plan your overtime.</li>
<li><strong>3. Public Holiday Management:</strong> Add any public holidays within your planning range. OT on these days will be calculated with a higher multiplier.</li>
<li><strong>4. OT Multiplier Settings:</strong> Adjust the overtime rates for different types of days (weekdays, off days, rest days, public holidays).</li>
<li><strong>5. Daily Overtime Entries:</strong>
<ul class="list-circle list-inside ml-4 mt-1 space-y-1">
<li>The **Allocation Strategy** is now set automatically:
<ul>
<li><strong>Target-Driven:</strong> Automatically selected when you set a "Target OT Pay". The calculator will allocate hours to meet your target. In this mode, daily OT hours are **randomized** to provide a more "humanized" distribution, while still aiming to hit the target.</li>
<li><strong>Workload-Driven:</strong> Automatically selected when you have no target pay. Hours will be allocated for all days based on the "Workload Preset". In this mode, daily OT hours are **randomized** within the min/max ranges defined by the preset.</li>
</ul>
</li>
<li>Select a **Workload Preset** (Light, Moderate, Heavy) to guide auto-allocation.</li>
<li>Click "Auto Allocate Hours" to generate entries. You will be prompted to either **auto allocate new entries (clearing existing)** or **fill remaining hours (keeping existing)**. For all newly allocated entries, the **start and end times are randomized**.</li>
<li>Click "Add OT Entry" to manually add entries for specific dates.</li>
<li>You can edit hours, dates, and types for each entry.</li>
<li>"Save Data" and "Load Data" buttons allow you to persist your entries.</li>
</ul>
</li>
<li><strong>6. Reset & Re-allocate All:</strong> Click this to clear all existing entries and perform a fresh auto-allocation.</li>
<li><strong>7. Calculation Summary:</strong> Review your total hours, pay per category, combined OT pay, and expected total salary.</li>
<li><strong>8. Export Summary:</strong> Save a text file with a detailed breakdown of your calculations.</li>
</ul>
</div>
</div>
<div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-6">
<h3 class="text-xl font-bold text-gray-800 mb-4">Employee Settings</h3>
<div class="grid grid-cols-1 md:grid-cols-2 gap-5">
<div class=input-group>
<label for=basicSalary>Basic Monthly Salary (RM)</label>
<div class=input-with-clear>
<input type=number id=basicSalary value=3700.00 min=0 step=0.01 class=shadow-sm>
<button type=button class=clear-input-btn aria-label="Clear Basic Monthly Salary">
<svg xmlns=http://www.w3.org/2000/svg class="h-4 w-4" fill=none viewBox="0 0 24 24" stroke=currentColor>
<path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M6 18L18 6M6 6l12 12"/>
</svg>
</button>
</div>
</div>
<div class=input-group>
<label for=targetOTPaySelect>Target OT Pay (RM) (Optional)</label>
<select id=targetOTPaySelect class="shadow-sm mb-2">
<option value="">No Target</option>
<option value=custom>Other (Enter Manually)</option>
</select>
<div class=input-with-clear>
<input type=number id=customTargetOTPayInput class="shadow-sm hidden" placeholder="Enter custom target pay">
<button type=button class="clear-input-btn hidden" id=clearCustomTargetOTPayBtn aria-label="Clear Custom Target OT Pay">
<svg xmlns=http://www.w3.org/2000/svg class="h-4 w-4" fill=none viewBox="0 0 24 24" stroke=currentColor>
<path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M6 18L18 6M6 6l12 12"/>
</svg>
</button>
</div>
</div>
<div class=input-group>
<label for=minTotalOTHours>Min Total OT Hours (Optional)
<span class=tooltip-container>
<svg xmlns=http://www.w3.org/2000/svg class="h-4 w-4 text-gray-400" fill=none viewBox="0 0 24 24" stroke=currentColor>
<path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
</svg>
<span class=tooltip-content>The minimum total OT hours to aim for during auto-allocation.</span>
</span>
</label>
<div class=input-with-clear>
<input type=number id=minTotalOTHours min=0 step=0.5 class=shadow-sm placeholder="e.g., 140">
<button type=button class=clear-input-btn id=clearMinTotalOTHoursBtn aria-label="Clear Min Total OT Hours">
<svg xmlns=http://www.w3.org/2000/svg class="h-4 w-4" fill=none viewBox="0 0 24 24" stroke=currentColor>
<path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M6 18L18 6M6 6l12 12"/>
</svg>
</button>
</div>
<div id=minMaxHoursError class=error-message></div>
</div>
<div class=input-group>
<label for=maxTotalOTHours>Max Total OT Hours (Optional)
<span class=tooltip-container>
<svg xmlns=http://www.w3.org/2000/svg class="h-4 w-4 text-gray-400" fill=none viewBox="0 0 24 24" stroke=currentColor>
<path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
</svg>
<span class=tooltip-content>The maximum total OT hours not to exceed during auto-allocation.</span>
</span>
</label>
<div class=input-with-clear>
<input type=number id=maxTotalOTHours min=0 step=0.5 class=shadow-sm placeholder="e.g., 150">
<button type=button class=clear-input-btn id=clearMaxTotalOTHoursBtn aria-label="Clear Max Total OT Hours">
<svg xmlns=http://www.w3.org/2000/svg class="h-4 w-4" fill=none viewBox="0 0 24 24" stroke=currentColor>
<path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M6 18L18 6M6 6l12 12"/>
</svg>
</button>
</div>
</div>
</div>
<div class=mt-6>
<label class="block text-xl font-bold text-gray-800 mb-3">Auto-Allocate to:</label>
<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
<div class="flex items-center">
<input type=checkbox id=allocateWorkingDay class="h-5 w-5 text-primary-indigo rounded border-gray-300 focus:ring-primary-indigo" checked>
<label for=allocateWorkingDay class="ml-2 text-gray-700 font-medium">Working Day</label>
</div>
<div class="flex items-center">
<input type=checkbox id=allocateOffDay class="h-5 w-5 text-primary-indigo rounded border-gray-300 focus:ring-primary-indigo" checked>
<label for=allocateOffDay class="ml-2 text-gray-700 font-medium">Off Day</label>
</div>
<div class="flex items-center">
<input type=checkbox id=allocateRestDay class="h-5 w-5 text-primary-indigo rounded border-gray-300 focus:ring-primary-indigo" checked>
<label for=allocateRestDay class="ml-2 text-gray-700 font-medium">Rest Day</label>
</div>
<div class="flex items-center">
<input type=checkbox id=allocatePublicHoliday class="h-5 w-5 text-primary-indigo rounded border-gray-300 focus:ring-primary-indigo" checked>
<label for=allocatePublicHoliday class="ml-2 text-gray-700 font-medium">Public Holiday</label>
</div>
</div>
</div>
<p class="text-sm text-gray-600 mt-4">
Working Schedule: 5 days/week, Saturday: Off Day, Sunday: Rest Day. For payroll, employer uses 26 working days monthly.
</p>
</div>
<div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-6">
<h3 class="text-xl font-bold text-gray-800 mb-4">OT Planning Date Range</h3>
<div class=input-group>
<label for=dateRangeInput>Select Date Range</label>
<div class="flex items-center gap-2">
<input id=dateRangeInput class="shadow-sm flex-grow" placeholder="Click to select date range" readonly>
<button type=button id=setThisMonthBtn class="btn btn-secondary p-2" aria-label="Set date range to this month">
This Month
</button>
</div>
<div id=dateRangeError class=error-message></div>
</div>
</div>
<div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-6">
<div class=collapsible-header data-target=publicHolidaysContent>
<h3 class="text-xl font-bold text-gray-800">Public Holiday Management</h3>
<svg class="collapsible-icon h-6 w-6 text-gray-600" fill=none viewBox="0 0 24 24" stroke=currentColor>
<path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M9 5l7 7-7 7"/>
</svg>
</div>
<div id=publicHolidaysContent class=collapsible-content>
<div class="flex flex-col sm:flex-row gap-4 mb-4">
<div class="input-group flex-grow">
<label for=publicHolidayDate>Add Public Holiday Date</label>
<div class="flex items-center gap-2">
<input type=date id=publicHolidayDate class="shadow-sm flex-grow">
<button type=button id=setPublicHolidayTodayBtn class="btn btn-secondary p-2" aria-label="Set public holiday date to today">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor>
<path fill-rule=evenodd d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule=evenodd />
</svg>
</button>
</div>
</div>
<button id=addPublicHolidayDateBtn class="btn btn-secondary mt-auto" aria-label="Add public holiday">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor>
<path fill-rule=evenodd d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule=evenodd />
</svg>
Add Holiday
</button>
</div>
<ul id=publicHolidaysList class="list-disc list-inside ml-4 text-gray-700">
</ul>
</div>
</div>
<div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-6">
<div class=collapsible-header data-target=otMultiplierContent>
<h3 class="text-xl font-bold text-gray-800">OT Multiplier Settings</h3>
<svg class="collapsible-icon h-6 w-6 text-gray-600" fill=none viewBox="0 0 24 24" stroke=currentColor>
<path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M9 5l7 7-7 7"/>
</svg>
</div>
<div id=otMultiplierContent class=collapsible-content>
<div id=otMultiplierInputs class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-4">
</div>
<button id=resetMultipliersBtn class="btn btn-secondary" aria-label="Reset OT multipliers to default">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor>
<path fill-rule=evenodd d="M10 18a8 8 0 100-16 8 8 0 000 16zm-7-8a1 1 0 011-1h3a1 1 0 110 2H4a1 1 0 01-1-1zm11 0a1 1 0 011-1h3a1 1 0 110 2h-3a1 1 0 01-1-1z" clip-rule=evenodd />
</svg>
Reset to Default Multipliers
</button>
</div>
</div>
<div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
<h3 class="text-xl font-bold text-gray-800 mb-4">Daily Overtime Entries</h3>
<div class="input-group mb-4">
<label for=allocationStrategy>Allocation Strategy
<span class=tooltip-container>
<svg xmlns=http://www.w3.org/2000/svg class="h-4 w-4 text-gray-400" fill=none viewBox="0 0 24 24" stroke=currentColor>
<path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
</svg>
<span class=tooltip-content>This is set automatically based on Target OT Pay.</span>
</span>
</label>
<select id=allocationStrategy class=shadow-sm aria-describedby=allocationStrategyDescription>
<option value=Target-Driven>Target-Driven (using Workload Presets)</option>
<option value=Workload-Driven>Workload-Driven (Fill All Days)</option>
</select>
<p id=allocationStrategyDescription class="text-sm text-gray-600 mt-2"></p>
</div>
<div id=workloadPresetGroup class="input-group mb-4">
<label for=workloadPreset>Workload Preset for Auto Allocation
<span class=tooltip-container>
<svg xmlns=http://www.w3.org/2000/svg class="h-4 w-4 text-gray-400" fill=none viewBox="0 0 24 24" stroke=currentColor>
<path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
</svg>
<span class=tooltip-content>Defines min/max hours for different day types.</span>
</span>
</label>
<select id=workloadPreset class=shadow-sm aria-describedby=workloadPresetDescription>
<option value="Moderate Workload">Moderate Workload</option>
<option value="Light Workload">Light Workload</option>
<option value="Heavy Workload">Heavy Workload</option>
</select>
<p id=workloadPresetDescription class="text-sm text-gray-600 mt-2"></p>
</div>
<div id=workloadPresetDetails class="text-sm text-gray-700 mb-4 p-3 bg-gray-100 rounded-md border border-gray-200">
</div>
<div class="flex flex-col sm:flex-row gap-4 mb-4">
<button id=autoAllocateBtn class="btn btn-secondary flex-grow" aria-label="Auto allocate hours">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor>
<path fill-rule=evenodd d="M10 18a8 8 0 100-16 8 8 0 000 16zm-7-8a1 1 0 011-1h3a1 1 0 110 2H4a1 1 0 01-1-1zm11 0a1 1 0 011-1h3a1 1 0 110 2h-3a1 1 0 01-1-1z" clip-rule=evenodd />
</svg>
Auto Allocate Hours
<span id=autoAllocateLoading class="loading-indicator hidden" aria-live=polite>Allocating...</span>
</button>
</div>
<div id=otEntriesContainer>
<p id=noEntriesMessage class="no-entries-message hidden">No OT entries yet. Click "Add OT Entry" or "Auto Allocate Hours" to get started!</p>
</div>
<div class="flex flex-col sm:flex-row gap-4 mt-4">
<button id=addOTEntryBtn class="btn btn-secondary flex-grow" aria-label="Add new OT entry">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor>
<path fill-rule=evenodd d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule=evenodd />
</svg>
Add OT Entry
</button>
<button id=clearAllEntriesBtn class="btn btn-danger flex-grow" aria-label="Clear all OT entries">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor>
<path fill-rule=evenodd d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule=evenodd />
</svg>
Clear All Entries
</button>
</div>
<div class="flex flex-col sm:flex-row gap-4 mt-4">
<button id=saveDataBtn class="btn btn-primary flex-grow" aria-label="Save current data">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor>
<path d="M7 3a1 1 0 00-1 1v1a1 1 0 001 1h6a1 1 0 001-1V4a1 1 0 00-1-1H7z"/>
<path fill-rule=evenodd d="M18 8H2a2 2 0 00-2 2v8a2 2 0 002 2h16a2 2 0 002-2v-8a2 2 0 00-2-2zM4 13a1 1 0 011-1h10a1 1 0 011 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-3z" clip-rule=evenodd />
</svg>
Save Data
<span id=saveDataStatus class=status-message aria-live=polite></span>
</button>
<button id=loadDataBtn class="btn btn-secondary flex-grow" aria-label="Load saved data">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor>
<path fill-rule=evenodd d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule=evenodd />
</svg>
Load Data
<span id=loadDataStatus class=status-message aria-live=polite></span>
</button>
</div>
</div>
<div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mt-6 flex items-center justify-between">
<label for=firebaseToggle class="text-xl font-bold text-gray-800 cursor-pointer">
Enable Firebase (Save/Load)
</label>
<label class=toggle-switch>
<input type=checkbox id=firebaseToggle>
<span class=slider></span>
</label>
</div>
<p id=firebaseStatusMessage class="text-sm text-gray-600 mt-2 text-center"></p>
<button id=resetAndReallocateBtn class="btn btn-danger w-full mt-4" aria-label="Reset all and re-allocate">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor>
<path fill-rule=evenodd d="M4 2a1 1 0 011 1v2.118a1 1 0 01-.293.707l-2.118 2.118A1 1 0 012 8v8a2 2 0 002 2h12a2 2 0 002-2V8a1 1 0 01-.293-.707l-2.118-2.118A1 1 0 0115 5.118V3a1 1 0 011-1h-2a1 1 0 01-1-1V1a1 1 0 10-2 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1V1a1 1 0 10-2 0v1a1 1 0 01-1 1H4zm2 5V4h8v3H6zm-2 4h12V9H4v2zm0 2h12v3H4v-3z" clip-rule=evenodd />
</svg>
Reset & Re-allocate All
</button>
</div>
<div class=summary-sidebar>
<div id=results class=results-section>
<h3 class="text-2xl font-bold text-gray-900 mb-4">Calculation Summary</h3>
<div class=summary-inline-group>
<strong>Total OT Hours by Type:</strong>
<span id=totalHoursByType class=text-gray-700></span>
</div>
<div class=summary-inline-group>
<strong>Total Pay per OT Category:</strong>
<span id=totalPayByCategory class=text-gray-700></span>
</div>
<p class="text-base font-bold text-gray-900 mt-2">Allocation Strategy: <span id=allocationStrategySummary class=text-gray-700></span></p>
<p class="text-xl font-bold text-gray-900 mt-6">Combined OT Pay: <span id=combinedOTPay class=text-indigo-600>RM 0.00</span></p>
<p class="text-xl font-bold text-gray-900 mt-2">Target OT Pay: <span id=targetOTPayDisplay class=text-green-600>RM 0.00</span></p>
<p class="text-xl font-bold mt-2">Difference from Target: <span id=differenceFromTarget>RM 0.00</span></p>
<p class="text-xl font-bold mt-2">Total Monthly OT Hours: <span id=totalMonthlyOTHoursDisplay>0.0 hours</span></p>
<p class="text-xl font-bold mt-2">Total OT Hours Range: <span id=totalOTHoursRangeDisplay>N/A</span></p>
<p class="text-xl font-bold text-gray-900 mt-2">Expected Salary Pay: <span id=expectedSalaryPayDisplay class=text-indigo-600>RM 0.00</span></p>
<h4 class="text-lg font-bold text-gray-800 mt-6 mb-2">OT Pay Distribution</h4>
<div class=chart-container>
<canvas id=otDistributionChart class="w-full h-full"></canvas>
<p id=chartPlaceholder class="chart-placeholder absolute hidden">No OT data to display. Add entries and calculate!</p>
</div>
<button id=exportSummaryBtn class="btn btn-secondary mt-6" aria-label="Export OT summary to text file">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor>
<path fill-rule=evenodd d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L10 11.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule=evenodd />
</svg>
Export Summary
</button>
</div>
</div>
</div>
<div id=messageBox class="message-box hidden" role=dialog aria-modal=true aria-labelledby=messageBoxTitle aria-describedby=messageBoxContent>
<h4 id=messageBoxTitle></h4>
<p id=messageBoxContent></p>
<div class=message-box-buttons>
<button id=messageBoxCancelBtn class="btn btn-cancel hidden">Cancel</button>
<button id=messageBoxConfirmBtn class=hidden>Confirm</button>
<button id=messageBoxCloseBtn>OK</button>
</div>
</div>
<div id=addDetailedOTEntryModal class="manual-entry-modal hidden" role=dialog aria-modal=true aria-labelledby=detailedEntryModalTitle>
<div class=manual-entry-modal-content>
<h4 id=detailedEntryModalTitle class="text-2xl font-bold text-gray-900 mb-4">Add Detailed OT Entry</h4>
<div class=input-group>
<label for=detailedEntryDate>Select Date</label>
<input type=date id=detailedEntryDate class=shadow-sm>
<div id=detailedEntryDateError class="error-message text-left"></div>
</div>
<div class=input-group>
<label for=detailedEntryHours>Hours</label>
<input type=number id=detailedEntryHours value=2.0 min=0.5 step=0.5 class=shadow-sm>
<div id=detailedEntryHoursError class="error-message text-left"></div>
</div>
<div class=input-group>
<label for=detailedEntryStartTime>Start Time</label>
<input type=time id=detailedEntryStartTime value=18:00 class=shadow-sm>
<div id=detailedEntryStartTimeError class="error-message text-left"></div>
</div>
<div class=input-group>
<label for=detailedEntryEndTime>End Time (Calculated)</label>
<input type=time id=detailedEntryEndTime class=shadow-sm readonly>
</div>
<div class=modal-buttons>
<button id=cancelDetailedEntryBtn class="btn btn-cancel">Cancel</button>
<button id=confirmDetailedEntryBtn class="btn btn-primary">Add Entry</button>
</div>
</div>
</div>
<div id=allocationChoiceModal class="manual-entry-modal hidden allocation-choice-modal" role=dialog aria-modal=true aria-labelledby=allocationChoiceModalTitle>
<div class=manual-entry-modal-content>
<h4 id=allocationChoiceModalTitle class="text-2xl font-bold text-gray-900 mb-4">Auto-Allocation Options</h4>
<p class="text-gray-700 mb-6">How would you like to allocate overtime hours?</p>
<div class=modal-buttons>
<button id=clearAndAllocateBtn class="btn btn-danger">
Auto Allocate
</button>
<button id=fillRemainingBtn class="btn btn-primary mt-4">
Fill Remaining Hours
</button>
<button id=cancelAllocationChoiceBtn class="btn btn-secondary mt-4">
Cancel
</button>
</div>
</div>
</div>
<div id=loadingOverlay class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[3000] hidden">
<div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-16 w-16"></div>
</div>
<div id=toastContainer></div>
<script type=module>import{initializeApp}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";import{getAuth,signInAnonymously,signInWithCustomToken,onAuthStateChanged}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";import{getFirestore,doc,getDoc,setDoc}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";const DEFAULT_OT_MULTIPLIERS={"Normal OT (Weekdays)":1.5,"Off Day (Saturday)":1.5,"Rest Day (Sunday) — 1st 8h":.5,"Rest Day (Sunday) — after 8h":2,"Public Holiday":2},PREDEFINED_TARGET_PAYS=[1e3,2e3,3e3,4e3,5e3],CONFIG={WORKING_DAYS_MONTHLY:26,STANDARD_WORK_HOURS_DAILY:8,MAX_DAILY_OT_HOURS:8,ALLOCATION_PRECISION:.01,OT_MULTIPLIERS:{...DEFAULT_OT_MULTIPLIERS},WORKLOAD_PRESETS:{"Light Workload":{"Normal OT (Weekdays)":{minHours:1,maxHours:5},"Off Day (Saturday)":{minHours:2,maxHours:5},"Rest Day (Sunday) — 1st 8h":{minHours:2,maxHours:6},"Rest Day (Sunday) — after 8h":{minHours:.5,maxHours:3}},"Moderate Workload":{"Normal OT (Weekdays)":{minHours:2,maxHours:7},"Off Day (Saturday)":{minHours:3,maxHours:8},"Rest Day (Sunday) — 1st 8h":{minHours:4,maxHours:8},"Rest Day (Sunday) — after 8h":{minHours:1,maxHours:6}},"Heavy Workload":{"Normal OT (Weekdays)":{minHours:3,maxHours:8},"Off Day (Saturday)":{minHours:5,maxHours:8},"Rest Day (Sunday) — 1st 8h":{minHours:6,maxHours:8},"Rest Day (Sunday) — after 8h":{minHours:3,maxHours:8}}},ALLOCATION_STEPS:[{type:"Normal OT (Weekdays)",days:[1,2,3,4,5]},{type:"Off Day (Saturday)",days:[6]},{type:"Rest Day (Sunday) — 1st 8h",days:[0]},{type:"Rest Day (Sunday) — after 8h",days:[0]}]};(async()=>{let e,t,a,n,s,o,i,r,l,d,c,u,m,y,f,g,h,p,v,T,L,E,O,I,D,S,x,w,b,H,C,F,N,R,P,M,$,A,_,B,k,U,G,W,Y,j,q,z,J,X,K,V,Z,Q,ee,te,ae,ne,se,oe,ie,re,le,de,ce,ue,me,ye,fe,ge,he,pe,ve,Te,Le,Ee,Oe,Ie,De,Se,xe,we,be,He,Ce,Fe,Ne,Re,Pe,Me,$e=!1,Ae=JSON.parse(localStorage.getItem("isFirebaseEnabled")||"true"),_e=[],Be=[],ke=0,Ue="Moderate Workload",Ge="Target-Driven";function We(e,t){let a;return function(...n){const s=this;clearTimeout(a),a=setTimeout((()=>e.apply(s,n)),t)}}async function Ye(){return new Promise((e=>setTimeout(e,0)))}function je(e,t,a="info",n=null){"info"!==a?(Q.textContent=e,ee.textContent=t,te.classList.add("hidden"),ae.classList.add("hidden"),ne.classList.add("hidden"),"confirm"===a?(ae.onclick=()=>{Z.classList.add("hidden"),Z.classList.remove("show"),n&&n(),window.lastFocusedElement&&window.lastFocusedElement.focus()},ne.onclick=()=>{Z.classList.add("hidden"),Z.classList.remove("show"),window.lastFocusedElement&&window.lastFocusedElement.focus()},ae.classList.remove("hidden"),ne.classList.remove("hidden")):(te.onclick=()=>{Z.classList.add("hidden"),Z.classList.remove("show"),window.lastFocusedElement&&window.lastFocusedElement.focus()},te.classList.remove("hidden")),Z.classList.remove("hidden"),Z.classList.add("show"),window.lastFocusedElement=document.activeElement,ae.focus()):qe(t,"info")}function qe(e,t="info"){const a=document.createElement("div");a.classList.add("toast",t),a.textContent=e,He.appendChild(a),a.offsetWidth,a.classList.add("show"),setTimeout((()=>{a.classList.remove("show"),a.addEventListener("transitionend",(()=>{a.remove()}),{once:!0})}),3e3)}function ze(){be.classList.remove("hidden"),be.style.opacity="0",be.offsetWidth,be.style.opacity="1"}function Je(){be.style.opacity="0",be.addEventListener("transitionend",(function e(){be.classList.add("hidden"),be.removeEventListener("transitionend",e)}),{once:!0})}function Xe(e,t,a){e.textContent=t,e.className=`status-message show ${a}`,e.setAttribute("aria-live","polite"),"loading"!==a&&setTimeout((()=>{e.classList.remove("show"),e.removeAttribute("aria-live")}),2e3)}function Ke(){"custom"===d.value?(c.classList.remove("hidden"),u.classList.remove("hidden"),c.focus()):(c.classList.add("hidden"),u.classList.add("hidden"),c.value=""),Tt(),ut()}function Ve(){if("custom"===d.value){const e=parseFloat(c.value);return isNaN(e)?null:e}return""===d.value?null:parseFloat(d.value)}function Ze(){const e=parseFloat(m.value),t=parseFloat(f.value);return{minHours:isNaN(e)?null:e,maxHours:isNaN(t)?null:t}}function Qe(){const e=parseFloat(m.value),t=parseFloat(f.value);return h.textContent="",m.classList.remove("input-error"),f.classList.remove("input-error"),!(!isNaN(e)&&!isNaN(t)&&e>t)||(h.textContent="Min hours cannot be greater than Max hours.",m.classList.add("input-error"),f.classList.add("input-error"),!1)}function et(e){return e<=0?0:e/CONFIG.WORKING_DAYS_MONTHLY/CONFIG.STANDARD_WORK_HOURS_DAILY}function tt(e,t,a,n){let s=CONFIG.OT_MULTIPLIERS[a];return Dt(n)&&"Public Holiday"!==a&&(s=CONFIG.OT_MULTIPLIERS["Public Holiday"]),void 0===s?(console.warn(`Unknown OT type or multiplier for type: ${a}`),0):e*s*t}function at(e){return`RM ${e.toFixed(2)}`}function nt(){const e=new Date;return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function st(e,t){if(!e)return"";const[a,n]=e.split(":").map(Number);let s=60*a+n+60*t,o=Math.floor(s/60)%24,i=Math.round(s%60);return 60===i&&(i=0,o=(o+1)%24),`${String(o).padStart(2,"0")}:${String(i).padStart(2,"0")}`}function ot(e,t=null){let a;a=t||function(e,t){const a=Math.floor(Math.random()*(t-e))+e,n=[0,15,30,45],s=n[Math.floor(Math.random()*n.length)];return`${String(a).padStart(2,"0")}:${String(s).padStart(2,"0")}`}(18,22),e.startTime=a,e.endTime=st(e.startTime,e.hours)}function it(){_e=[],F.innerHTML="",ke=0,N.classList.remove("hidden")}function rt(e){const t=new Date(e).getDay();return Dt(e)?"Public Holiday":0===t?"Rest Day (Sunday) — 1st 8h":6===t?"Off Day (Saturday)":"Normal OT (Weekdays)"}async function lt(){F.innerHTML="";const e=i.selectedDates,t=e[0]?new Date(e[0].toISOString().split("T")[0]):null,a=e[1]?new Date(e[1].toISOString().split("T")[0]):null;let n=_e;t&&a&&(n=_e.filter((e=>{const n=new Date(e.date);return n.setHours(0,0,0,0)>=t.setHours(0,0,0,0)&&n.setHours(0,0,0,0)<=a.setHours(0,0,0,0)}))),0===n.length?N.classList.remove("hidden"):N.classList.add("hidden");const s=n.map((e=>{let t;return t=Dt(e.date)?"Public Holiday":rt(e.date),{...e,displayType:t}})).reduce(((e,t)=>(e[t.displayType]||(e[t.displayType]=[]),e[t.displayType].push(t),e)),{}),o=["Normal OT (Weekdays)","Off Day (Saturday)","Rest Day (Sunday) — 1st 8h","Rest Day (Sunday) — after 8h","Public Holiday"];for(const e of o)if(s[e]&&s[e].length>0){const t=document.createElement("div");t.classList.add("ot-group-section");const a=document.createElement("h4");a.textContent=e,t.appendChild(a),s[e].sort(((e,t)=>new Date(e.date)-new Date(t.date)));for(const a of s[e])await new Promise((e=>requestAnimationFrame((()=>{const n=a.id,s=document.createElement("div");s.classList.add("ot-entry-row","flex","flex-col","gap-4"),s.setAttribute("data-id",n),a.isNew&&(s.classList.add("highlight-new"),setTimeout((()=>{s.classList.remove("highlight-new");const e=_e.findIndex((e=>e.id===n));-1!==e&&delete _e[e].isNew}),2e3));const o=Dt(a.date)?"Public Holiday":a.type;s.innerHTML=`\n                                    \x3c!-- Date and Hours (1st line) --\x3e\n                                    <div class="grid grid-cols-2 gap-4 items-end">\n                                        <div class="input-group">\n                                            <label for="${n}-date">Date${a.isNew?'<span class="new-badge">New</span>':""}</label>\n                                            <input type="date" id="${n}-date" value="${a.date}" class="shadow-sm">\n                                        </div>\n                                        <div class="input-group">\n                                            <label for="${n}-hours">Hours</label>\n                                            <input type="number" id="${n}-hours" value="${a.hours.toFixed(1)}" min="0" step="0.5" class="shadow-sm">\n                                            <div id="${n}-hours-error" class="error-message"></div>\n                                        </div>\n                                    </div>\n\n                                    \x3c!-- Start Time & End Time (2nd line) --\x3e\n                                    <div class="flex gap-4">\n                                        <div class="input-group flex-1">\n                                            <label for="${n}-start-time">Start Time</label>\n                                            <input type="time" id="${n}-start-time" value="${a.startTime}" class="shadow-sm"> \x3c!-- Removed readonly --\x3e\n                                            <div id="${n}-start-time-error" class="error-message"></div>\n                                        </div>\n                                        <div class="input-group flex-1">\n                                            <label for="${n}-end-time">End Time</label>\n                                            <input type="time" id="${n}-end-time" class="shadow-sm" readonly>\n                                        </div>\n                                    </div>\n\n                                    \x3c!-- OT Type and Remove Button (3rd line) --\x3e\n                                    <div class="grid grid-cols-[1.8fr_auto] gap-4 items-end"> \x3c!-- Adjusted grid for OT Type and Remove --\x3e\n                                        <div class="input-group">\n                                            <label for="${n}-type">OT Type</label>\n                                            <select id="${n}-type" class="shadow-sm">\n                                                ${Object.keys(DEFAULT_OT_MULTIPLIERS).map((e=>`\n                                                    <option value="${e}">${e}</option>\n                                                `)).join("")}\n                                            </select>\n                                        </div>\n                                        <div class="remove-btn-container flex justify-end">\n                                            <button type="button" class="btn btn-danger btn-sm remove-ot-entry-btn" data-id="${n}" aria-label="Remove OT entry for ${a.date}">\n                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">\n                                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />\n                                                </svg>\n                                            </button>\n                                        </div>\n                                    </div>\n                                `,t.appendChild(s);const r=s.querySelector(`#${n}-type`);r&&(r.value=o);const l=s.querySelector(`#${n}-end-time`);l&&(l.value=a.endTime);const d=s.querySelector(`#${n}-date`);if(d){const e=_e.filter((e=>e.id!==n)).map((e=>e.date));window.flatpickr(d,{dateFormat:"Y-m-d",minDate:i.selectedDates[0]?i.selectedDates[0]:null,maxDate:i.selectedDates[1]?i.selectedDates[1]:null,disable:e,onChange:function(e,t,a){dt(n,"date",t)}})}const c=s.querySelector(`#${n}-start-time`);c&&window.flatpickr(c,{enableTime:!0,noCalendar:!0,dateFormat:"H:i",time_24hr:!0,minuteIncrement:15,onChange:function(e,t,a){dt(n,"startTime",t)}});const u=s.querySelector(`#${n}-hours`),m=s.querySelector(`#${n}-hours-error`);u.addEventListener("input",(e=>{const t=parseFloat(e.target.value);isNaN(t)||t<0?(u.classList.add("input-error"),m.textContent="Hours must be a positive number."):t>CONFIG.MAX_DAILY_OT_HOURS?(u.classList.add("input-error"),m.textContent=`Max hours per day is ${CONFIG.MAX_DAILY_OT_HOURS}.`):(u.classList.remove("input-error"),m.textContent="",dt(n,"hours",t))})),s.querySelector(`#${n}-type`).addEventListener("change",(e=>{dt(n,"type",e.target.value)})),s.querySelector(".remove-ot-entry-btn").addEventListener("click",(()=>{return e=n,void je("Confirm Removal","Are you sure you want to remove this OT entry? This action cannot be undone.","confirm",(()=>{_e=_e.filter((t=>t.id!==e)),lt(),ut(),qe("Entry Removed","success")}));var e})),e()}))));F.appendChild(t)}}function dt(e,t,a){const n=_e.findIndex((t=>t.id===e));if(-1===n)return;const s={..._e[n]};if("date"===t){const t=a,o=i.selectedDates,r=o[0]?new Date(o[0].toISOString().split("T")[0]):null,l=o[0]?new Date(o[1].toISOString().split("T")[0]):null,d=new Date(t);if(r&&l&&(d.setHours(0,0,0,0)<r.setHours(0,0,0,0)||d.setHours(0,0,0,0)>l.setHours(0,0,0,0)))return qe(`Date ${t} is outside the current planning range (${r.toISOString().split("T")[0]} to ${l.toISOString().split("T")[0]}). Please choose a date within the range.`,"error"),void(document.querySelector(`#${e}-date`).value=s.date);if(_e.some((a=>a.id!==e&&a.date===t)))return je("Duplicate Date Warning",`An OT entry already exists for ${t}. Each date can only have one OT entry. Please choose a different date or adjust the existing entry.`,"info"),void(document.querySelector(`#${e}-date`).value=s.date);_e[n].date=t,_e[n].type=rt(t)}else if("hours"===t){const e=parseFloat(a);e<=0?(_e.splice(n,1),qe("Entry removed as hours were set to 0 or less.","info")):(_e[n].hours=e,_e[n].endTime=st(_e[n].startTime,_e[n].hours))}else"startTime"===t?(_e[n].startTime=a,_e[n].endTime=st(_e[n].startTime,_e[n].hours)):_e[n][t]=a;lt(),ut()}function ct(){je("Confirm Clear All","Are you sure you want to clear all daily OT entries? This action cannot be undone.","confirm",(()=>{it(),qe("All entries cleared!","success"),ut()}))}function ut(){const e=parseFloat(r.value),t=Ve(),a=Ze(),n=a.minHours,s=a.maxHours,o=i.selectedDates,l=o[0]?o[0].toISOString().split("T")[0]:"",d=o[1]?o[1].toISOString().split("T")[0]:"";if(isNaN(e)||e<=0)return U.innerHTML="",G.innerHTML="",W.textContent=at(0),q.textContent="0.0 hours",J.textContent=at(0),Y.textContent="N/A (No target set)",Y.classList.remove("text-green-600"),Y.classList.add("text-gray-600"),j.textContent="N/A (No target set)",j.classList.remove("text-green-600","text-red-600"),j.classList.add("text-gray-600"),V.textContent=Ge,z.textContent="N/A",z.classList.remove("text-green-600","text-red-600","text-orange-600"),z.classList.add("text-gray-600"),void mt([],[]);const c=et(e);let u={},m={},y=0,f=0;for(const e in CONFIG.OT_MULTIPLIERS)u[e]=0,m[e]=0;u["Public Holiday"]||(u["Public Holiday"]=0,m["Public Holiday"]=0),_e.forEach(((e,t)=>{const a=parseFloat(e.hours),n=e.type,s=e.date,o=new Date(s),i=new Date(l),r=new Date(d);if(l&&d&&(o.setHours(0,0,0,0)<i.setHours(0,0,0,0)||o.setHours(0,0,0,0)>r.setHours(0,0,0,0)))return;if(isNaN(a)||a<=0)return;const g=Dt(s)?"Public Holiday":n;if(void 0===(Dt(s)?CONFIG.OT_MULTIPLIERS["Public Holiday"]:CONFIG.OT_MULTIPLIERS[n]))return void console.warn(`Unknown OT type or multiplier for type: ${n} on date ${s}. Skipping entry.`);const h=tt(c,a,n,s);u[g]+=a,m[g]+=h,y+=h,f+=a}));const g=e+y;let h=[];const p=["Normal OT (Weekdays)","Off Day (Saturday)","Rest Day (Sunday) — 1st 8h","Rest Day (Sunday) — after 8h","Public Holiday"];p.forEach((e=>{u[e]>0&&h.push(`<span class="summary-inline-item">${e}: ${u[e].toFixed(1)}h</span>`)})),U.innerHTML=h.join("");let v=[],T=[],L=[];p.forEach((e=>{m[e]>0&&(v.push(`<span class="summary-inline-item">${e}: ${at(m[e])}</span>`),T.push(e),L.push(m[e]))})),G.innerHTML=v.join(""),mt(T,L,["#6366f1","#ef4444","#f59e0b","#10b981","#3b82f6"]),W.textContent=at(y),q.textContent=`${f.toFixed(1)} hours`,J.textContent=at(g),V.textContent=Ge;if(null===t||t<=0)Y.textContent="N/A (No target set)",Y.classList.remove("text-green-600"),Y.classList.add("text-gray-600"),j.textContent="N/A (No target set)",j.classList.remove("text-green-600","text-red-600"),j.classList.add("text-gray-600");else{Y.textContent=at(t),Y.classList.remove("text-gray-600"),Y.classList.add("text-green-600");const e=y-t;j.textContent=at(e),e>=0?(j.classList.remove("text-red-600","text-gray-600"),j.classList.add("text-green-600")):(j.classList.remove("text-green-600","text-gray-600"),j.classList.add("text-red-600"))}z.classList.remove("text-green-600","text-red-600","text-orange-600","text-gray-600"),null!==n&&null!==s?(z.textContent=`${n.toFixed(1)}h - ${s.toFixed(1)}h`,f>=n&&f<=s?z.classList.add("text-green-600"):f<n?z.classList.add("text-orange-600"):z.classList.add("text-red-600")):null!==n?(z.textContent=`Min: ${n.toFixed(1)}h`,f>=n?z.classList.add("text-green-600"):z.classList.add("text-orange-600")):null!==s?(z.textContent=`Max: ${s.toFixed(1)}h`,f<=s?z.classList.add("text-green-600"):z.classList.add("text-red-600")):(z.textContent="N/A",z.classList.add("text-gray-600"))}function mt(e,t,a){const n=document.getElementById("otDistributionChart").getContext("2d");0===t.length||t.every((e=>0===e))?(Ce&&(Ce.destroy(),Ce=null),Fe.classList.remove("hidden")):(Fe.classList.add("hidden"),Ce?(Ce.data.labels=e,Ce.data.datasets[0].data=t,Ce.data.datasets[0].backgroundColor=a,Ce.update()):Ce=new Chart(n,{type:"pie",data:{labels:e,datasets:[{label:"OT Pay (RM)",data:t,backgroundColor:a,hoverOffset:4}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"right",labels:{font:{family:"Inter"}}},tooltip:{callbacks:{label:function(e){let t=e.label||"";t&&(t+=": "),null!==e.parsed&&(t+=at(e.parsed))}},bodyFont:{family:"Inter"},titleFont:{family:"Inter"}}}}}))}function yt(e,t){const a=Math.ceil(2*e)/2,n=Math.floor(2*t)/2;if(a>n){const a=Math.round(2*e)/2;return a>=e&&a<=t?a:e}const s=[];for(let e=a;e<=n+CONFIG.ALLOCATION_PRECISION;e+=.5)s.push(parseFloat(e.toFixed(1)));if(0===s.length)return Math.round(2*e)/2;return s[Math.floor(Math.random()*s.length)]}function ft(e,t){return yt(e,t)}function gt(e,t,a){const n=_e.findIndex((t=>t.date===e)),s=parseFloat(t.toFixed(1));if(!(s<=CONFIG.ALLOCATION_PRECISION&&-1===n))if(-1!==n)_e[n].hours+=s,_e[n].endTime=st(_e[n].startTime,_e[n].hours);else{const t={id:"ot-entry-"+ke++,date:e,hours:s,type:a,startTime:"",endTime:"",isNew:!0};ot(t),_e.push(t)}}function ht(){_e.sort(((e,t)=>{const a=new Date(e.date)-new Date(t.date);return 0!==a?a:parseInt(e.id.split("-")[2])-parseInt(t.id.split("-")[2])}));const e={};_e.forEach((t=>{let a=e[t.date]||null;t.startTime&&t.endTime?t.endTime=st(t.startTime,t.hours):ot(t,a),e[t.date]=t.endTime}))}function pt(){Ue=w.value;const e=CONFIG.WORKLOAD_PRESETS[Ue];let t=`<strong>${Ue} Details:</strong><ul class="list-disc list-inside ml-4">`;["Normal OT (Weekdays)","Off Day (Saturday)","Rest Day (Sunday) — 1st 8h","Rest Day (Sunday) — after 8h"].forEach((a=>{const n=e[a];n&&(t+=`<li>${a}: ${n.minHours.toFixed(1)} - ${n.maxHours.toFixed(1)} hours</li>`)})),t+="</ul>",C.innerHTML=t,H.textContent="This preset suggests daily OT hours for different day types to guide auto-allocation."}function vt(){Ge=S.value,"Target-Driven"===Ge?(x.textContent='The calculator will try to allocate hours to reach your "Target OT Pay" with randomized daily hours.',b.classList.add("hidden"),C.classList.add("hidden")):"Workload-Driven"===Ge&&(x.textContent='Hours will be allocated for all days in your range according to the "Workload Preset", with randomized daily hours.',b.classList.remove("hidden"),C.classList.remove("hidden")),ut()}function Tt(){const e=Ve();null!==e&&e>0?("Target-Driven"!==S.value&&qe('Target Pay detected. Allocation strategy automatically set to "Target-Driven".',"info"),S.value="Target-Driven",S.disabled=!0):(S.value="Workload-Driven",S.disabled=!1),vt()}function Lt(e,t){e.style.maxHeight="none";const a=e.scrollHeight;e.style.maxHeight="0",e.classList.remove("collapsed"),e.offsetWidth,e.style.maxHeight=a+"px",t&&t.classList.add("rotated"),e.addEventListener("transitionend",(function t(){e.style.maxHeight="none",e.removeEventListener("transitionend",t)}),{once:!0})}function Et(){if(n){const e=i.selectedDates,t=Ft(e[0]),a=Ft(e[1]);n.set("minDate",t),n.set("maxDate",a),n.redraw()}}function Ot(){const e=L.value,t=i.selectedDates,a=t[0]?t[0].toISOString().split("T")[0]:"",n=t[1]?t[1].toISOString().split("T")[0]:"";if(!e)return void qe("Please select a date for the public holiday.","error");if(!a||!n||new Date(e)<new Date(a)||new Date(e)>new Date(n))return void qe(`Public Holiday date must be within the OT Planning Date Range (${a||"Not Set"} to ${n||"Not Set"}). Please set a valid date range first.`,"error");if(Be.includes(e))return void qe(`${e} is already in the public holidays list.`,"warning");Be.push(e),Be.sort(),It();const s=document.querySelector('.collapsible-header[data-target="publicHolidaysContent"]'),o=s?s.querySelector(".collapsible-icon"):null;Ee.classList.contains("collapsed")&&Lt(Ee,o),lt(),ut(),qe("Public Holiday added successfully!","success")}function It(){O.innerHTML="",0!==Be.length?Be.forEach((e=>{const t=document.createElement("li");t.classList.add("flex","justify-between","items-center","py-1"),t.innerHTML=`\n                        <span>${e}</span>\n                        <button type="button" class="text-red-500 hover:text-red-700 ml-4" data-date="${e}" aria-label="Remove public holiday ${e}">\n                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">\n                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />\n                            </svg>\n                        </button>\n                    `,O.appendChild(t),t.querySelector("button").addEventListener("click",(e=>{var t;je("Confirm Removal",`Are you sure you want to remove ${t=e.currentTarget.dataset.date} from public holidays?`,"confirm",(()=>{Be=Be.filter((e=>e!==t)),It(),lt(),ut(),qe("Holiday Removed","success")}))}))})):O.innerHTML='<li class="text-gray-500">No public holidays added yet.</li>'}function Dt(e){return Be.includes(e)}function St(){I.innerHTML="";["Normal OT (Weekdays)","Off Day (Saturday)","Rest Day (Sunday) — 1st 8h","Rest Day (Sunday) — after 8h","Public Holiday"].forEach((e=>{const t=document.createElement("div");t.classList.add("input-group"),t.innerHTML=`\n                        <label for="multiplier-${e.replace(/[^0-9A-Za-z]/g,"")}">${e} Multiplier</label>\n                        <input type="number" id="multiplier-${e.replace(/[^0-9A-Za-z]/g,"")}" value="${(CONFIG.OT_MULTIPLIERS[e]||0).toFixed(2)}" min="0" step="0.1" class="shadow-sm">\n                    `,I.appendChild(t),t.querySelector("input").addEventListener("input",We((t=>{const a=parseFloat(t.target.value);!isNaN(a)&&a>=0&&(CONFIG.OT_MULTIPLIERS[e]=a,ut())}),150))}))}function xt(){je("Confirm Reset Multipliers","Are you sure you want to reset all OT multipliers to their default values?","confirm",(()=>{Object.assign(CONFIG.OT_MULTIPLIERS,DEFAULT_OT_MULTIPLIERS),St(),qe("OT multipliers have been reset to their default values.","success"),ut()}))}async function wt(e){ze(),M.classList.remove("hidden"),M.setAttribute("aria-live","polite");try{const t=parseFloat(r.value),a=Ve(),n=Ze(),s=n.minHours,o=n.maxHours,l=i.selectedDates,d=l[0]?l[0].toISOString().split("T")[0]:"",c=l[1]?l[1].toISOString().split("T")[0]:"";if(isNaN(t)||t<=0||!d||!c||new Date(d)>new Date(c)||!Qe())return void qe("Please ensure all settings (Salary, Date Range, Hour Limits) are valid.","error");let u=0,m=0;const y={};if(e)it();else{const e=new Date(d),a=new Date(c);_e=_e.filter((t=>{const n=new Date(t.date);return n.setHours(0,0,0,0)>=e.setHours(0,0,0,0)&&n.setHours(0,0,0,0)<=a.setHours(0,0,0,0)})),_e.forEach((e=>{const a=parseFloat(e.hours);isNaN(a)||a<=0||(u+=tt(et(t),a,e.type,e.date),m+=a,y[e.date]=(y[e.date]||0)+a)}))}if(null!==o&&m>=o-CONFIG.ALLOCATION_PRECISION)return qe(`Max Total OT Hours (${o.toFixed(1)}h) already met.`,"warning"),void ut();const f=et(t),g=function(e,t){const a=[];let n=new Date(e);const s=new Date(t).getTime();for(;n.getTime()<=s;)a.push({date:n.toISOString().split("T")[0],dayOfWeek:n.getDay()}),n.setDate(n.getDate()+1);return a.sort((()=>Math.random()-.5)),a}(d,c),h=Ne.checked,p=Re.checked,v=Pe.checked,T=Me.checked;let L=g.filter((e=>{const t=Dt(e.date);if(y[e.date]>=CONFIG.MAX_DAILY_OT_HOURS)return!1;if(t&&T)return!0;if(!t){if(e.dayOfWeek>=1&&e.dayOfWeek<=5&&h)return!0;if(6===e.dayOfWeek&&p)return!0;if(0===e.dayOfWeek&&v)return!0}return!1}));if("Target-Driven"===Ge){if(!(null!==a&&a>0))return void qe("Please enter a valid Target OT Pay (> RM0) for Target-Driven allocation.","error");let e=a-u;if(e<=CONFIG.ALLOCATION_PRECISION)return qe("Target OT pay has already been met with existing entries.","info"),void ut();const t=[{name:"Standard 1.5x",types:["Normal OT (Weekdays)","Off Day (Saturday)"]},{name:"Public Holiday 2.0x",types:["Public Holiday"]},{name:"Rest Day 0.5x",types:["Rest Day (Sunday) — 1st 8h"]},{name:"Rest Day 2.0x",types:["Rest Day (Sunday) — after 8h"]}];let n=0;const s=20*L.length;for(;e>CONFIG.ALLOCATION_PRECISION&&n<s&&L.length>0;){n++;let s=[];if(t.forEach((e=>{L.forEach((t=>{const a=rt(t.date);e.types.includes(a)?s.push({date:t.date,type:a}):"Rest Day (Sunday) — 1st 8h"===a&&e.types.includes("Rest Day (Sunday) — after 8h")&&s.push({date:t.date,type:"Rest Day (Sunday) — after 8h"})}))})),0===s.length)break;const i=Math.floor(Math.random()*s.length),r=s[i],l=y[r.date]||0,d=CONFIG.MAX_DAILY_OT_HOURS-l;if(d<=0){L=L.filter((e=>e.date!==r.date));continue}let c=ft(.5,Math.min(d,4));Math.random()>.6&&(c=ft(2,d));let g=r.type;if(Dt(r.date)&&(g="Public Holiday"),"Rest Day (Sunday) — 1st 8h"===g&&l>=8)continue;if("Rest Day (Sunday) — after 8h"===g&&l<8)continue;"Rest Day (Sunday) — 1st 8h"===g&&(c=Math.min(c,8-l));let h=tt(f,c,g,r.date);for(;h>e&&c>.5;)c-=.5,h=tt(f,c,g,r.date);if(c<=0)continue;let p=c;if(null!==o&&(p=Math.min(p,o-m)),p<=0)continue;gt(r.date,p,g);const v=tt(f,p,g,r.date);u+=v,m+=p,y[r.date]=(y[r.date]||0)+p,e=a-u,y[r.date]>=CONFIG.MAX_DAILY_OT_HOURS&&(L=L.filter((e=>e.date!==r.date))),await Ye()}u<a-CONFIG.ALLOCATION_PRECISION?qe(`Target was not fully met (${at(u)}). All available slots are maxed out.`,"warning"):qe("Overtime hours allocated to meet your target. Please review.","success")}else if("Workload-Driven"===Ge){let e=JSON.parse(JSON.stringify(CONFIG.ALLOCATION_STEPS));e.forEach((e=>{const t=CONFIG.WORKLOAD_PRESETS[Ue][e.type];t&&Object.assign(e,t)}));const t=L.filter((e=>(y[e.date]||0)<CONFIG.MAX_DAILY_OT_HOURS)),a=new Map;for(const n of t){if(null!==o&&m>=o-CONFIG.ALLOCATION_PRECISION){qe(`Max Total OT Hours (${o.toFixed(1)}h) reached.`,"info");break}let t=CONFIG.MAX_DAILY_OT_HOURS-(y[n.date]||0);const s=e.filter((e=>e.days.includes(n.dayOfWeek)));for(const e of s){if(t<=0||null!==o&&m>=o-CONFIG.ALLOCATION_PRECISION)break;let s=0,i=e.maxHours,r=e.type;if(Dt(n.date)&&(r="Public Holiday"),"Rest Day (Sunday) — 1st 8h"===r){const t=a.get(n.date)||0;i=Math.min(e.maxHours,8-t)}else if("Rest Day (Sunday) — after 8h"===r&&(y[n.date]||0)<8)continue;e.minHours>i||(s=yt(e.minHours,i),s=Math.min(s,t),null!==o&&(s=Math.min(s,o-m)),s>CONFIG.ALLOCATION_PRECISION&&(gt(n.date,s,r),m+=s,y[n.date]=(y[n.date]||0)+s,"Rest Day (Sunday) — 1st 8h"===r&&a.set(n.date,(a.get(n.date)||0)+s),t-=s))}await Ye()}qe("Overtime hours have been allocated based on the workload preset.","success"),null!==s&&m<s-CONFIG.ALLOCATION_PRECISION&&qe(`Allocation finished, but did not reach the Min Total OT Hours of ${s.toFixed(1)}h.`,"warning")}ht(),_e.forEach((e=>delete e.isNew)),await lt(),ut()}catch(e){console.error("Error during auto-allocation:",e),qe("An error occurred during auto-allocation. Please check console.","error")}finally{Je(),M.classList.add("hidden"),M.removeAttribute("aria-live")}}function bt(){try{const e=parseFloat(r.value),t=Ve(),a=Ze(),n=a.minHours,s=a.maxHours,o=i.selectedDates,l=o[0]?o[0].toISOString().split("T")[0]:"",d=o[1]?o[1].toISOString().split("T")[0]:"",c=et(e);let u="--- OT Calculation Summary ---\n\n";u+="Employee Settings:\n",u+=`  Basic Monthly Salary: ${at(e)}\n`,u+=`  Hourly Rate: RM ${c.toFixed(2)}/hour\n\n`,u+=`OT Planning Period: ${l} to ${d}\n`,u+=`Allocation Strategy: ${Ge}\n`,u+=`Target OT Pay: ${null===t?"N/A":at(t)}\n`,u+=`Total OT Hours Range: ${null!==n&&null!==s?`${n.toFixed(1)}h - ${s.toFixed(1)}h`:null!==n?`Min: ${n.toFixed(1)}h`:null!==s?`Max: ${s.toFixed(1)}h`:"N/A"}\n\n`,u+="OT Multipliers Used:\n";for(const e in CONFIG.OT_MULTIPLIERS)u+=`  ${e}: ${CONFIG.OT_MULTIPLIERS[e].toFixed(2)}x\n`;u+="\n";const m={},y=["Normal OT (Weekdays)","Off Day (Saturday)","Rest Day (Sunday) — 1st 8h","Rest Day (Sunday) — after 8h","Public Holiday"],f=new Date(l),g=new Date(d),h=_e.filter((e=>{const t=new Date(e.date);return t.setHours(0,0,0,0)>=f.setHours(0,0,0,0)&&t.setHours(0,0,0,0)<=g.setHours(0,0,0,0)}));h.forEach((e=>{const t=Dt(e.date)?"Public Holiday":e.type;m[t]||(m[t]=[]),m[t].push(e)})),u+="Daily OT Entries:\n",0===h.length?u+="  No entries recorded for the selected range.\n":y.forEach((e=>{m[e]&&m[e].length>0&&(u+=`\n--- ${e} ---\n`,m[e].sort(((e,t)=>new Date(e.date)-new Date(t.date))),m[e].forEach((e=>{u+=`  Date: ${e.date}, Hours: ${e.hours.toFixed(1)}h, Type: ${e.type}`,Dt(e.date)&&(u+=" (Public Holiday)"),e.startTime&&e.endTime&&(u+=`, Time: ${e.startTime} - ${e.endTime}`),u+="\n"})))})),u+="\n";let p={},v={},T=0,L=0;for(const e in CONFIG.OT_MULTIPLIERS)p[e]=0,v[e]=0;p["Public Holiday"]||(p["Public Holiday"]=0,v["Public Holiday"]=0),h.forEach((e=>{const t=parseFloat(e.hours),a=e.type,n=e.date;if(isNaN(t)||t<=0)return;const s=Dt(n)?"Public Holiday":e.type;if(void 0===(Dt(n)?CONFIG.OT_MULTIPLIERS["Public Holiday"]:CONFIG.OT_MULTIPLIERS[a]))return;const o=tt(c,t,a,n);p[s]+=t,v[s]+=o,T+=o,L+=t}));const E=e+T;u+="Total OT Hours by Type:\n";let O=[];const I=["Normal OT (Weekdays)","Off Day (Saturday)","Rest Day (Sunday) — 1st 8h","Rest Day (Sunday) — after 8h","Public Holiday"];I.forEach((e=>{p[e]>0&&O.push(`${e}: ${p[e].toFixed(1)}h`)})),u+=`  ${O.join(", ")}\n`,u+="\n",u+="Total Pay per OT Category:\n";let D=[];I.forEach((e=>{v[e]>0&&(v[e]=parseFloat(v[e].toFixed(2)),D.push(`${e}: ${at(v[e])}`))})),u+=`  ${D.join(", ")}\n`,u+="\n",u+=`Combined OT Pay: ${at(T)}\n`;const S=T-(null===t?0:t);u+=`Difference from Target: ${null===t?"N/A (No target set)":at(S)}\n`,u+=`Total Monthly OT Hours: ${L.toFixed(1)} hours\n`,u+=`Expected Salary Pay (Calculated): ${at(E)}\n`,u+="\n--- End of Summary ---";const x=new Blob([u],{type:"text/plain;charset=utf-8"}),w=URL.createObjectURL(x),b=document.createElement("a");b.href=w,b.download="ot_summary.txt",document.body.appendChild(b),b.click(),qe("Your OT summary is being downloaded.","info"),setTimeout((()=>{document.body.removeChild(b),URL.revokeObjectURL(w)}),250)}catch(e){console.error("Error during export summary:",e),qe("Failed to export summary. Please check your browser console for details.","error")}}async function Ht(){if(Ae)if($e&&a){ze(),Xe(De,"Saving...","loading");try{const t="undefined"!=typeof __app_id?__app_id:"default-app-id",n=doc(e,`artifacts/${t}/users/${a}/ot_calculator_data`,"user_data"),s=_e.map((e=>{const t={...e};return delete t.isNew,t})),o=Ze(),l={basicSalary:parseFloat(r.value),targetOTPay:Ve(),minTotalOTHours:o.minHours,maxTotalOTHours:o.maxHours,startDate:i.selectedDates[0]?i.selectedDates[0].toISOString().split("T")[0]:"",endDate:i.selectedDates[1]?i.selectedDates[1].toISOString().split("T")[0]:"",workloadPreset:w.value,allocationStrategy:S.value,otEntries:JSON.stringify(s),publicHolidays:JSON.stringify(Be),customMultipliers:JSON.stringify(CONFIG.OT_MULTIPLIERS),allocateWorkingDay:Ne.checked,allocateOffDay:Re.checked,allocateRestDay:Pe.checked,allocatePublicHoliday:Me.checked};await setDoc(n,l),_e=s,lt(),Xe(De,"Saved!","success"),qe("Data saved successfully!","success")}catch(e){console.error("Error saving document: ",e),Xe(De,"Save Failed!","error"),qe("Failed to save data. Please try again.","error")}finally{Je()}}else qe("Firebase authentication not ready. Please try again in a moment.","error");else qe("Firebase functions (Save/Load) are currently disabled. Please enable them to use this feature.","warning")}async function Ct(t=!0){if(Ae)if($e&&a){t&&(ze(),Xe(Se,"Loading...","loading"));try{const n="undefined"!=typeof __app_id?__app_id:"default-app-id",s=doc(e,`artifacts/${n}/users/${a}/ot_calculator_data`,"user_data"),o=await getDoc(s);if(o.exists()){const e=o.data();r.value=parseFloat(e.basicSalary);const a=e.targetOTPay;if(null===a?(d.value="",c.classList.add("hidden"),u.classList.add("hidden"),c.value=""):PREDEFINED_TARGET_PAYS.includes(a)?(d.value=a.toFixed(2),c.classList.add("hidden"),u.classList.add("hidden"),c.value=""):(d.value="custom",c.classList.remove("hidden"),u.classList.remove("hidden"),c.value=a.toFixed(2)),m.value=null!==e.minTotalOTHours?e.minTotalOTHours:"",f.value=null!==e.maxTotalOTHours?e.maxTotalOTHours:"",e.startDate&&e.endDate?i.setDate([e.startDate,e.endDate],!0):i.clear(),w.value=e.workloadPreset||"Moderate Workload",S.value=e.allocationStrategy||"Target-Driven",_e=JSON.parse(e.otEntries||"[]"),Be=JSON.parse(e.publicHolidays||"[]"),Object.assign(CONFIG.OT_MULTIPLIERS,JSON.parse(e.customMultipliers||"{}")),Object.assign(CONFIG.OT_MULTIPLIERS,{...DEFAULT_OT_MULTIPLIERS,...CONFIG.OT_MULTIPLIERS}),Ne.checked=void 0===e.allocateWorkingDay||e.allocateWorkingDay,Re.checked=void 0===e.allocateOffDay||e.allocateOffDay,Pe.checked=void 0===e.allocateRestDay||e.allocateRestDay,Me.checked=void 0===e.allocatePublicHoliday||e.allocatePublicHoliday,ke=_e.length>0?Math.max(..._e.map((e=>parseInt(e.id.split("-")[2]))))+1:0,ht(),await lt(),It(),Be.length>0){const e=document.querySelector('.collapsible-header[data-target="publicHolidaysContent"]'),t=e?e.querySelector(".collapsible-icon"):null;Lt(Ee,t)}St(),ut(),t&&(Xe(Se,"Loaded!","success"),qe("Data loaded successfully!","success"))}else{const e=new Date,a=new Date(e.getFullYear(),e.getMonth(),1),n=new Date(e.getFullYear(),e.getMonth()+1,0);i.setDate([a,n],!0),r.value="3700.00",w.value="Moderate Workload",S.value="Target-Driven",d.value="",c.classList.add("hidden"),u.classList.add("hidden"),m.value="",f.value="",Ne.checked=!0,Re.checked=!0,Pe.checked=!0,Me.checked=!0,It(),St(),await lt(),ut(),t&&Xe(Se,"No saved data found.","info")}}catch(e){console.error("Error loading document: ",e),t&&(Xe(Se,"Load Failed!","error"),qe("Failed to load data. Please try again.","error"))}finally{pt(),vt(),Tt(),Je()}}else t&&qe("Firebase authentication not ready. Please try again in a moment.","error");else t&&qe("Firebase functions (Save/Load) are currently disabled. Please enable them to use this feature.","warning")}function Ft(e){if(!e)return"";return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function Nt(){const e=i.selectedDates,t=Ft(e[0]),a=Ft(e[1]);if(!t||!a||new Date(t)>new Date(a))return void qe('Please set a valid "OT Planning Date Range" before adding a manual entry.',"error");re.textContent="",de.textContent="",ue.textContent="",ie.classList.remove("input-error"),le.classList.remove("input-error"),ce.classList.remove("input-error");const n=[];let r=new Date(t);const l=new Date(a);for(;r.getTime()<=l.getTime();)n.push(Ft(r)),r.setDate(r.getDate()+1);const d=n.filter((e=>!_e.some((t=>t.date===e))));let c=null;c=d.length>0?d[0]:t||nt(),c?(s?(s.set("minDate",t),s.set("maxDate",a),s.set("disable",_e.map((e=>e.date))),s.setDate(c),s.redraw()):s=window.flatpickr(ie,{dateFormat:"Y-m-d",minDate:t,maxDate:a,disable:_e.map((e=>e.date)),defaultDate:c,onChange:function(e,t,a){re.textContent="",ie.classList.remove("input-error");const n=e[0];if(n){const e=i.selectedDates,t=e[0]?new Date(e[0].toISOString().split("T")[0]):null,s=e[1]?new Date(e[1].toISOString().split("T")[0]):null;t&&s&&(n.setHours(0,0,0,0)<t.setHours(0,0,0,0)||n.setHours(0,0,0,0)>s.setHours(0,0,0,0))&&(re.textContent=`Date must be within ${Ft(t)} and ${Ft(s)}.`,ie.classList.add("input-error"),a.clear(),ie.value="",qe("Selected date is outside the planning range and has been cleared.","error"))}}}),ie.value=c||"",o?o.setDate("18:00",!1):o=window.flatpickr(ce,{enableTime:!0,noCalendar:!0,dateFormat:"H:i",time_24hr:!0,defaultHour:18,defaultMinute:0,minuteIncrement:15,onChange:function(e,t,a){ue.textContent="",ce.classList.remove("input-error"),Pt()}}),le.value="2.0",Pt(),se.classList.remove("hidden"),se.classList.add("show"),window.lastFocusedElement=document.activeElement,ie.focus()):qe("No available dates within the planning range to add an entry. Please adjust your date range or clear existing entries.","info")}function Rt(){se.classList.add("hidden"),se.classList.remove("show"),window.lastFocusedElement&&window.lastFocusedElement.focus()}function Pt(){const e=ce.value,t=parseFloat(le.value);e&&!isNaN(t)&&t>0?me.value=st(e,t):me.value=""}function Mt(){const e=ie.value,t=parseFloat(le.value),a=ce.value,n=me.value;re.textContent="",de.textContent="",ue.textContent="",ie.classList.remove("input-error"),le.classList.remove("input-error"),ce.classList.remove("input-error");let s=!0;e||(re.textContent="Please select a date.",ie.classList.add("input-error"),s=!1),isNaN(t)||t<=0?(de.textContent="Hours must be a positive number.",le.classList.add("input-error"),s=!1):t>CONFIG.MAX_DAILY_OT_HOURS&&(de.textContent=`Max hours per day is ${CONFIG.MAX_DAILY_OT_HOURS}.`,le.classList.add("input-error"),s=!1),a||(ue.textContent="Please set a start time.",ce.classList.add("input-error"),s=!1);const o=i.selectedDates,r=Ft(o[0]),l=Ft(o[1]),d=new Date(e).setHours(0,0,0,0),c=new Date(r).setHours(0,0,0,0),u=new Date(l).setHours(0,0,0,0);(d<c||d>u)&&(re.textContent=`Date must be within ${r} and ${l}.`,ie.classList.add("input-error"),s=!1);_e.some((t=>t.date===e))&&(re.textContent=`An OT entry already exists for ${e}. Each date can only have one OT entry.`,ie.classList.add("input-error"),s=!1),s&&(!function(e,t,a,n){const s={id:"ot-entry-"+ke++,date:e,hours:t,type:rt(e),startTime:a,endTime:n,isNew:!0};_e.push(s),lt(),ut(),setTimeout((()=>{const e=F.querySelector(`[data-id="${s.id}"]`);e&&e.scrollIntoView({behavior:"smooth",block:"center"})}),100)}(e,t,a,n),Rt(),qe(`New OT entry added for ${e} (${t}h, ${a}-${n}).`,"success"))}function $t(){ge.classList.remove("hidden"),ge.classList.add("show"),window.lastFocusedElement=document.activeElement,he.focus()}function At(){ge.classList.add("hidden"),ge.classList.remove("show"),window.lastFocusedElement&&window.lastFocusedElement.focus()}async function _t(){if(!Ae)return we.textContent="Firebase (Save/Load) is currently disabled.",void K.classList.add("hidden");we.textContent="Initializing Firebase...";try{const n="undefined"!=typeof __firebase_config?__firebase_config:"{}",s=JSON.parse(n);if(0===Object.keys(s).length)throw new Error("Firebase configuration is empty or invalid. Please ensure __firebase_config is set correctly.");const o=initializeApp(s);e=getFirestore(o),t=getAuth(o),onAuthStateChanged(t,(async e=>{if(e)a=e.uid,$e=!0,K.textContent=`User ID: ${a}`,K.classList.remove("hidden"),we.textContent="Firebase enabled and connected.",await Ct(!1);else try{const e=await signInAnonymously(t);a=e.user.uid,$e=!0,K.textContent=`User ID: ${a}`,K.classList.remove("hidden"),we.textContent="Firebase enabled and connected (anonymous).",await Ct(!1)}catch(e){console.error("Anonymous sign-in failed:",e),we.textContent="Firebase connection failed. Check console.",qe("Failed to sign in. This is often due to a network issue or a problem with your Firebase project setup. Please check your internet connection and ensure your Firebase project is correctly configured. Data saving/loading may not work.","error")}Bt()}))}catch(e){console.error("Firebase initialization failed:",e),we.textContent=`Firebase init failed: ${e.message}.`,qe(`Firebase could not be initialized: ${e.message||"Unknown error"}. Data saving/loading will not work. Please ensure your Firebase configuration is valid.`,"error"),Ae=!1,xe.checked=!1,localStorage.setItem("isFirebaseEnabled","false"),Bt(),K.classList.add("hidden")}}function Bt(){_.disabled=!Ae||!$e,B.disabled=!Ae||!$e}async function kt(){Ae=xe.checked,localStorage.setItem("isFirebaseEnabled",Ae),Ae?await _t():(e=null,t=null,a=null,$e=!1,K.classList.add("hidden"),we.textContent="Firebase (Save/Load) is now disabled."),Bt()}document.addEventListener("DOMContentLoaded",(async()=>{r=document.getElementById("basicSalary"),l=r.nextElementSibling,d=document.getElementById("targetOTPaySelect"),c=document.getElementById("customTargetOTPayInput"),u=document.getElementById("clearCustomTargetOTPayBtn"),m=document.getElementById("minTotalOTHours"),y=document.getElementById("clearMinTotalOTHoursBtn"),f=document.getElementById("maxTotalOTHours"),g=document.getElementById("clearMaxTotalOTHoursBtn"),h=document.getElementById("minMaxHoursError"),p=document.getElementById("dateRangeInput"),v=document.getElementById("dateRangeError"),T=document.getElementById("setThisMonthBtn"),L=document.getElementById("publicHolidayDate"),E=document.getElementById("addPublicHolidayDateBtn"),O=document.getElementById("publicHolidaysList"),I=document.getElementById("otMultiplierInputs"),D=document.getElementById("resetMultipliersBtn"),S=document.getElementById("allocationStrategy"),x=document.getElementById("allocationStrategyDescription"),w=document.getElementById("workloadPreset"),b=document.getElementById("workloadPresetGroup"),H=document.getElementById("workloadPresetDescription"),C=document.getElementById("workloadPresetDetails"),F=document.getElementById("otEntriesContainer"),N=document.getElementById("noEntriesMessage"),R=document.getElementById("addOTEntryBtn"),P=document.getElementById("autoAllocateBtn"),M=document.getElementById("autoAllocateLoading"),$=document.getElementById("resetAndReallocateBtn"),A=document.getElementById("clearAllEntriesBtn"),_=document.getElementById("saveDataBtn"),B=document.getElementById("loadDataBtn"),k=document.getElementById("results"),U=document.getElementById("totalHoursByType"),G=document.getElementById("totalPayByCategory"),W=document.getElementById("combinedOTPay"),Y=document.getElementById("targetOTPayDisplay"),j=document.getElementById("differenceFromTarget"),q=document.getElementById("totalMonthlyOTHoursDisplay"),z=document.getElementById("totalOTHoursRangeDisplay"),J=document.getElementById("expectedSalaryPayDisplay"),X=document.getElementById("exportSummaryBtn"),K=document.getElementById("userIdDisplay"),V=document.getElementById("allocationStrategySummary"),Z=document.getElementById("messageBox"),Q=document.getElementById("messageBoxTitle"),ee=document.getElementById("messageBoxContent"),te=document.getElementById("messageBoxCloseBtn"),ae=document.getElementById("messageBoxConfirmBtn"),ne=document.getElementById("messageBoxCancelBtn"),se=document.getElementById("addDetailedOTEntryModal"),oe=document.getElementById("detailedEntryModalTitle"),ie=document.getElementById("detailedEntryDate"),re=document.getElementById("detailedEntryDateError"),le=document.getElementById("detailedEntryHours"),de=document.getElementById("detailedEntryHoursError"),ce=document.getElementById("detailedEntryStartTime"),ue=document.getElementById("detailedEntryStartTimeError"),me=document.getElementById("detailedEntryEndTime"),ye=document.getElementById("confirmDetailedEntryBtn"),fe=document.getElementById("cancelDetailedEntryBtn"),ge=document.getElementById("allocationChoiceModal"),he=document.getElementById("clearAndAllocateBtn"),pe=document.getElementById("fillRemainingBtn"),ve=document.getElementById("cancelAllocationChoiceBtn"),Te=document.getElementById("setPublicHolidayTodayBtn"),Le=document.querySelectorAll(".collapsible-header"),Ee=document.getElementById("publicHolidaysContent"),Oe=document.getElementById("otMultiplierContent"),Ie=document.getElementById("howToUseContent"),De=document.getElementById("saveDataStatus"),Se=document.getElementById("loadDataStatus"),xe=document.getElementById("firebaseToggle"),we=document.getElementById("firebaseStatusMessage"),be=document.getElementById("loadingOverlay"),He=document.getElementById("toastContainer"),Fe=document.getElementById("chartPlaceholder"),Ne=document.getElementById("allocateWorkingDay"),Re=document.getElementById("allocateOffDay"),Pe=document.getElementById("allocateRestDay"),Me=document.getElementById("allocatePublicHoliday"),xe.checked=Ae,Ae?await _t():(we.textContent="Firebase (Save/Load) is currently disabled.",K.classList.add("hidden")),Bt(),r.addEventListener("input",We(ut,150)),c.addEventListener("input",We((()=>{Tt(),ut()}),150)),m.addEventListener("input",We((()=>{Qe(),ut()}),150)),f.addEventListener("input",We((()=>{Qe(),ut()}),150)),i=window.flatpickr(p,{mode:"range",dateFormat:"Y-m-d",onChange:function(e,t,a){ut(),function(){if(s){const e=i.selectedDates,t=Ft(e[0]),a=Ft(e[1]);let n=null;const o=[];if(t&&a){let e=new Date(t);const n=new Date(a);for(;e.getTime()<=n.getTime();)o.push(Ft(e)),e.setDate(e.getDate()+1)}const r=o.filter((e=>!_e.some((t=>t.date===e))));n=r.length>0?r[0]:t||nt(),s.set("minDate",t),s.set("maxDate",a),s.set("disable",_e.map((e=>e.date))),s.setDate(n),s.redraw(),ie.value=n||""}}(),Et(),v.textContent="",p.classList.remove("input-error")}});const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),1),a=new Date(e.getFullYear(),e.getMonth()+1,0);i.setDate([t,a],!0),T.addEventListener("click",(()=>{const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),1),a=new Date(e.getFullYear(),e.getMonth()+1,0);i.setDate([t,a],!0),qe("Date range set to current month.","info")})),P.addEventListener("click",$t),he.addEventListener("click",(()=>{At(),wt(!0)})),pe.addEventListener("click",(()=>{At(),wt(!1)})),ve.addEventListener("click",At),$.addEventListener("click",(()=>{je("Confirm Reset & Re-allocate","Are you sure you want to clear ALL existing OT entries and re-allocate from scratch? This action cannot be undone.","confirm",(()=>wt(!0)))})),A.addEventListener("click",ct),X.addEventListener("click",bt),_.addEventListener("click",Ht),B.addEventListener("click",(()=>Ct(!0))),w.addEventListener("change",pt),S.addEventListener("change",Tt),E.addEventListener("click",Ot),D.addEventListener("click",xt),d.addEventListener("change",Ke),l.addEventListener("click",(()=>{r.value="",ut(),qe("Basic Salary cleared.","info")})),u.addEventListener("click",(()=>{c.value="",Tt(),ut(),qe("Custom Target OT Pay cleared.","info")})),y.addEventListener("click",(()=>{m.value="",Qe(),ut(),qe("Min Total OT Hours cleared.","info")})),g.addEventListener("click",(()=>{f.value="",Qe(),ut(),qe("Max Total OT Hours cleared.","info")})),Te.addEventListener("click",(()=>{L.value=nt(),n&&n.setDate(L.value,!0),qe("Public Holiday date set to today.","info")})),Le.forEach((e=>{e.addEventListener("click",(()=>{const t=e.dataset.target,a=document.getElementById(t),n=e.querySelector(".collapsible-icon");var s,o;a.classList.contains("collapsed")?Lt(a,n):(o=n,(s=a).style.maxHeight=s.scrollHeight+"px",s.offsetWidth,s.classList.add("collapsed"),o&&o.classList.remove("rotated"),s.addEventListener("transitionend",(function e(){s.classList.contains("collapsed")&&(s.style.maxHeight="0"),s.removeEventListener("transitionend",e)}),{once:!0}))}))})),R.addEventListener("click",Nt),ye.addEventListener("click",Mt),fe.addEventListener("click",Rt),le.addEventListener("input",Pt),ce.addEventListener("input",Pt),xe.addEventListener("change",kt),Ne.addEventListener("change",ut),Re.addEventListener("change",ut),Pe.addEventListener("change",ut),Me.addEventListener("change",ut),function(){d.innerHTML='<option value="">No Target</option>',PREDEFINED_TARGET_PAYS.forEach((e=>{const t=document.createElement("option");t.value=e.toFixed(2),t.textContent=`RM ${e.toFixed(2)}`,d.appendChild(t)}));const e=document.createElement("option");e.value="custom",e.textContent="Other (Enter Manually)",d.appendChild(e)}(),St(),n=window.flatpickr(L,{dateFormat:"Y-m-d"}),Ie.classList.add("collapsed"),Ee.classList.add("collapsed"),Oe.classList.add("collapsed"),vt(),pt(),Et(),Tt()}))})()</script>
</body>
</html>
