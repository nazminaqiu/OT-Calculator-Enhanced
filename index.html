<!doctype html>
<html lang=en>
<head>
<meta charset=UTF-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>Enhanced OT Calculator</title>
<script src=https://cdn.tailwindcss.com></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css>
<script src=https://cdn.jsdelivr.net/npm/flatpickr></script>
<script src=https://cdn.jsdelivr.net/npm/chart.js></script>
<style>:root{--primary-indigo:#6366f1;--dark-indigo:#4f46e5;--light-indigo:#e0e7ff;--lightest-indigo:#c7d2fe;--danger-red:#ef4444;--dark-red:#dc2626;--success-green:#10b981;--info-blue:#3b82f6;--warning-orange:#f59e0b;--gray-900:#1f2937;--gray-800:#374151;--gray-700:#4b5563;--gray-600:#6b7280;--gray-500:#9ca3af;--gray-400:#d1d5db;--gray-300:#e5e7eb;--gray-200:#f3f4f6;--gray-100:#f9fafb;--gray-50:#f9fafb}body{font-family:Inter,sans-serif;background-color:var(--gray-200);display:flex;justify-content:center;align-items:flex-start;min-height:100vh;padding:20px;box-sizing:border-box}.main-wrapper{display:flex;flex-direction:column;gap:25px;max-width:1200px;width:100%}@media (min-width:1024px){.main-wrapper{flex-direction:row;align-items:flex-start}}.form-content{background-color:#fff;padding:30px;border-radius:15px;box-shadow:0 10px 25px rgba(0,0,0,.1);flex-grow:1;width:100%}@media (min-width:1024px){.form-content{min-width:600px}}.summary-sidebar{background-color:#fff;padding:25px;border-radius:15px;box-shadow:0 10px 25px rgba(0,0,0,.1);position:sticky;top:20px;align-self:flex-start;width:100%;min-width:300px;flex-shrink:0}@media (min-width:1024px){.summary-sidebar{width:350px}}.input-group label{font-weight:600;color:var(--gray-800);margin-bottom:8px;display:block}.input-group input,.input-group select{width:100%;padding:12px;border:1px solid var(--gray-400);border-radius:8px;font-size:1rem;color:var(--gray-700);transition:border-color .2s ease-in-out,box-shadow .2s ease-in-out}.input-group input:focus,.input-group select:focus{outline:0;border-color:var(--primary-indigo);box-shadow:0 0 0 3px rgba(99,102,241,.2)}.input-group select:disabled{background-color:var(--gray-200);cursor:not-allowed}.btn{padding:12px 20px;border-radius:8px;font-weight:600;cursor:pointer;transition:background-color .2s ease-in-out,transform .1s ease-in-out;display:inline-flex;align-items:center;justify-content:center;gap:8px}.btn-primary{background-color:var(--primary-indigo);color:#fff}.btn-primary:hover{background-color:var(--dark-indigo);transform:translateY(-1px)}.btn-secondary{background-color:var(--light-indigo);color:var(--dark-indigo)}.btn-secondary:hover{background-color:var(--lightest-indigo);transform:translateY(-1px)}.btn-danger{background-color:var(--danger-red);color:#fff}.btn-danger:hover{background-color:var(--dark-red);transform:translateY(-1px)}.results-section h3{font-size:1.5rem;font-weight:700;color:var(--gray-900);margin-bottom:15px}.results-section p{font-size:1.1rem;margin-bottom:8px;color:var(--gray-800)}.results-section p strong{color:var(--gray-900)}.ot-entry-row{display:flex;flex-direction:column;gap:15px;align-items:stretch;margin-bottom:15px;padding:15px;background-color:var(--gray-100);border-radius:8px;border:1px solid var(--gray-300)}.ot-entry-row .input-group{margin-bottom:0}.ot-entry-row .input-group label{font-size:.85rem;margin-bottom:4px}.ot-entry-row input,.ot-entry-row select{padding:8px;font-size:.9rem}.message-box{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background-color:#fff;padding:30px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.2);z-index:1000;text-align:center;min-width:300px;max-width:90%;border:1px solid var(--gray-400);opacity:0;transform:translate(-50%,-50%) scale(.9);transition:opacity .3s ease-out,transform .3s ease-out}.message-box.show{opacity:1;transform:translate(-50%,-50%) scale(1)}.message-box h4{font-size:1.5rem;font-weight:700;color:var(--gray-900);margin-bottom:15px}.message-box p{font-size:1.1rem;color:var(--gray-700);margin-bottom:25px}.message-box-buttons{display:flex;justify-content:center;gap:15px}.message-box button{background-color:var(--primary-indigo);color:#fff;padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer;transition:background-color .2s ease-in-out}.message-box button:hover{background-color:var(--dark-indigo)}.message-box .btn-cancel{background-color:var(--gray-300);color:var(--gray-700)}.message-box .btn-cancel:hover{background-color:var(--gray-400)}.manual-entry-modal{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);display:flex;justify-content:center;align-items:center;z-index:1000;opacity:0;transition:opacity .3s ease-out}.manual-entry-modal.show{opacity:1}.manual-entry-modal-content{background-color:#fff;padding:30px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.2);text-align:center;min-width:350px;max-width:90%;border:1px solid var(--gray-400);transform:scale(.9);transition:transform .3s ease-out}.manual-entry-modal.show .manual-entry-modal-content{transform:scale(1)}.manual-entry-modal-content h4{font-size:1.5rem;font-weight:700;color:var(--gray-900);margin-bottom:15px}.manual-entry-modal-content .input-group{margin-bottom:20px}.manual-entry-modal-content .modal-buttons{display:flex;justify-content:center;gap:15px}@media (max-width:768px){.form-content,.summary-sidebar{padding:20px}.ot-entry-row .remove-btn-container{display:flex;justify-content:flex-end;margin-top:10px}}.ot-group-section{margin-bottom:20px;padding:15px;background-color:#f0f4f8;border-radius:10px;border:1px solid #e2e8f0}.ot-group-section h4{font-size:1.25rem;font-weight:700;color:#2d3748;margin-bottom:10px;border-bottom:1px solid #cbd5e0;padding-bottom:5px}.loading-indicator{margin-left:10px;font-size:.9em;color:var(--primary-indigo);font-weight:500}#userIdDisplay{font-size:.8em;color:var(--gray-600);text-align:right;margin-top:-15px;margin-bottom:15px;word-break:break-all}.highlight-new{animation:highlightFade 2s ease-out forwards}@keyframes highlightFade{from{background-color:#e0f2fe}to{background-color:var(--gray-100)}}.new-badge{background-color:var(--success-green);color:#fff;padding:2px 8px;border-radius:9999px;font-size:.75rem;font-weight:600;margin-left:8px;display:inline-block;vertical-align:middle}.summary-inline-group{display:flex;flex-wrap:wrap;gap:10px;font-size:1rem;color:var(--gray-800);margin-bottom:8px}.summary-inline-group strong{display:block;width:100%;margin-bottom:4px}.summary-inline-item{display:inline-block;padding:4px 8px;background-color:var(--light-indigo);border-radius:6px;color:var(--dark-indigo);font-weight:500}.collapsible-header{display:flex;justify-content:space-between;align-items:center;cursor:pointer;padding:10px 0;border-bottom:1px solid #cbd5e0;margin-bottom:15px}.collapsible-header h3{margin-bottom:0}.collapsible-content{overflow:hidden;transition:max-height .3s ease-out}.collapsible-content.collapsed{max-height:0!important}.collapsible-icon{transition:transform .3s ease-out}.collapsible-icon.rotated{transform:rotate(90deg)}.input-error{border-color:var(--danger-red);box-shadow:0 0 0 3px rgba(239,68,68,.2)}.error-message{color:var(--danger-red);font-size:.85rem;margin-top:4px}.status-message{margin-left:10px;font-size:.9em;font-weight:500;opacity:0;transition:opacity .3s ease-in-out}.status-message.show{opacity:1}.status-message.loading{color:var(--primary-indigo)}.status-message.success{color:var(--success-green)}.status-message.error{color:var(--danger-red)}.no-entries-message{text-align:center;color:var(--gray-600);padding:20px;border:1px dashed var(--gray-400);border-radius:8px;margin-top:15px}.input-with-clear{position:relative;display:flex;align-items:center}.input-with-clear input{padding-right:36px}.clear-input-btn{position:absolute;right:8px;background:0 0;border:none;cursor:pointer;color:var(--gray-500);padding:4px;border-radius:50%;transition:background-color .2s ease-in-out,color .2s ease-in-out;display:flex;align-items:center;justify-content:center}.clear-input-btn:hover{background-color:var(--gray-300);color:var(--gray-700)}.allocation-choice-modal .modal-buttons button{width:100%}.allocation-choice-modal .modal-buttons{flex-direction:column}.toggle-switch{position:relative;display:inline-block;width:60px;height:34px}.toggle-switch input{opacity:0;width:0;height:0}.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;-webkit-transition:.4s;transition:.4s;border-radius:34px}.slider:before{position:absolute;content:"";height:26px;width:26px;left:4px;bottom:4px;background-color:#fff;-webkit-transition:.4s;transition:.4s;border-radius:50%}input:checked+.slider{background-color:var(--primary-indigo)}input:focus+.slider{box-shadow:0 0 1px var(--primary-indigo)}input:checked+.slider:before{-webkit-transform:translateX(26px);-ms-transform:translateX(26px);transform:translateX(26px)}#toastContainer{position:fixed;bottom:1rem;right:1rem;z-index:2000;display:flex;flex-direction:column;gap:.5rem;max-width:300px}.toast{background-color:#333;color:#fff;padding:.75rem 1rem;border-radius:.5rem;box-shadow:0 4px 12px rgba(0,0,0,.2);opacity:0;transform:translateY(20px);transition:opacity .3s ease-out,transform .3s ease-out}.toast.show{opacity:1;transform:translateY(0)}.toast.info{background-color:var(--info-blue)}.toast.success{background-color:var(--success-green)}.toast.error{background-color:var(--danger-red)}.toast.warning{background-color:var(--warning-orange)}#loadingOverlay{transition:opacity .3s ease-in-out}.loader{border-top-color:var(--primary-indigo);animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}.tooltip-container{position:relative;display:inline-flex;align-items:center;margin-left:.5rem;cursor:help}.tooltip-content{position:absolute;bottom:100%;left:50%;transform:translateX(-50%) translateY(-.5rem);background-color:#333;color:#fff;padding:.5rem .75rem;border-radius:.375rem;font-size:.875rem;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .2s ease-out,transform .2s ease-out;z-index:10}.tooltip-container:hover .tooltip-content{opacity:1;transform:translateX(-50%) translateY(-1rem)}.chart-container{position:relative;width:100%;height:256px;display:flex;align-items:center;justify-content:center;background-color:var(--gray-50);border-radius:8px;overflow:hidden}.chart-placeholder{color:var(--gray-500);font-style:italic;text-align:center;padding:1rem}.progress-bar-container{margin-top:1.5rem}.progress-bar-label{display:flex;justify-content:space-between;align-items:center;font-size:.9rem;font-weight:500;color:var(--gray-700);margin-bottom:.5rem}.progress-bar{width:100%;height:12px;background-color:var(--gray-200);border-radius:9999px;overflow:hidden}.progress-bar-fill{height:100%;width:0;border-radius:9999px;transition:width .5s ease-out,background-color .5s ease-out}</style>
</head>
<body>
<div class=main-wrapper>
<div class=form-content>
<h2 class="text-3xl font-extrabold text-center text-gray-900 mb-6">Enhanced OT Calculator</h2>
<div id=userIdDisplay class=hidden></div>
<div class="bg-blue-50 p-6 rounded-xl border border-blue-200 mb-6">
<div class=collapsible-header data-target=howToUseContent>
<h3 class="text-xl font-bold text-blue-800">How to Use This Calculator</h3>
<svg class="collapsible-icon h-6 w-6 text-blue-600" fill=none viewBox="0 0 24 24" stroke=currentColor>
<path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M9 5l7 7-7 7"/>
</svg>
</div>
<div id=howToUseContent class=collapsible-content>
<ul class="list-disc list-inside text-gray-700 space-y-2">
<li><strong>1. Employee Settings:</strong> Enter your basic monthly salary. Optionally, set a target OT pay and/or min/max total hours.</li>
<li><strong>2. OT Planning Date Range:</strong> Define the period for which you want to calculate or plan your overtime.</li>
<li><strong>3. Public Holiday Management:</strong> Add any public holidays within your planning range.</li>
<li><strong>4. OT Multiplier Settings:</strong> Adjust the overtime rates. Note: Rest Day (Sunday) pay is now automatically split for the first 8 hours and after.</li>
<li><strong>5. Daily Overtime Entries:</strong>
<ul class="list-circle list-inside ml-4 mt-1 space-y-1">
<li><strong>Allocation Strategy:</strong> Choose how hours are allocated.
<ul>
<li><strong>Target-Driven:</strong> Automatically selected when you have a "Target OT Pay". This now treats your target as a **minimum**. Choose a sub-strategy:
<ul class="list-square list-inside ml-4">
<li><strong>Balanced:</strong> Uses a human-like, randomized approach to meet your target.</li>
<li><strong>Fastest Path:</strong> Prioritizes high-pay days to meet your target with fewer hours.</li>
<li><strong>Cheapest Path:</strong> Prioritizes low-pay days to maximize hours for a given target.</li>
</ul>
</li>
<li><strong>Workload-Driven:</strong> Automatically selected when you have no target. Allocates hours based on a "Workload Preset".</li>
</ul>
</li>
<li>The logic now ensures your **Min Total OT Hours** target is met if possible, after the pay target is secured.</li>
<li>Click "Auto Allocate Hours" to generate entries based on your chosen strategy.</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-6">
<h3 class="text-xl font-bold text-gray-800 mb-4">Employee Settings</h3>
<div class="grid grid-cols-1 md:grid-cols-2 gap-5">
<div class=input-group>
<label for=basicSalary>Basic Monthly Salary (RM)</label>
<div class=input-with-clear>
<input type=number id=basicSalary value=3700.00 min=0 step=0.01 class=shadow-sm>
<button type=button class=clear-input-btn aria-label="Clear Basic Monthly Salary">
<svg xmlns=http://www.w3.org/2000/svg class="h-4 w-4" fill=none viewBox="0 0 24 24" stroke=currentColor>
<path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M6 18L18 6M6 6l12 12"/>
</svg>
</button>
</div>
</div>
<div class=input-group>
<label for=targetOTPaySelect>Target OT Pay (RM) (Optional)</label>
<select id=targetOTPaySelect class="shadow-sm mb-2">
<option value="">No Target</option>
<option value=custom>Other (Enter Manually)</option>
</select>
<div class=input-with-clear>
<input type=number id=customTargetOTPayInput class="shadow-sm hidden" placeholder="Enter custom target pay">
<button type=button class="clear-input-btn hidden" id=clearCustomTargetOTPayBtn aria-label="Clear Custom Target OT Pay">
<svg xmlns=http://www.w3.org/2000/svg class="h-4 w-4" fill=none viewBox="0 0 24 24" stroke=currentColor>
<path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M6 18L18 6M6 6l12 12"/>
</svg>
</button>
</div>
</div>
<div class=input-group>
<label for=minTotalOTHours>Min Total OT Hours (Optional)
<span class=tooltip-container>
<svg xmlns=http://www.w3.org/2000/svg class="h-4 w-4 text-gray-400" fill=none viewBox="0 0 24 24" stroke=currentColor><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
<span class=tooltip-content>The minimum total OT hours to aim for.</span>
</span>
</label>
<div class=input-with-clear>
<input type=number id=minTotalOTHours min=0 step=0.5 class=shadow-sm placeholder="e.g., 140">
<button type=button class=clear-input-btn id=clearMinTotalOTHoursBtn aria-label="Clear Min Total OT Hours">
<svg xmlns=http://www.w3.org/2000/svg class="h-4 w-4" fill=none viewBox="0 0 24 24" stroke=currentColor><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M6 18L18 6M6 6l12 12"/></svg>
</button>
</div>
<div id=minMaxHoursError class=error-message></div>
</div>
<div class=input-group>
<label for=maxTotalOTHours>Max Total OT Hours (Optional)
<span class=tooltip-container>
<svg xmlns=http://www.w3.org/2000/svg class="h-4 w-4 text-gray-400" fill=none viewBox="0 0 24 24" stroke=currentColor><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
<span class=tooltip-content>The maximum total OT hours not to exceed.</span>
</span>
</label>
<div class=input-with-clear>
<input type=number id=maxTotalOTHours min=0 step=0.5 class=shadow-sm placeholder="e.g., 150">
<button type=button class=clear-input-btn id=clearMaxTotalOTHoursBtn aria-label="Clear Max Total OT Hours">
<svg xmlns=http://www.w3.org/2000/svg class="h-4 w-4" fill=none viewBox="0 0 24 24" stroke=currentColor><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M6 18L18 6M6 6l12 12"/></svg>
</button>
</div>
</div>
</div>
<div class=mt-6>
<label class="block text-xl font-bold text-gray-800 mb-3">Auto-Allocate to:</label>
<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
<div class="flex items-center">
<input type=checkbox id=allocateWorkingDay class="h-5 w-5 text-primary-indigo rounded border-gray-300 focus:ring-primary-indigo" checked>
<label for=allocateWorkingDay class="ml-2 text-gray-700 font-medium">Working Day</label>
</div>
<div class="flex items-center">
<input type=checkbox id=allocateOffDay class="h-5 w-5 text-primary-indigo rounded border-gray-300 focus:ring-primary-indigo" checked>
<label for=allocateOffDay class="ml-2 text-gray-700 font-medium">Off Day</label>
</div>
<div class="flex items-center">
<input type=checkbox id=allocateRestDay class="h-5 w-5 text-primary-indigo rounded border-gray-300 focus:ring-primary-indigo" checked>
<label for=allocateRestDay class="ml-2 text-gray-700 font-medium">Rest Day</label>
</div>
<div class="flex items-center">
<input type=checkbox id=allocatePublicHoliday class="h-5 w-5 text-primary-indigo rounded border-gray-300 focus:ring-primary-indigo" checked>
<label for=allocatePublicHoliday class="ml-2 text-gray-700 font-medium">Public Holiday</label>
</div>
</div>
</div>
<p class="text-sm text-gray-600 mt-4">
Working Schedule: 5 days/week, Saturday: Off Day, Sunday: Rest Day. For payroll, employer uses 26 working days monthly.
</p>
</div>
<div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-6">
<h3 class="text-xl font-bold text-gray-800 mb-4">OT Planning Date Range</h3>
<div class=input-group>
<label for=dateRangeInput>Select Date Range</label>
<div class="flex items-center gap-2">
<input id=dateRangeInput class="shadow-sm flex-grow" placeholder="Click to select date range" readonly>
<button type=button id=setThisMonthBtn class="btn btn-secondary p-2" aria-label="Set date range to this month">
This Month
</button>
</div>
<div id=dateRangeError class=error-message></div>
</div>
</div>
<div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-6">
<div class=collapsible-header data-target=publicHolidaysContent>
<h3 class="text-xl font-bold text-gray-800">Public Holiday Management</h3>
<svg class="collapsible-icon h-6 w-6 text-gray-600" fill=none viewBox="0 0 24 24" stroke=currentColor>
<path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M9 5l7 7-7 7"/>
</svg>
</div>
<div id=publicHolidaysContent class=collapsible-content>
<div class="flex flex-col sm:flex-row gap-4 mb-4">
<div class="input-group flex-grow">
<label for=publicHolidayDate>Add Public Holiday Date</label>
<div class="flex items-center gap-2">
<input type=date id=publicHolidayDate class="shadow-sm flex-grow">
<button type=button id=setPublicHolidayTodayBtn class="btn btn-secondary p-2" aria-label="Set public holiday date to today">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor><path fill-rule=evenodd d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule=evenodd /></svg>
</button>
</div>
</div>
<button id=addPublicHolidayDateBtn class="btn btn-secondary mt-auto" aria-label="Add public holiday">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor><path fill-rule=evenodd d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule=evenodd /></svg>
Add Holiday
</button>
</div>
<ul id=publicHolidaysList class="list-disc list-inside ml-4 text-gray-700">
</ul>
</div>
</div>
<div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-6">
<div class=collapsible-header data-target=otMultiplierContent>
<h3 class="text-xl font-bold text-gray-800">OT Multiplier Settings</h3>
<svg class="collapsible-icon h-6 w-6 text-gray-600" fill=none viewBox="0 0 24 24" stroke=currentColor>
<path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M9 5l7 7-7 7"/>
</svg>
</div>
<div id=otMultiplierContent class=collapsible-content>
<div id=otMultiplierInputs class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-4">
</div>
<button id=resetMultipliersBtn class="btn btn-secondary" aria-label="Reset OT multipliers to default">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor><path fill-rule=evenodd d="M4 2a1 1 0 011 1v2.118a1 1 0 01-.293.707l-2.118 2.118A1 1 0 012 8v8a2 2 0 002 2h12a2 2 0 002-2V8a1 1 0 01-.293-.707l-2.118-2.118A1 1 0 0115 5.118V3a1 1 0 011-1h-2a1 1 0 01-1-1V1a1 1 0 10-2 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1V1a1 1 0 10-2 0v1a1 1 0 01-1 1H4zm2 5V4h8v3H6zm-2 4h12V9H4v2zm0 2h12v3H4v-3z" clip-rule=evenodd /></svg>
Reset to Default Multipliers
</button>
</div>
</div>
<div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
<h3 class="text-xl font-bold text-gray-800 mb-4">Daily Overtime Entries</h3>
<div class="input-group mb-4">
<label for=allocationStrategy>Allocation Strategy
<span class=tooltip-container>
<svg xmlns=http://www.w3.org/2000/svg class="h-4 w-4 text-gray-400" fill=none viewBox="0 0 24 24" stroke=currentColor><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
<span class=tooltip-content>This is set automatically based on Target OT Pay.</span>
</span>
</label>
<select id=allocationStrategy class=shadow-sm aria-describedby=allocationStrategyDescription>
<option value=Target-Driven>Target-Driven (using Workload Presets)</option>
<option value=Workload-Driven>Workload-Driven (Fill All Days)</option>
</select>
<p id=allocationStrategyDescription class="text-sm text-gray-600 mt-2"></p>
</div>
<div id=targetDrivenStrategyGroup class="input-group mb-4 hidden">
<label for=targetAllocationStrategy>Target-Driven Strategy
<span class=tooltip-container>
<svg xmlns=http://www.w3.org/2000/svg class="h-4 w-4 text-gray-400" fill=none viewBox="0 0 24 24" stroke=currentColor><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
<span class=tooltip-content>Choose how to meet your OT pay target.</span>
</span>
</label>
<select id=targetAllocationStrategy class=shadow-sm aria-describedby=targetAllocationStrategyDescription>
<option value=Balanced>Balanced (Human-like)</option>
<option value="Fastest Path">Fastest Path (Fewest Hours)</option>
<option value="Cheapest Path">Cheapest Path (Most Hours)</option>
</select>
<p id=targetAllocationStrategyDescription class="text-sm text-gray-600 mt-2"></p>
</div>
<div id=workloadPresetGroup class="input-group mb-4">
<label for=workloadPreset>Workload Preset for Auto Allocation
<span class=tooltip-container>
<svg xmlns=http://www.w3.org/2000/svg class="h-4 w-4 text-gray-400" fill=none viewBox="0 0 24 24" stroke=currentColor><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
<span class=tooltip-content>Defines min/max hours for different day types.</span>
</span>
</label>
<select id=workloadPreset class=shadow-sm aria-describedby=workloadPresetDescription>
<option value="Moderate Workload">Moderate Workload</option>
<option value="Light Workload">Light Workload</option>
<option value="Heavy Workload">Heavy Workload</option>
</select>
<p id=workloadPresetDescription class="text-sm text-gray-600 mt-2"></p>
</div>
<div id=workloadPresetDetails class="text-sm text-gray-700 mb-4 p-3 bg-gray-100 rounded-md border border-gray-200">
</div>
<div class="flex flex-col sm:flex-row gap-4 mb-4">
<button id=autoAllocateBtn class="btn btn-secondary flex-grow" aria-label="Auto allocate hours">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor><path d="M17.293 3.293a1 1 0 011.414 0l-2.293 2.293a1 1 0 01-1.414-1.414l2.293-2.293zM9 12a3 3 0 100-6 3 3 0 000 6z"/><path fill-rule=evenodd d="M15.293 10.293a1 1 0 010 1.414l-2.293 2.293a1 1 0 01-1.414-1.414l2.293-2.293a1 1 0 011.414 0zM4.707 4.707a1 1 0 010 1.414L2.414 8.414a1 1 0 01-1.414-1.414L3.293 4.707a1 1 0 011.414 0zM12 9a3 3 0 10-6 0 3 3 0 006 0z" clip-rule=evenodd /></svg>
Auto Allocate Hours
<span id=autoAllocateLoading class="loading-indicator hidden" aria-live=polite>Allocating...</span>
</button>
</div>
<div id=otEntriesContainer>
<p id=noEntriesMessage class="no-entries-message hidden">No OT entries yet. Click "Add OT Entry" or "Auto Allocate Hours" to get started!</p>
</div>
<div class="flex flex-col sm:flex-row gap-4 mt-4">
<button id=addOTEntryBtn class="btn btn-secondary flex-grow" aria-label="Add new OT entry">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor><path fill-rule=evenodd d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule=evenodd /></svg>
Add OT Entry
</button>
<button id=clearAllEntriesBtn class="btn btn-danger flex-grow" aria-label="Clear all OT entries">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor><path fill-rule=evenodd d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule=evenodd /></svg>
Clear All Entries
</button>
</div>
<div class="flex flex-col sm:flex-row gap-4 mt-4">
<button id=saveDataBtn class="btn btn-primary flex-grow" aria-label="Save current data">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor><path d="M7 3a1 1 0 00-1 1v1a1 1 0 001 1h6a1 1 0 001-1V4a1 1 0 00-1-1H7z"/><path fill-rule=evenodd d="M18 8H2a2 2 0 00-2 2v8a2 2 0 002 2h16a2 2 0 002-2v-8a2 2 0 00-2-2zM4 13a1 1 0 011-1h10a1 1 0 011 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-3z" clip-rule=evenodd /></svg>
Save Data
<span id=saveDataStatus class=status-message aria-live=polite></span>
</button>
<button id=loadDataBtn class="btn btn-secondary flex-grow" aria-label="Load saved data">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor><path fill-rule=evenodd d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule=evenodd /></svg>
Load Data
<span id=loadDataStatus class=status-message aria-live=polite></span>
</button>
</div>
</div>
<div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mt-6 flex items-center justify-between">
<label for=firebaseToggle class="text-xl font-bold text-gray-800 cursor-pointer">
Enable Firebase (Save/Load)
</label>
<label class=toggle-switch>
<input type=checkbox id=firebaseToggle>
<span class=slider></span>
</label>
</div>
<p id=firebaseStatusMessage class="text-sm text-gray-600 mt-2 text-center"></p>
<button id=resetAndReallocateBtn class="btn btn-danger w-full mt-4" aria-label="Reset all and re-allocate">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor><path fill-rule=evenodd d="M4 2a1 1 0 011 1v2.118a1 1 0 01-.293.707l-2.118 2.118A1 1 0 012 8v8a2 2 0 002 2h12a2 2 0 002-2V8a1 1 0 01-.293-.707l-2.118-2.118A1 1 0 0115 5.118V3a1 1 0 011-1h-2a1 1 0 01-1-1V1a1 1 0 10-2 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1V1a1 1 0 10-2 0v1a1 1 0 01-1 1H4zm2 5V4h8v3H6zm-2 4h12V9H4v2zm0 2h12v3H4v-3z" clip-rule=evenodd /></svg>
Reset & Re-allocate All
</button>
</div>
<div class=summary-sidebar>
<div id=results class=results-section>
<h3 class="text-2xl font-bold text-gray-900 mb-4">Calculation Summary</h3>
<div id=payProgressContainer class="progress-bar-container hidden">
<div class=progress-bar-label>
<span>Pay Target Progress</span>
<span id=payPercentage>0%</span>
</div>
<div class=progress-bar>
<div id=payProgressBar class=progress-bar-fill></div>
</div>
</div>
<div id=hoursProgressContainer class="progress-bar-container hidden">
<div class=progress-bar-label>
<span>Hours Progress</span>
<span id=hoursPercentage>0%</span>
</div>
<div class=progress-bar>
<div id=hoursProgressBar class=progress-bar-fill></div>
</div>
</div>
<p class="text-xl font-bold text-gray-900 mt-6">Combined OT Pay: <span id=combinedOTPay class=text-indigo-600>RM 0.00</span></p>
<p class="text-xl font-bold text-gray-900 mt-2">Target OT Pay: <span id=targetOTPayDisplay class=text-green-600>RM 0.00</span></p>
<p class="text-xl font-bold mt-2">Difference from Target: <span id=differenceFromTarget>RM 0.00</span></p>
<p class="text-xl font-bold mt-2">Total Monthly OT Hours: <span id=totalMonthlyOTHoursDisplay>0.0 hours</span></p>
<p class="text-xl font-bold mt-2">Total OT Hours Range: <span id=totalOTHoursRangeDisplay>N/A</span></p>
<p class="text-xl font-bold text-gray-900 mt-2">Expected Salary Pay: <span id=expectedSalaryPayDisplay class=text-indigo-600>RM 0.00</span></p>
<h4 class="text-lg font-bold text-gray-800 mt-6 mb-2">OT Pay Distribution</h4>
<div class=chart-container>
<canvas id=otDistributionChart class="w-full h-full"></canvas>
<p id=chartPlaceholder class="chart-placeholder absolute hidden">No OT data to display. Add entries and calculate!</p>
</div>
<div class="summary-inline-group mt-6">
<strong>Total OT Hours by Type:</strong>
<span id=totalHoursByType class=text-gray-700></span>
</div>
<div class=summary-inline-group>
<strong>Total Pay per OT Category:</strong>
<span id=totalPayByCategory class=text-gray-700></span>
</div>
<p class="text-base font-bold text-gray-900 mt-2">Allocation Strategy: <span id=allocationStrategySummary class=text-gray-700></span></p>
<button id=exportSummaryBtn class="btn btn-secondary mt-6" aria-label="Export OT summary to text file">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor><path fill-rule=evenodd d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L10 11.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule=evenodd /></svg>
Export Summary
</button>
</div>
</div>
</div>
<div id=messageBox class="message-box hidden" role=dialog aria-modal=true aria-labelledby=messageBoxTitle aria-describedby=messageBoxContent>
<h4 id=messageBoxTitle></h4>
<p id=messageBoxContent></p>
<div class=message-box-buttons>
<button id=messageBoxCancelBtn class="btn btn-cancel hidden">Cancel</button>
<button id=messageBoxConfirmBtn class=hidden>Confirm</button>
<button id=messageBoxCloseBtn>OK</button>
</div>
</div>
<div id=addDetailedOTEntryModal class="manual-entry-modal hidden" role=dialog aria-modal=true aria-labelledby=detailedEntryModalTitle>
<div class=manual-entry-modal-content>
<h4 id=detailedEntryModalTitle class="text-2xl font-bold text-gray-900 mb-4">Add Detailed OT Entry</h4>
<div class=input-group>
<label for=detailedEntryDate>Select Date</label>
<input type=date id=detailedEntryDate class=shadow-sm>
<div id=detailedEntryDateError class="error-message text-left"></div>
</div>
<div class=input-group>
<label for=detailedEntryHours>Hours</label>
<input type=number id=detailedEntryHours value=2.0 min=0.5 step=0.5 class=shadow-sm>
<div id=detailedEntryHoursError class="error-message text-left"></div>
</div>
<div class=input-group>
<label for=detailedEntryStartTime>Start Time</label>
<input type=time id=detailedEntryStartTime value=18:00 class=shadow-sm>
<div id=detailedEntryStartTimeError class="error-message text-left"></div>
</div>
<div class=input-group>
<label for=detailedEntryEndTime>End Time (Calculated)</label>
<input type=time id=detailedEntryEndTime class=shadow-sm readonly>
</div>
<div class=modal-buttons>
<button id=cancelDetailedEntryBtn class="btn btn-cancel">Cancel</button>
<button id=confirmDetailedEntryBtn class="btn btn-primary">Add Entry</button>
</div>
</div>
</div>
<div id=allocationChoiceModal class="manual-entry-modal hidden allocation-choice-modal" role=dialog aria-modal=true aria-labelledby=allocationChoiceModalTitle>
<div class=manual-entry-modal-content>
<h4 id=allocationChoiceModalTitle class="text-2xl font-bold text-gray-900 mb-4">Auto-Allocation Options</h4>
<p class="text-gray-700 mb-6">How would you like to allocate overtime hours?</p>
<div class=modal-buttons>
<button id=clearAndAllocateBtn class="btn btn-danger">
Auto Allocate
</button>
<button id=fillRemainingBtn class="btn btn-primary mt-4">
Fill Remaining Hours
</button>
<button id=cancelAllocationChoiceBtn class="btn btn-secondary mt-4">
Cancel
</button>
</div>
</div>
</div>
<div id=loadingOverlay class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[3000] hidden">
<div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-16 w-16"></div>
</div>
<div id=toastContainer></div>
<script type=module>import{initializeApp}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";import{getAuth,signInAnonymously,signInWithCustomToken,onAuthStateChanged}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";import{getFirestore,doc,getDoc,setDoc}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";const DEFAULT_OT_MULTIPLIERS={"Normal OT (Weekdays)":1.5,"Off Day (Saturday)":1.5,"Rest Day (Sunday)":.5,"Rest Day (Sunday) - After 8h":2,"Public Holiday":2},DISPLAYABLE_OT_TYPES=["Normal OT (Weekdays)","Off Day (Saturday)","Rest Day (Sunday)","Public Holiday"],PREDEFINED_TARGET_PAYS=[1e3,2e3,3e3,4e3,5e3],CONFIG={WORKING_DAYS_MONTHLY:26,STANDARD_WORK_HOURS_DAILY:8,MAX_DAILY_OT_HOURS:8,ALLOCATION_PRECISION:.01,OT_MULTIPLIERS:{...DEFAULT_OT_MULTIPLIERS},WORKLOAD_PRESETS:{"Light Workload":{"Normal OT (Weekdays)":{minHours:1,maxHours:5},"Off Day (Saturday)":{minHours:2,maxHours:5},"Rest Day (Sunday)":{minHours:2,maxHours:6}},"Moderate Workload":{"Normal OT (Weekdays)":{minHours:2,maxHours:7},"Off Day (Saturday)":{minHours:3,maxHours:8},"Rest Day (Sunday)":{minHours:4,maxHours:8}},"Heavy Workload":{"Normal OT (Weekdays)":{minHours:3,maxHours:8},"Off Day (Saturday)":{minHours:5,maxHours:8},"Rest Day (Sunday)":{minHours:6,maxHours:8}}}};(async()=>{let e,t,a,n,s,o,i,r,l,d,c,u,m,y,g,f,h,p,L,v,T,E,I,O,D,S,w,x,C,b,F,_,B,H,A,P,N,M,$,k,R,Y,U,G,W,j,q,z,X,J,K,V,Z,Q,ee,te,ae,ne,se,oe,ie,re,le,de,ce,ue,me,ye,ge,fe,he,pe,Le,ve,Te,Ee,Ie,Oe,De,Se,we,xe,Ce,be,Fe,_e,Be,He,Ae,Pe,Ne,Me,$e,ke,Re,Ye,Ue,Ge=null,We=!1,je=JSON.parse(localStorage.getItem("isFirebaseEnabled")||"true"),qe=[],ze=[],Xe=0,Je="Moderate Workload",Ke="Target-Driven";function Ve(e,t){let a;return function(...n){const s=this;clearTimeout(a),a=setTimeout((()=>e.apply(s,n)),t)}}async function Ze(){return new Promise((e=>setTimeout(e,0)))}function Qe(e,t,a="info",n=null){"info"!==a?(Z.textContent=e,Q.textContent=t,ee.classList.add("hidden"),te.classList.add("hidden"),ae.classList.add("hidden"),"confirm"===a?(te.onclick=()=>{V.classList.add("hidden"),V.classList.remove("show"),n&&n(),window.lastFocusedElement&&window.lastFocusedElement.focus()},ae.onclick=()=>{V.classList.add("hidden"),V.classList.remove("show"),window.lastFocusedElement&&window.lastFocusedElement.focus()},te.classList.remove("hidden"),ae.classList.remove("hidden")):(ee.onclick=()=>{V.classList.add("hidden"),V.classList.remove("show"),window.lastFocusedElement&&window.lastFocusedElement.focus()},ee.classList.remove("hidden")),V.classList.remove("hidden"),V.classList.add("show"),window.lastFocusedElement=document.activeElement,te.focus()):et(t,"info")}function et(e,t="info"){const a=document.createElement("div");a.classList.add("toast",t),a.textContent=e,Ce.appendChild(a),a.offsetWidth,a.classList.add("show"),setTimeout((()=>{a.classList.remove("show"),a.addEventListener("transitionend",(()=>{a.remove()}),{once:!0})}),3e3)}function tt(){xe.classList.remove("hidden"),xe.style.opacity="0",xe.offsetWidth,xe.style.opacity="1"}function at(){xe.style.opacity="0",xe.addEventListener("transitionend",(function e(){xe.classList.add("hidden"),xe.removeEventListener("transitionend",e)}),{once:!0})}function nt(e,t,a){e.textContent=t,e.className=`status-message show ${a}`,e.setAttribute("aria-live","polite"),"loading"!==a&&setTimeout((()=>{e.classList.remove("show"),e.removeAttribute("aria-live")}),2e3)}function st(){if("custom"===o.value){const e=parseFloat(i.value);return isNaN(e)?null:e}return""===o.value?null:parseFloat(o.value)}function ot(){const e=parseFloat(l.value),t=parseFloat(c.value);return{minHours:isNaN(e)?null:e,maxHours:isNaN(t)?null:t}}function it(){const{minHours:e,maxHours:t}=ot();return m.textContent="",l.classList.remove("input-error"),c.classList.remove("input-error"),!(null!==e&&null!==t&&e>t)||(m.textContent="Min hours cannot be greater than Max hours.",l.classList.add("input-error"),c.classList.add("input-error"),!1)}function rt(e){return e<=0?0:e/CONFIG.WORKING_DAYS_MONTHLY/CONFIG.STANDARD_WORK_HOURS_DAILY}function lt(e,t,a,n){let s=0;const o=Ft(n)?"Public Holiday":a;if("Rest Day (Sunday)"===o){const a=CONFIG.OT_MULTIPLIERS["Rest Day (Sunday)"],n=CONFIG.OT_MULTIPLIERS["Rest Day (Sunday) - After 8h"];if(t<=8)s=e*a*t;else{s=e*a*8+e*n*(t-8)}}else{const a=CONFIG.OT_MULTIPLIERS[o];if(void 0===a)return console.warn(`Unknown OT type or multiplier for type: ${o}`),0;s=e*a*t}return s}function dt(e){return`RM ${e.toFixed(2)}`}function ct(){const e=new Date;return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function ut(e,t){if(!e)return"";const[a,n]=e.split(":").map(Number);let s=60*a+n+60*t,o=Math.floor(s/60)%24,i=Math.round(s%60);return 60===i&&(i=0,o=(o+1)%24),`${String(o).padStart(2,"0")}:${String(i).padStart(2,"0")}`}function mt(e,t=null){const a=Math.floor(4*Math.random())+18,n=[0,15,30,45],s=n[Math.floor(Math.random()*n.length)],o=`${String(a).padStart(2,"0")}:${String(s).padStart(2,"0")}`;e.startTime=o,e.endTime=ut(e.startTime,e.hours)}function yt(){qe=[],F.innerHTML="",Xe=0,_.classList.remove("hidden")}function gt(e){if(Ft(e))return"Public Holiday";switch(new Date(e).getDay()){case 0:return"Rest Day (Sunday)";case 6:return"Off Day (Saturday)";default:return"Normal OT (Weekdays)"}}async function ft(){F.innerHTML="";const e=Re.selectedDates,t=e[0]?new Date(e[0].toISOString().split("T")[0]):null,a=e[1]?new Date(e[1].toISOString().split("T")[0]):null;let n=qe;t&&a&&(n=qe.filter((e=>{const n=new Date(e.date);return n.setHours(0,0,0,0),n>=t&&n<=a}))),0===n.length?_.classList.remove("hidden"):_.classList.add("hidden");const s=n.map((e=>({...e,displayType:gt(e.date)}))).reduce(((e,t)=>((e[t.displayType]=e[t.displayType]||[]).push(t),e)),{}),o=DISPLAYABLE_OT_TYPES;for(const t of o)if(s[t]&&s[t].length>0){const a=document.createElement("div");a.classList.add("ot-group-section");const n=document.createElement("h4");n.textContent=t,a.appendChild(n),s[t].sort(((e,t)=>new Date(e.date)-new Date(t.date)));for(const n of s[t])await new Promise((t=>requestAnimationFrame((()=>{const s=n.id,o=document.createElement("div");o.classList.add("ot-entry-row","flex","flex-col","gap-4"),o.setAttribute("data-id",s),n.isNew&&(o.classList.add("highlight-new"),setTimeout((()=>{o.classList.remove("highlight-new");const e=qe.findIndex((e=>e.id===s));-1!==e&&delete qe[e].isNew}),2e3));const i=gt(n.date);o.innerHTML=`\n                                    <div class="grid grid-cols-2 gap-4 items-end">\n                                        <div class="input-group">\n                                            <label for="${s}-date">Date${n.isNew?'<span class="new-badge">New</span>':""}</label>\n                                            <input type="date" id="${s}-date" value="${n.date}" class="shadow-sm">\n                                        </div>\n                                        <div class="input-group">\n                                            <label for="${s}-hours">Hours</label>\n                                            <input type="number" id="${s}-hours" value="${n.hours.toFixed(1)}" min="0" step="0.5" class="shadow-sm">\n                                            <div id="${s}-hours-error" class="error-message"></div>\n                                        </div>\n                                    </div>\n                                    <div class="flex gap-4">\n                                        <div class="input-group flex-1">\n                                            <label for="${s}-start-time">Start Time</label>\n                                            <input type="time" id="${s}-start-time" value="${n.startTime}" class="shadow-sm">\n                                            <div id="${s}-start-time-error" class="error-message"></div>\n                                        </div>\n                                        <div class="input-group flex-1">\n                                            <label for="${s}-end-time">End Time</label>\n                                            <input type="time" id="${s}-end-time" class="shadow-sm" readonly>\n                                        </div>\n                                    </div>\n                                    <div class="grid grid-cols-[1.8fr_auto] gap-4 items-end">\n                                        <div class="input-group">\n                                            <label for="${s}-type">OT Type</label>\n                                            <select id="${s}-type" class="shadow-sm" disabled>\n                                                ${DISPLAYABLE_OT_TYPES.map((e=>`<option value="${e}">${e}</option>`)).join("")}\n                                            </select>\n                                        </div>\n                                        <div class="remove-btn-container flex justify-end">\n                                            <button type="button" class="btn btn-danger btn-sm remove-ot-entry-btn" data-id="${s}" aria-label="Remove OT entry for ${n.date}">\n                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" /></svg>\n                                            </button>\n                                        </div>\n                                    </div>\n                                `,a.appendChild(o);const r=o.querySelector(`#${s}-type`);r&&(r.value=i);const l=o.querySelector(`#${s}-end-time`);l&&(l.value=n.endTime);const d=o.querySelector(`#${s}-date`);if(d){const t=qe.filter((e=>e.id!==s)).map((e=>e.date));window.flatpickr(d,{dateFormat:"Y-m-d",minDate:e[0]?e[0]:null,maxDate:e[1]?e[1]:null,disable:t,onChange:function(e,t,a){ht(s,"date",t)}})}const c=o.querySelector(`#${s}-start-time`);c&&window.flatpickr(c,{enableTime:!0,noCalendar:!0,dateFormat:"H:i",time_24hr:!0,minuteIncrement:15,onChange:function(e,t,a){ht(s,"startTime",t)}});const u=o.querySelector(`#${s}-hours`),m=o.querySelector(`#${s}-hours-error`);u.addEventListener("input",(e=>{const t=parseFloat(e.target.value);isNaN(t)||t<0?(u.classList.add("input-error"),m.textContent="Hours must be a positive number."):t>CONFIG.MAX_DAILY_OT_HOURS?(u.classList.add("input-error"),m.textContent=`Max hours per day is ${CONFIG.MAX_DAILY_OT_HOURS}.`):(u.classList.remove("input-error"),m.textContent="",ht(s,"hours",t))})),o.querySelector(".remove-ot-entry-btn").addEventListener("click",(()=>{Qe("Confirm Removal","Are you sure you want to remove this OT entry? This action cannot be undone.","confirm",(()=>{qe=qe.filter((e=>e.id!==s)),ft(),Lt(),et("Entry Removed","success")}))})),t()}))));F.appendChild(a)}}function ht(e,t,a){const n=qe.findIndex((t=>t.id===e));if(-1===n)return;const s={...qe[n]};if("date"===t){const t=a,o=Re.selectedDates,i=o[0]?new Date(o[0].toISOString().split("T")[0]):null,r=o[1]?new Date(o[1].toISOString().split("T")[0]):null,l=new Date(t);if(i&&r&&(l<i||l>r))return et(`Date ${t} is outside the current planning range.`,"error"),void(document.querySelector(`#${e}-date`).value=s.date);if(qe.some((a=>a.id!==e&&a.date===t)))return Qe("Duplicate Date Warning",`An OT entry already exists for ${t}. Please choose a different date.`),void(document.querySelector(`#${e}-date`).value=s.date);qe[n].date=t,qe[n].type=gt(t)}else if("hours"===t){const e=parseFloat(a);e<=0?(qe.splice(n,1),et("Entry removed as hours were set to 0 or less.","info")):(qe[n].hours=e,qe[n].endTime=ut(qe[n].startTime,qe[n].hours))}else"startTime"===t?(qe[n].startTime=a,qe[n].endTime=ut(qe[n].startTime,qe[n].hours)):qe[n][t]=a;ft(),Lt()}function pt(){Qe("Confirm Clear All","Are you sure you want to clear all daily OT entries? This action cannot be undone.","confirm",(()=>{yt(),et("All entries cleared!","success"),Lt()}))}function Lt(){const e=parseFloat(n.value),t=st(),{minHours:a,maxHours:s}=ot(),o=Re.selectedDates,i=o[0]?o[0].toISOString().split("T")[0]:"",r=o[1]?o[1].toISOString().split("T")[0]:"";if(isNaN(e)||e<=0)return R.innerHTML="",Y.innerHTML="",U.textContent=dt(0),j.textContent="0.0 hours",z.textContent=dt(0),G.textContent="N/A (No target set)",G.classList.remove("text-green-600"),G.classList.add("text-gray-600"),W.textContent="N/A (No target set)",W.classList.remove("text-green-600","text-red-600"),W.classList.add("text-gray-600"),K.textContent=Ke,q.textContent="N/A",q.classList.remove("text-green-600","text-red-600","text-orange-600"),q.classList.add("text-gray-600"),Tt([],[]),void vt(0,0,null,null,null);const l=rt(e);let d={},c={},u=0,m=0;DISPLAYABLE_OT_TYPES.forEach((e=>{d[e]=0,c[e]=0})),qe.forEach((e=>{const t=new Date(e.date),a=i?new Date(i):null,n=r?new Date(r):null;if(a&&n&&(t.setHours(0,0,0,0),a.setHours(0,0,0,0),n.setHours(0,0,0,0),t<a||t>n))return;const s=parseFloat(e.hours);if(isNaN(s)||s<=0)return;const o=gt(e.date),y=lt(l,s,e.type,e.date);d[o]+=s,c[o]+=y,u+=y,m+=s}));const y=e+u;let g=[];DISPLAYABLE_OT_TYPES.forEach((e=>{d[e]>0&&g.push(`<span class="summary-inline-item">${e}: ${d[e].toFixed(1)}h</span>`)})),R.innerHTML=g.join("");let f=[],h=[],p=[];if(DISPLAYABLE_OT_TYPES.forEach((e=>{c[e]>0&&(f.push(`<span class="summary-inline-item">${e}: ${dt(c[e])}</span>`),h.push(e),p.push(c[e]))})),Y.innerHTML=f.join(""),Tt(h,p,["#6366f1","#ef4444","#f59e0b","#10b981","#3b82f6"]),U.textContent=dt(u),j.textContent=`${m.toFixed(1)} hours`,z.textContent=dt(y),K.textContent=Ke,"Target-Driven"===Ke){const e=D.options[D.selectedIndex].text;K.textContent+=` (${e})`}if(null===t||t<=0)G.textContent="N/A (No target set)",G.classList.remove("text-green-600"),G.classList.add("text-gray-600"),W.textContent="N/A (No target set)",W.classList.remove("text-green-600","text-red-600"),W.classList.add("text-gray-600");else{G.textContent=dt(t),G.classList.remove("text-gray-600"),G.classList.add("text-green-600");const e=u-t;W.textContent=dt(e),e>=0?(W.classList.remove("text-red-600","text-gray-600"),W.classList.add("text-green-600")):(W.classList.remove("text-green-600","text-gray-600"),W.classList.add("text-red-600"))}q.classList.remove("text-green-600","text-red-600","text-orange-600","text-gray-600"),null!==a&&null!==s?(q.textContent=`${a.toFixed(1)}h - ${s.toFixed(1)}h`,m>=a&&m<=s?q.classList.add("text-green-600"):m<a?q.classList.add("text-orange-600"):q.classList.add("text-red-600")):null!==a?(q.textContent=`Min: ${a.toFixed(1)}h`,m>=a?q.classList.add("text-green-600"):q.classList.add("text-orange-600")):null!==s?(q.textContent=`Max: ${s.toFixed(1)}h`,m<=s?q.classList.add("text-green-600"):q.classList.add("text-red-600")):(q.textContent="N/A",q.classList.add("text-gray-600")),vt(u,m,t,a,s)}function vt(e,t,a,n,s){if(null!==a&&a>0){Ae.classList.remove("hidden");const t=Math.min(e/a*100,100);Pe.textContent=`${Math.round(t)}%`,Ne.style.width=`${t}%`,Ne.style.backgroundColor=t>=100?"var(--success-green)":"var(--primary-indigo)"}else Ae.classList.add("hidden");if(null!==n||null!==s){Me.classList.remove("hidden");let e=0,a="var(--primary-indigo)";if(null!==n&&null!==s)if(t<n)e=t/n*50,a="var(--warning-orange)";else{e=50+(t-n)/(s-n)*50,a="var(--success-green)"}else null!==n?(e=t/n*100,a=t>=n?"var(--success-green)":"var(--warning-orange)"):null!==s&&(e=t/s*100,a="var(--primary-indigo)");null!==s&&t>s&&(e=100,a="var(--danger-red)"),e=Math.max(0,Math.min(e,100)),$e.textContent=`${t.toFixed(1)}h`,ke.style.width=`${e}%`,ke.style.backgroundColor=a}else Me.classList.add("hidden")}function Tt(e,t,a){const n=document.getElementById("otDistributionChart").getContext("2d");if(0===t.length||t.every((e=>0===e)))return Ge&&(Ge.destroy(),Ge=null),void be.classList.remove("hidden");be.classList.add("hidden"),Ge?(Ge.data.labels=e,Ge.data.datasets[0].data=t,Ge.data.datasets[0].backgroundColor=a,Ge.update()):Ge=new Chart(n,{type:"pie",data:{labels:e,datasets:[{label:"OT Pay (RM)",data:t,backgroundColor:a,hoverOffset:4}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"right",labels:{font:{family:"Inter"}}},tooltip:{callbacks:{label:function(e){let t=e.label||"";return t&&(t+=": "),null!==e.parsed&&(t+=dt(e.parsed)),t}},bodyFont:{family:"Inter"},titleFont:{family:"Inter"}}}}})}function Et(){const e=Math.random();if(e<.3)return 2;if(e<.55)return 4;if(e<.7)return 1;if(e<.8)return 3;if(e<.85)return 8;const t=[.5,1.5,2.5,3.5,4.5,5,5.5,6,6.5,7,7.5];return t[Math.floor(Math.random()*t.length)]}function It(e,t,a){const n=qe.findIndex((t=>t.date===e)),s=parseFloat(t.toFixed(1));if(!(s<=CONFIG.ALLOCATION_PRECISION&&-1===n))if(-1!==n)qe[n].hours+=s,qe[n].endTime=ut(qe[n].startTime,qe[n].hours);else{const t={id:"ot-entry-"+Xe++,date:e,hours:s,type:a,startTime:"",endTime:"",isNew:!0};mt(t),qe.push(t)}}function Ot(){qe.sort(((e,t)=>{const a=new Date(e.date),n=new Date(t.date);return a-n!=0?a-n:parseInt(e.id.split("-")[2])-parseInt(t.id.split("-")[2])}));let e={};qe.forEach((t=>{t.startTime&&t.endTime?t.endTime=ut(t.startTime,t.hours):mt(t,e[t.date]||null),e[t.date]=t.endTime}))}function Dt(){Je=w.value;const e=CONFIG.WORKLOAD_PRESETS[Je];let t=`<strong>${Je} Details:</strong><ul class="list-disc list-inside ml-4">`;DISPLAYABLE_OT_TYPES.forEach((a=>{const n=e[a];n&&(t+=`<li>${a}: ${n.minHours.toFixed(1)} - ${n.maxHours.toFixed(1)} hours</li>`)})),t+="</ul>",b.innerHTML=t,C.textContent="This preset suggests daily OT hours for different day types to guide auto-allocation."}function St(){const e=st(),t=null!==e&&e>0;E.value=t?"Target-Driven":"Workload-Driven",Ke=E.value,E.disabled=!0,"Target-Driven"===Ke?(I.textContent='The calculator will allocate hours to reach your "Target OT Pay".',O.classList.remove("hidden"),x.classList.add("hidden"),b.classList.add("hidden"),wt()):(I.textContent='Hours will be allocated for all days in your range according to the "Workload Preset".',O.classList.add("hidden"),x.classList.remove("hidden"),b.classList.remove("hidden")),Lt()}function wt(){const e=D.value;let t="";"Balanced"===e?t="Randomly allocates hours across available days to meet the target.":"Fastest Path"===e?t="Prioritizes high-pay days (e.g., Public Holidays) to reach the target with minimum hours.":"Cheapest Path"===e&&(t="Prioritizes low-pay days (e.g., Weekdays) to maximize hours for the target."),S.textContent=t}function xt(){if(h._flatpickr){const e=Re.selectedDates,t=Mt(e[0]),a=Mt(e[1]);h._flatpickr.set("minDate",t),h._flatpickr.set("maxDate",a),h._flatpickr.redraw()}}function Ct(){const e=h.value,t=Re.selectedDates,a=t[0]?t[0].toISOString().split("T")[0]:"",n=t[1]?t[1].toISOString().split("T")[0]:"";if(!e)return void et("Please select a date for the public holiday.","error");if(!a||!n||new Date(e)<new Date(a)||new Date(e)>new Date(n))return void et("Public Holiday date must be within the OT Planning Date Range.","error");if(ze.includes(e))return void et(`${e} is already in the public holidays list.`,"warning");ze.push(e),ze.sort(),bt();const s=document.querySelector('.collapsible-header[data-target="publicHolidaysContent"]'),o=s?s.querySelector(".collapsible-icon"):null;Te.classList.contains("collapsed")&&zt(Te,o,!0),ft(),Lt(),et("Public Holiday added successfully!","success")}function bt(){L.innerHTML="",ze.length>0?ze.forEach((e=>{const t=document.createElement("li");t.classList.add("flex","justify-between","items-center","py-1"),t.innerHTML=`\n                        <span>${e}</span>\n                        <button type="button" class="text-red-500 hover:text-red-700 ml-4" data-date="${e}" aria-label="Remove public holiday ${e}">\n                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" /></svg>\n                        </button>\n                    `,L.appendChild(t),t.querySelector("button").addEventListener("click",(e=>{const t=e.currentTarget.dataset.date;Qe("Confirm Removal",`Are you sure you want to remove ${t} from public holidays?`,"confirm",(()=>{ze=ze.filter((e=>e!==t)),bt(),ft(),Lt(),et("Holiday Removed","success")}))}))})):L.innerHTML='<li class="text-gray-500">No public holidays added yet.</li>'}function Ft(e){return ze.includes(e)}function _t(){v.innerHTML="",DISPLAYABLE_OT_TYPES.forEach((e=>{const t=document.createElement("div");t.classList.add("input-group");const a=`multiplier-${e.replace(/[^0-9A-Za-z]/g,"")}`;t.innerHTML=`\n                        <label for="${a}">${e} Multiplier</label>\n                        <input type="number" id="${a}" value="${(CONFIG.OT_MULTIPLIERS[e]||0).toFixed(2)}" min="0" step="0.1" class="shadow-sm">\n                    `,v.appendChild(t),t.querySelector("input").addEventListener("input",Ve((t=>{const a=parseFloat(t.target.value);!isNaN(a)&&a>=0&&(CONFIG.OT_MULTIPLIERS[e]=a,Lt())}),150))}))}function Bt(){Qe("Confirm Reset Multipliers","Are you sure you want to reset all OT multipliers to their default values?","confirm",(()=>{Object.assign(CONFIG.OT_MULTIPLIERS,DEFAULT_OT_MULTIPLIERS),_t(),et("OT multipliers have been reset to their default values.","success"),Lt()}))}async function Ht(e){tt(),A.classList.remove("hidden"),A.setAttribute("aria-live","polite"),await Ze();try{const t=parseFloat(n.value),a=st(),{minHours:s,maxHours:o}=ot(),i=Re.selectedDates,r=i[0]?i[0].toISOString().split("T")[0]:"",l=i[1]?i[1].toISOString().split("T")[0]:"";if(isNaN(t)||t<=0||!r||!l||new Date(r)>new Date(l)||!it())return void et("Please ensure all settings (Salary, Date Range, Hour Limits) are valid.","error");let d=0,c=0;const u={};if(e)yt();else{const e=new Date(r),a=new Date(l);qe=qe.filter((t=>{const n=new Date(t.date);return n>=e&&n<=a})),qe.forEach((e=>{const a=parseFloat(e.hours);!isNaN(a)&&a>0&&(d+=lt(rt(t),a,e.type,e.date),c+=a,u[e.date]=(u[e.date]||0)+a)}))}if(null!==o&&c>=o-CONFIG.ALLOCATION_PRECISION)return et(`Max Total OT Hours (${o.toFixed(1)}h) already met.`,"warning"),void Lt();const m=rt(t),y=((e,t)=>{const a=[];let n=new Date(e);const s=new Date(t);for(;n<=s;)a.push({date:n.toISOString().split("T")[0],dayOfWeek:n.getDay()}),n.setDate(n.getDate()+1);return a})(r,l),g={workingDay:Fe.checked,offDay:_e.checked,restDay:Be.checked,publicHoliday:He.checked},f=()=>y.filter((e=>{if((u[e.date]||0)>=CONFIG.MAX_DAILY_OT_HOURS)return!1;const t=Ft(e.date);if(t&&g.publicHoliday)return!0;if(!t){if(e.dayOfWeek>=1&&e.dayOfWeek<=5&&g.workingDay)return!0;if(6===e.dayOfWeek&&g.offDay)return!0;if(0===e.dayOfWeek&&g.restDay)return!0}return!1}));if("Target-Driven"===Ke){if(null===a||a<=0)return void et("Please enter a valid Target OT Pay (> RM0) for Target-Driven allocation.","error");let e=a-d;e<=CONFIG.ALLOCATION_PRECISION&&et("Target OT pay has already been met with existing entries.","info");const t=D.value;let n=f();"Balanced"===t?n=n.sort((()=>Math.random()-.5)):n.sort(((e,a)=>{const n=CONFIG.OT_MULTIPLIERS[gt(e.date)],s=CONFIG.OT_MULTIPLIERS[gt(a.date)];return"Fastest Path"===t?s-n:n-s}));let s=0;const i=20*n.length;for(;e>CONFIG.ALLOCATION_PRECISION&&s<i&&n.length>0;){s++;let i="Balanced"===t?Math.floor(Math.random()*n.length):0;const r=n[i],l=u[r.date]||0;let y=CONFIG.MAX_DAILY_OT_HOURS-l;if(null!==o&&(y=Math.min(y,o-c)),y<=0){n.splice(i,1);continue}let g=Et();g=Math.min(g,y);let f=gt(r.date),h=lt(m,l+g,f,r.date)-lt(m,l,f,r.date);for(;g>.5&&h>e;)g-=.5,h=lt(m,l+g,f,r.date)-lt(m,l,f,r.date);h<=e&&g>0&&(It(r.date,g,f),d+=h,c+=g,u[r.date]=(u[r.date]||0)+g,e=a-d),"Balanced"!==t&&n.shift(),await Ze()}if(d<a-CONFIG.ALLOCATION_PRECISION){et(`Target was not fully met (${dt(d)}). Topping up...`,"warning"),await Ze();let e=f().filter((e=>(u[e.date]||0)<CONFIG.MAX_DAILY_OT_HOURS));e.sort(((e,t)=>CONFIG.OT_MULTIPLIERS[gt(e.date)]-CONFIG.OT_MULTIPLIERS[gt(t.date)]));let t=0;const n=10*e.length;for(;d<a&&t<n&&e.length>0;){t++;const a=e[0],n=u[a.date]||0;if(CONFIG.MAX_DAILY_OT_HOURS-n<=0){e.shift();continue}const s=.5,o=lt(m,n+s,gt(a.date),a.date)-lt(m,n,gt(a.date),a.date);It(a.date,s,gt(a.date)),d+=o,c+=s,u[a.date]=(u[a.date]||0)+s,e.push(e.shift()),await Ze()}}else et("Overtime hours allocated to meet your target.","success")}else if("Workload-Driven"===Ke){const e=CONFIG.WORKLOAD_PRESETS[Je];let t=f().sort((()=>Math.random()-.5));for(const a of t){if(null!==o&&c>=o-CONFIG.ALLOCATION_PRECISION){et(`Max Total OT Hours (${o.toFixed(1)}h) reached.`,"info");break}const t=u[a.date]||0,n=CONFIG.MAX_DAILY_OT_HOURS-t,s=gt(a.date),i=e[s];if(!i||n<=0)continue;let r=Et();r=Math.min(r,n,i.maxHours),null!==o&&(r=Math.min(r,o-c)),r>CONFIG.ALLOCATION_PRECISION&&(It(a.date,r,s),c+=r,u[a.date]=(u[a.date]||0)+r),await Ze()}et("Overtime hours allocated based on workload preset.","success")}if(null!==s&&c<s){et(`Topping up hours to meet minimum of ${s}h...`,"info"),await Ze();let e=f().filter((e=>(u[e.date]||0)<CONFIG.MAX_DAILY_OT_HOURS));e.sort(((e,t)=>CONFIG.OT_MULTIPLIERS[gt(e.date)]-CONFIG.OT_MULTIPLIERS[gt(t.date)]));let t=0;const a=10*e.length;for(;c<s&&t<a&&e.length>0;){t++;const a=e[0],n=u[a.date]||0;if(CONFIG.MAX_DAILY_OT_HOURS-n<=0){e.shift();continue}const s=.5;It(a.date,s,gt(a.date)),c+=s,u[a.date]=(u[a.date]||0)+s,e.push(e.shift()),await Ze()}c<s&&et(`Could not meet minimum hour target. Reached ${c.toFixed(1)}h.`,"warning")}Ot(),qe.forEach((e=>delete e.isNew)),await ft(),Lt()}catch(e){console.error("Error during auto-allocation:",e),et("An error occurred during auto-allocation. Please check console.","error")}finally{at(),A.classList.add("hidden"),A.removeAttribute("aria-live")}}function At(){try{const e=parseFloat(n.value),t=st(),{minHours:a,maxHours:s}=ot(),o=Re.selectedDates,i=o[0]?o[0].toISOString().split("T")[0]:"",r=o[1]?o[1].toISOString().split("T")[0]:"",l=rt(e);let d="--- OT Calculation Summary ---\n\n";d+="Employee Settings:\n",d+=`  Basic Monthly Salary: ${dt(e)}\n`,d+=`  Hourly Rate: RM ${l.toFixed(2)}/hour\n\n`,d+=`OT Planning Period: ${i} to ${r}\n`,d+=`Allocation Strategy: ${Ke}\n`,d+=`Target OT Pay: ${null===t?"N/A":dt(t)}\n`,d+=`Total OT Hours Range: ${null!==a&&null!==s?`${a.toFixed(1)}h - ${s.toFixed(1)}h`:null!==a?`Min: ${a.toFixed(1)}h`:null!==s?`Max: ${s.toFixed(1)}h`:"N/A"}\n\n`,d+="OT Multipliers Used:\n";for(const e in CONFIG.OT_MULTIPLIERS)d+=`  ${e}: ${CONFIG.OT_MULTIPLIERS[e].toFixed(2)}x\n`;d+="\n";const c={},u=qe.filter((e=>{const t=new Date(e.date),a=i?new Date(i):null,n=r?new Date(r):null;return!(a&&n&&(t.setHours(0,0,0,0),a.setHours(0,0,0,0),n.setHours(0,0,0,0),t<a||t>n))}));u.forEach((e=>{const t=gt(e.date);(c[t]=c[t]||[]).push(e)})),d+="Daily OT Entries:\n",0===u.length?d+="  No entries recorded for the selected range.\n":DISPLAYABLE_OT_TYPES.forEach((e=>{c[e]&&c[e].length>0&&(d+=`\n--- ${e} ---\n`,c[e].sort(((e,t)=>new Date(e.date)-new Date(t.date))),c[e].forEach((e=>{d+=`  Date: ${e.date}, Hours: ${e.hours.toFixed(1)}h, Type: ${e.type}`,Ft(e.date)&&(d+=" (Public Holiday)"),e.startTime&&e.endTime&&(d+=`, Time: ${e.startTime} - ${e.endTime}`),d+="\n"})))})),d+="\n";let m={},y={},g=0,f=0;DISPLAYABLE_OT_TYPES.forEach((e=>{m[e]=0,y[e]=0})),u.forEach((e=>{const t=parseFloat(e.hours);if(isNaN(t)||t<=0)return;const a=gt(e.date),n=lt(l,t,e.type,e.date);m[a]+=t,y[a]+=n,g+=n,f+=t}));const h=e+g;d+="Total OT Hours by Type:\n";let p=[];DISPLAYABLE_OT_TYPES.forEach((e=>{m[e]>0&&p.push(`${e}: ${m[e].toFixed(1)}h`)})),d+=`  ${p.join(", ")}\n\n`,d+="Total Pay per OT Category:\n";let L=[];DISPLAYABLE_OT_TYPES.forEach((e=>{y[e]>0&&(y[e]=parseFloat(y[e].toFixed(2)),L.push(`${e}: ${dt(y[e])}`))})),d+=`  ${L.join(", ")}\n\n`,d+=`Combined OT Pay: ${dt(g)}\n`;const v=g-(null===t?0:t);d+=`Difference from Target: ${null===t?"N/A (No target set)":dt(v)}\n`,d+=`Total Monthly OT Hours: ${f.toFixed(1)} hours\n`,d+=`Expected Salary Pay (Calculated): ${dt(h)}\n\n`,d+="--- End of Summary ---";const T=new Blob([d],{type:"text/plain;charset=utf-8"}),E=URL.createObjectURL(T),I=document.createElement("a");I.href=E,I.download="ot_summary.txt",document.body.appendChild(I),I.click(),et("Your OT summary is being downloaded.","info"),setTimeout((()=>{document.body.removeChild(I),URL.revokeObjectURL(E)}),250)}catch(e){console.error("Error during export summary:",e),et("Failed to export summary. Please check your browser console for details.","error")}}async function Pt(){if(je)if(We&&a){tt(),nt(Oe,"Saving...","loading");try{const t="undefined"!=typeof __app_id?__app_id:"default-app-id",s=doc(e,`artifacts/${t}/users/${a}/ot_calculator_data`,"user_data"),o=qe.map((e=>{const t={...e};return delete t.isNew,t})),{minHours:i,maxHours:r}=ot(),l={basicSalary:parseFloat(n.value),targetOTPay:st(),minTotalOTHours:i,maxTotalOTHours:r,startDate:Re.selectedDates[0]?Re.selectedDates[0].toISOString().split("T")[0]:"",endDate:Re.selectedDates[1]?Re.selectedDates[1].toISOString().split("T")[0]:"",workloadPreset:w.value,allocationStrategy:E.value,targetAllocationStrategy:D.value,otEntries:JSON.stringify(o),publicHolidays:JSON.stringify(ze),customMultipliers:JSON.stringify(CONFIG.OT_MULTIPLIERS),allocateWorkingDay:Fe.checked,allocateOffDay:_e.checked,allocateRestDay:Be.checked,allocatePublicHoliday:He.checked};await setDoc(s,l),qe=o,ft(),nt(Oe,"Saved!","success"),et("Data saved successfully!","success")}catch(e){console.error("Error saving document: ",e),nt(Oe,"Save Failed!","error"),et("Failed to save data. Please try again.","error")}finally{at()}}else et("Firebase authentication not ready. Please try again in a moment.","error");else et("Firebase functions (Save/Load) are currently disabled. Please enable them to use this feature.","warning")}async function Nt(t=!1){if(je)if(We&&a){t||(tt(),nt(De,"Loading...","loading"));try{const s="undefined"!=typeof __app_id?__app_id:"default-app-id",d=doc(e,`artifacts/${s}/users/${a}/ot_calculator_data`,"user_data"),u=await getDoc(d);if(u.exists()){const e=u.data();n.value=parseFloat(e.basicSalary);const a=e.targetOTPay;if(null===a?(o.value="",i.classList.add("hidden"),r.classList.add("hidden"),i.value=""):PREDEFINED_TARGET_PAYS.includes(a)?(o.value=a.toFixed(2),i.classList.add("hidden"),r.classList.add("hidden"),i.value=""):(o.value="custom",i.classList.remove("hidden"),r.classList.remove("hidden"),i.value=a.toFixed(2)),l.value=null!==e.minTotalOTHours?e.minTotalOTHours:"",c.value=null!==e.maxTotalOTHours?e.maxTotalOTHours:"",e.startDate&&e.endDate?Re.setDate([e.startDate,e.endDate],!0):Re.clear(),w.value=e.workloadPreset||"Moderate Workload",E.value=e.allocationStrategy||"Target-Driven",D.value=e.targetAllocationStrategy||"Balanced",qe=JSON.parse(e.otEntries||"[]"),ze=JSON.parse(e.publicHolidays||"[]"),Object.assign(CONFIG.OT_MULTIPLIERS,JSON.parse(e.customMultipliers||"{}")),Object.assign(CONFIG.OT_MULTIPLIERS,{...DEFAULT_OT_MULTIPLIERS,...CONFIG.OT_MULTIPLIERS}),Fe.checked=void 0===e.allocateWorkingDay||e.allocateWorkingDay,_e.checked=void 0===e.allocateOffDay||e.allocateOffDay,Be.checked=void 0===e.allocateRestDay||e.allocateRestDay,He.checked=void 0===e.allocatePublicHoliday||e.allocatePublicHoliday,Xe=qe.length>0?Math.max(...qe.map((e=>parseInt(e.id.split("-")[2]))))+1:0,Ot(),await ft(),bt(),ze.length>0){const e=document.querySelector('.collapsible-header[data-target="publicHolidaysContent"]'),t=e?e.querySelector(".collapsible-icon"):null;zt(Te,t,!0)}_t(),Lt(),t||(nt(De,"Loaded!","success"),et("Data loaded successfully!","success"))}else{const e=new Date,a=new Date(e.getFullYear(),e.getMonth(),1),s=new Date(e.getFullYear(),e.getMonth()+1,0);Re.setDate([a,s],!0),n.value="3700.00",w.value="Moderate Workload",E.value="Target-Driven",o.value="",i.classList.add("hidden"),r.classList.add("hidden"),l.value="",c.value="",Fe.checked=!0,_e.checked=!0,Be.checked=!0,He.checked=!0,bt(),_t(),await ft(),Lt(),t||nt(De,"No saved data found.","info")}}catch(e){console.error("Error loading document: ",e),t||(nt(De,"Load Failed!","error"),et("Failed to load data. Please try again.","error"))}finally{Dt(),St(),t||at()}}else t||et("Firebase authentication not ready. Please try again in a moment.","error");else t||et("Firebase functions (Save/Load) are currently disabled. Please enable them to use this feature.","warning")}function Mt(e){return e?`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`:""}function $t(){const e=Re.selectedDates,t=Mt(e[0]),a=Mt(e[1]);if(!t||!a||new Date(t)>new Date(a))return void et('Please set a valid "OT Planning Date Range" before adding a manual entry.',"error");ie.textContent="",le.textContent="",ce.textContent="",oe.classList.remove("input-error"),re.classList.remove("input-error"),de.classList.remove("input-error");const n=[];let s=new Date(t);const o=new Date(a);for(;s.getTime()<=o.getTime();)n.push(Mt(s)),s.setDate(s.getDate()+1);const i=n.filter((e=>!qe.some((t=>t.date===e))));let r=null;r=i.length>0?i[0]:t||ct(),Ye?(Ye.set("minDate",t),Ye.set("maxDate",a),Ye.set("disable",qe.map((e=>e.date))),Ye.setDate(r),Ye.redraw()):Ye=window.flatpickr(oe,{dateFormat:"Y-m-d",minDate:t,maxDate:a,disable:qe.map((e=>e.date)),defaultDate:r,onChange:function(e,t,a){ie.textContent="",oe.classList.remove("input-error");const n=e[0];if(n){const e=Re.selectedDates,t=e[0]?new Date(e[0].toISOString().split("T")[0]):null,s=e[1]?new Date(e[1].toISOString().split("T")[0]):null;t&&s&&(n<t||n>s)&&(ie.textContent="Date must be within range.",oe.classList.add("input-error"),a.clear(),oe.value="",et("Selected date is outside the planning range and has been cleared.","error"))}}}),oe.value=r||"",Ue?Ue.setDate("18:00",!1):Ue=window.flatpickr(de,{enableTime:!0,noCalendar:!0,dateFormat:"H:i",time_24hr:!0,defaultHour:18,defaultMinute:0,minuteIncrement:15,onChange:function(e,t,a){ce.textContent="",de.classList.remove("input-error"),Rt()}}),re.value="2.0",Rt(),ne.classList.remove("hidden"),ne.classList.add("show"),window.lastFocusedElement=document.activeElement,oe.focus()}function kt(){ne.classList.add("hidden"),ne.classList.remove("show"),window.lastFocusedElement&&window.lastFocusedElement.focus()}function Rt(){const e=de.value,t=parseFloat(re.value);e&&!isNaN(t)&&t>0?ue.value=ut(e,t):ue.value=""}function Yt(){const e=oe.value,t=parseFloat(re.value),a=de.value,n=ue.value;ie.textContent="",le.textContent="",ce.textContent="",oe.classList.remove("input-error"),re.classList.remove("input-error"),de.classList.remove("input-error");let s=!0;e||(ie.textContent="Please select a date.",oe.classList.add("input-error"),s=!1),isNaN(t)||t<=0?(le.textContent="Hours must be a positive number.",re.classList.add("input-error"),s=!1):t>CONFIG.MAX_DAILY_OT_HOURS&&(le.textContent=`Max hours per day is ${CONFIG.MAX_DAILY_OT_HOURS}.`,re.classList.add("input-error"),s=!1),a||(ce.textContent="Please set a start time.",de.classList.add("input-error"),s=!1);const o=Re.selectedDates,i=Mt(o[0]),r=Mt(o[1]),l=new Date(e).setHours(0,0,0,0),d=new Date(i).setHours(0,0,0,0),c=new Date(r).setHours(0,0,0,0);if((l<d||l>c)&&(ie.textContent=`Date must be within ${i} and ${r}.`,oe.classList.add("input-error"),s=!1),qe.some((t=>t.date===e))&&(ie.textContent=`An OT entry already exists for ${e}.`,oe.classList.add("input-error"),s=!1),s){const s={id:"ot-entry-"+Xe++,date:e,hours:t,type:gt(e),startTime:a,endTime:n,isNew:!0};qe.push(s),ft(),Lt(),setTimeout((()=>{const e=F.querySelector(`[data-id="${s.id}"]`);e&&e.scrollIntoView({behavior:"smooth",block:"center"})}),100),kt(),et(`New OT entry added for ${e} (${t}h, ${a}-${n}).`,"success")}}function Ut(){ge.classList.remove("hidden"),ge.classList.add("show"),window.lastFocusedElement=document.activeElement,fe.focus()}function Gt(){ge.classList.add("hidden"),ge.classList.remove("show"),window.lastFocusedElement&&window.lastFocusedElement.focus()}async function Wt(){if(!je)return we.textContent="Firebase (Save/Load) is currently disabled.",void J.classList.add("hidden");we.textContent="Initializing Firebase...";try{const n="undefined"!=typeof __firebase_config?__firebase_config:"{}",s=JSON.parse(n);if(0===Object.keys(s).length)throw new Error("Firebase configuration is empty or invalid.");const o=initializeApp(s);e=getFirestore(o),t=getAuth(o),onAuthStateChanged(t,(async e=>{if(e)a=e.uid,We=!0,J.textContent=`User ID: ${a}`,J.classList.remove("hidden"),we.textContent="Firebase enabled and connected.",await Nt(!0);else try{const e=await signInAnonymously(t);a=e.user.uid,We=!0,J.textContent=`User ID: ${a}`,J.classList.remove("hidden"),we.textContent="Firebase enabled and connected (anonymous).",await Nt(!0)}catch(e){console.error("Anonymous sign-in failed:",e),we.textContent="Firebase connection failed. Check console.",et("Failed to sign in. Data saving/loading may not work.","error")}jt()}))}catch(e){console.error("Firebase initialization failed:",e),we.textContent=`Firebase init failed: ${e.message}.`,et(`Firebase could not be initialized: ${e.message||"Unknown error"}.`,"error"),je=!1,Se.checked=!1,localStorage.setItem("isFirebaseEnabled","false"),jt(),J.classList.add("hidden")}}function jt(){const e=!je||!We;M.disabled=e,$.disabled=e}async function qt(){je=Se.checked,localStorage.setItem("isFirebaseEnabled",je),je?await Wt():(e=null,t=null,a=null,We=!1,J.classList.add("hidden"),we.textContent="Firebase (Save/Load) is now disabled."),jt()}function zt(e,t,a=!1){a||e.classList.contains("collapsed")?(e.style.maxHeight=e.scrollHeight+"px",e.classList.remove("collapsed"),t&&t.classList.add("rotated"),e.addEventListener("transitionend",(function t(){e.style.maxHeight="none",e.removeEventListener("transitionend",t)}),{once:!0})):(e.style.maxHeight=e.scrollHeight+"px",e.offsetWidth,e.classList.add("collapsed"),t&&t.classList.remove("rotated"),e.addEventListener("transitionend",(function t(){e.classList.contains("collapsed")&&(e.style.maxHeight="0"),e.removeEventListener("transitionend",t)}),{once:!0}))}function Xt(){n.addEventListener("input",Ve(Lt,150)),i.addEventListener("input",Ve((()=>{St()}),150)),l.addEventListener("input",Ve((()=>{it(),Lt()}),150)),c.addEventListener("input",Ve((()=>{it(),Lt()}),150)),Re=window.flatpickr(y,{mode:"range",dateFormat:"Y-m-d",onChange:function(e,t,a){Lt(),function(){if(Ye){const e=Re.selectedDates,t=Mt(e[0]),a=Mt(e[1]);let n=null;const s=[];if(t&&a){let e=new Date(t);const n=new Date(a);for(;e.getTime()<=n.getTime();)s.push(Mt(e)),e.setDate(e.getDate()+1)}const o=s.filter((e=>!qe.some((t=>t.date===e))));n=o.length>0?o[0]:t||ct(),Ye.set("minDate",t),Ye.set("maxDate",a),Ye.set("disable",qe.map((e=>e.date))),Ye.setDate(n),Ye.redraw(),oe.value=n||""}}(),xt(),g.textContent="",y.classList.remove("input-error")}}),f.addEventListener("click",(()=>{const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),1),a=new Date(e.getFullYear(),e.getMonth()+1,0);Re.setDate([t,a],!0),et("Date range set to current month.","info")})),H.addEventListener("click",Ut),fe.addEventListener("click",(()=>{Gt(),Ht(!0)})),he.addEventListener("click",(()=>{Gt(),Ht(!1)})),pe.addEventListener("click",Gt),P.addEventListener("click",(()=>{Qe("Confirm Reset & Re-allocate","Are you sure you want to clear ALL existing OT entries and re-allocate from scratch? This action cannot be undone.","confirm",(()=>Ht(!0)))})),N.addEventListener("click",pt),X.addEventListener("click",At),M.addEventListener("click",Pt),$.addEventListener("click",(()=>Nt(!1))),w.addEventListener("change",Dt),D.addEventListener("change",wt),p.addEventListener("click",Ct),T.addEventListener("click",Bt),o.addEventListener("change",(()=>{"custom"===o.value?(i.classList.remove("hidden"),r.classList.remove("hidden"),i.focus()):(i.classList.add("hidden"),r.classList.add("hidden"),i.value=""),St()})),s.addEventListener("click",(()=>{n.value="",Lt(),et("Basic Salary cleared.","info")})),r.addEventListener("click",(()=>{i.value="",St(),et("Custom Target OT Pay cleared.","info")})),d.addEventListener("click",(()=>{l.value="",it(),Lt(),et("Min Total OT Hours cleared.","info")})),u.addEventListener("click",(()=>{c.value="",it(),Lt(),et("Max Total OT Hours cleared.","info")})),window.flatpickr(h,{dateFormat:"Y-m-d"}),Le.addEventListener("click",(()=>{h.value=ct(),h._flatpickr&&h._flatpickr.setDate(h.value,!0),et("Public Holiday date set to today.","info")})),ve.forEach((e=>{e.addEventListener("click",(()=>{const t=e.dataset.target;zt(document.getElementById(t),e.querySelector(".collapsible-icon"))}))})),B.addEventListener("click",$t),me.addEventListener("click",Yt),ye.addEventListener("click",kt),re.addEventListener("input",Rt),de.addEventListener("input",Rt),Se.addEventListener("change",qt),[Fe,_e,Be,He].forEach((e=>{e.addEventListener("change",Lt)}))}document.addEventListener("DOMContentLoaded",(async()=>{n=document.getElementById("basicSalary"),s=n.nextElementSibling,o=document.getElementById("targetOTPaySelect"),i=document.getElementById("customTargetOTPayInput"),r=document.getElementById("clearCustomTargetOTPayBtn"),l=document.getElementById("minTotalOTHours"),d=document.getElementById("clearMinTotalOTHoursBtn"),c=document.getElementById("maxTotalOTHours"),u=document.getElementById("clearMaxTotalOTHoursBtn"),m=document.getElementById("minMaxHoursError"),y=document.getElementById("dateRangeInput"),g=document.getElementById("dateRangeError"),f=document.getElementById("setThisMonthBtn"),h=document.getElementById("publicHolidayDate"),p=document.getElementById("addPublicHolidayDateBtn"),L=document.getElementById("publicHolidaysList"),v=document.getElementById("otMultiplierInputs"),T=document.getElementById("resetMultipliersBtn"),E=document.getElementById("allocationStrategy"),I=document.getElementById("allocationStrategyDescription"),O=document.getElementById("targetDrivenStrategyGroup"),D=document.getElementById("targetAllocationStrategy"),S=document.getElementById("targetAllocationStrategyDescription"),w=document.getElementById("workloadPreset"),x=document.getElementById("workloadPresetGroup"),C=document.getElementById("workloadPresetDescription"),b=document.getElementById("workloadPresetDetails"),F=document.getElementById("otEntriesContainer"),_=document.getElementById("noEntriesMessage"),B=document.getElementById("addOTEntryBtn"),H=document.getElementById("autoAllocateBtn"),A=document.getElementById("autoAllocateLoading"),P=document.getElementById("resetAndReallocateBtn"),N=document.getElementById("clearAllEntriesBtn"),M=document.getElementById("saveDataBtn"),$=document.getElementById("loadDataBtn"),k=document.getElementById("results"),R=document.getElementById("totalHoursByType"),Y=document.getElementById("totalPayByCategory"),U=document.getElementById("combinedOTPay"),G=document.getElementById("targetOTPayDisplay"),W=document.getElementById("differenceFromTarget"),j=document.getElementById("totalMonthlyOTHoursDisplay"),q=document.getElementById("totalOTHoursRangeDisplay"),z=document.getElementById("expectedSalaryPayDisplay"),X=document.getElementById("exportSummaryBtn"),J=document.getElementById("userIdDisplay"),K=document.getElementById("allocationStrategySummary"),V=document.getElementById("messageBox"),Z=document.getElementById("messageBoxTitle"),Q=document.getElementById("messageBoxContent"),ee=document.getElementById("messageBoxCloseBtn"),te=document.getElementById("messageBoxConfirmBtn"),ae=document.getElementById("messageBoxCancelBtn"),ne=document.getElementById("addDetailedOTEntryModal"),se=document.getElementById("detailedEntryModalTitle"),oe=document.getElementById("detailedEntryDate"),ie=document.getElementById("detailedEntryDateError"),re=document.getElementById("detailedEntryHours"),le=document.getElementById("detailedEntryHoursError"),de=document.getElementById("detailedEntryStartTime"),ce=document.getElementById("detailedEntryStartTimeError"),ue=document.getElementById("detailedEntryEndTime"),me=document.getElementById("confirmDetailedEntryBtn"),ye=document.getElementById("cancelDetailedEntryBtn"),ge=document.getElementById("allocationChoiceModal"),fe=document.getElementById("clearAndAllocateBtn"),he=document.getElementById("fillRemainingBtn"),pe=document.getElementById("cancelAllocationChoiceBtn"),Le=document.getElementById("setPublicHolidayTodayBtn"),ve=document.querySelectorAll(".collapsible-header"),Te=document.getElementById("publicHolidaysContent"),Ee=document.getElementById("otMultiplierContent"),Ie=document.getElementById("howToUseContent"),Oe=document.getElementById("saveDataStatus"),De=document.getElementById("loadDataStatus"),Se=document.getElementById("firebaseToggle"),we=document.getElementById("firebaseStatusMessage"),xe=document.getElementById("loadingOverlay"),Ce=document.getElementById("toastContainer"),be=document.getElementById("chartPlaceholder"),Fe=document.getElementById("allocateWorkingDay"),_e=document.getElementById("allocateOffDay"),Be=document.getElementById("allocateRestDay"),He=document.getElementById("allocatePublicHoliday"),Ae=document.getElementById("payProgressContainer"),Pe=document.getElementById("payPercentage"),Ne=document.getElementById("payProgressBar"),Me=document.getElementById("hoursProgressContainer"),$e=document.getElementById("hoursPercentage"),ke=document.getElementById("hoursProgressBar"),Se.checked=je,await Wt(),jt(),Xt(),function(){const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),1),a=new Date(e.getFullYear(),e.getMonth()+1,0);Re.setDate([t,a],!0),o.innerHTML='<option value="">No Target</option>',PREDEFINED_TARGET_PAYS.forEach((e=>{const t=document.createElement("option");t.value=e.toFixed(2),t.textContent=`RM ${e.toFixed(2)}`,o.appendChild(t)}));const n=document.createElement("option");n.value="custom",n.textContent="Other (Enter Manually)",o.appendChild(n),_t(),Ie.classList.add("collapsed"),Te.classList.add("collapsed"),Ee.classList.add("collapsed"),St(),Dt(),xt()}()}))})()</script>
</body>
</html>
