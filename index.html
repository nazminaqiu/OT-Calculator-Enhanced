<!doctype html>
<html lang=en>
<head>
<meta charset=UTF-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>Enhanced OT Calculator</title>
<script src=https://cdn.tailwindcss.com></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css>
<script src=https://cdn.jsdelivr.net/npm/flatpickr></script>
<script src=https://cdn.jsdelivr.net/npm/chart.js></script>
<style>:root{--primary-indigo:#6366f1;--dark-indigo:#4f46e5;--light-indigo:#e0e7ff;--lightest-indigo:#c7d2fe;--danger-red:#ef4444;--dark-red:#dc2626;--success-green:#10b981;--info-blue:#3b82f6;--warning-orange:#f59e0b;--gray-900:#1f2937;--gray-800:#374151;--gray-700:#4b5563;--gray-600:#6b7280;--gray-500:#9ca3af;--gray-400:#d1d5db;--gray-300:#e5e7eb;--gray-200:#f3f4f6;--gray-100:#f9fafb;--gray-50:#f9fafb}body{font-family:Inter,sans-serif;background-color:var(--gray-200);display:flex;justify-content:center;align-items:flex-start;min-height:100vh;padding:20px;box-sizing:border-box}.main-wrapper{display:flex;flex-direction:column;gap:25px;max-width:1200px;width:100%}@media (min-width:1024px){.main-wrapper{flex-direction:row;align-items:flex-start}}.form-content{background-color:#fff;padding:30px;border-radius:15px;box-shadow:0 10px 25px rgba(0,0,0,.1);flex-grow:1;width:100%}@media (min-width:1024px){.form-content{min-width:600px}}.summary-sidebar{background-color:#fff;padding:25px;border-radius:15px;box-shadow:0 10px 25px rgba(0,0,0,.1);position:sticky;top:20px;align-self:flex-start;width:100%;min-width:300px;flex-shrink:0}@media (min-width:1024px){.summary-sidebar{width:350px}}.input-group label{font-weight:600;color:var(--gray-800);margin-bottom:8px;display:block}.input-group input,.input-group select{width:100%;padding:12px;border:1px solid var(--gray-400);border-radius:8px;font-size:1rem;color:var(--gray-700);transition:border-color .2s ease-in-out,box-shadow .2s ease-in-out}.input-group input:focus,.input-group select:focus{outline:0;border-color:var(--primary-indigo);box-shadow:0 0 0 3px rgba(99,102,241,.2)}.input-group select:disabled{background-color:var(--gray-200);cursor:not-allowed}.btn{padding:12px 20px;border-radius:8px;font-weight:600;cursor:pointer;transition:background-color .2s ease-in-out,transform .1s ease-in-out;display:inline-flex;align-items:center;justify-content:center;gap:8px}.btn-primary{background-color:var(--primary-indigo);color:#fff}.btn-primary:hover{background-color:var(--dark-indigo);transform:translateY(-1px)}.btn-secondary{background-color:var(--light-indigo);color:var(--dark-indigo)}.btn-secondary:hover{background-color:var(--lightest-indigo);transform:translateY(-1px)}.btn-danger{background-color:var(--danger-red);color:#fff}.btn-danger:hover{background-color:var(--dark-red);transform:translateY(-1px)}.results-section h3{font-size:1.5rem;font-weight:700;color:var(--gray-900);margin-bottom:15px}.results-section p{font-size:1.1rem;margin-bottom:8px;color:var(--gray-800)}.results-section p strong{color:var(--gray-900)}.message-box{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background-color:#fff;padding:30px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.2);z-index:1000;text-align:center;min-width:300px;max-width:90%;border:1px solid var(--gray-400);opacity:0;transform:translate(-50%,-50%) scale(.9);transition:opacity .3s ease-out,transform .3s ease-out}.message-box.show{opacity:1;transform:translate(-50%,-50%) scale(1)}.message-box h4{font-size:1.5rem;font-weight:700;color:var(--gray-900);margin-bottom:15px}.message-box p{font-size:1.1rem;color:var(--gray-700);margin-bottom:25px}.message-box-buttons{display:flex;justify-content:center;gap:15px}.message-box button{background-color:var(--primary-indigo);color:#fff;padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer;transition:background-color .2s ease-in-out}.message-box button:hover{background-color:var(--dark-indigo)}.message-box .btn-cancel{background-color:var(--gray-300);color:var(--gray-700)}.message-box .btn-cancel:hover{background-color:var(--gray-400)}.manual-entry-modal{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);display:flex;justify-content:center;align-items:center;z-index:1000;opacity:0;transition:opacity .3s ease-out}.manual-entry-modal.show{opacity:1}.manual-entry-modal-content{background-color:#fff;padding:30px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.2);text-align:center;min-width:350px;max-width:90%;border:1px solid var(--gray-400);transform:scale(.9);transition:transform .3s ease-out}.manual-entry-modal.show .manual-entry-modal-content{transform:scale(1)}.manual-entry-modal-content h4{font-size:1.5rem;font-weight:700;color:var(--gray-900);margin-bottom:15px}.manual-entry-modal-content .input-group{margin-bottom:20px}.manual-entry-modal-content .modal-buttons{display:flex;justify-content:center;gap:15px}@media (max-width:768px){.form-content,.summary-sidebar{padding:20px}}.loading-indicator{margin-left:10px;font-size:.9em;color:var(--primary-indigo);font-weight:500}#userIdDisplay{font-size:.8em;color:var(--gray-600);text-align:right;margin-top:-15px;margin-bottom:15px;word-break:break-all}.summary-inline-group{display:flex;flex-wrap:wrap;gap:10px;font-size:1rem;color:var(--gray-800);margin-bottom:8px}.summary-inline-group strong{display:block;width:100%;margin-bottom:4px}.summary-inline-item{display:inline-block;padding:4px 8px;background-color:var(--light-indigo);border-radius:6px;color:var(--dark-indigo);font-weight:500}.collapsible-header{display:flex;justify-content:space-between;align-items:center;cursor:pointer;padding:10px 0;border-bottom:1px solid #cbd5e0;margin-bottom:15px}.collapsible-header h3{margin-bottom:0}.collapsible-content{overflow:hidden;transition:max-height .3s ease-out}.collapsible-content.collapsed{max-height:0!important}.collapsible-icon{transition:transform .3s ease-out}.collapsible-icon.rotated{transform:rotate(90deg)}.input-error{border-color:var(--danger-red);box-shadow:0 0 0 3px rgba(239,68,68,.2)}.error-message{color:var(--danger-red);font-size:.85rem;margin-top:4px}.status-message{margin-left:10px;font-size:.9em;font-weight:500;opacity:0;transition:opacity .3s ease-in-out}.status-message.show{opacity:1}.status-message.loading{color:var(--primary-indigo)}.status-message.success{color:var(--success-green)}.status-message.error{color:var(--danger-red)}.input-with-clear{position:relative;display:flex;align-items:center}.input-with-clear input{padding-right:36px}.clear-input-btn{position:absolute;right:8px;background:0 0;border:none;cursor:pointer;color:var(--gray-500);padding:4px;border-radius:50%;transition:background-color .2s ease-in-out,color .2s ease-in-out;display:flex;align-items:center;justify-content:center}.clear-input-btn:hover{background-color:var(--gray-300);color:var(--gray-700)}.allocation-choice-modal .modal-buttons button{width:100%}.allocation-choice-modal .modal-buttons{flex-direction:column}.toggle-switch{position:relative;display:inline-block;width:60px;height:34px}.toggle-switch input{opacity:0;width:0;height:0}.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;-webkit-transition:.4s;transition:.4s;border-radius:34px}.slider:before{position:absolute;content:"";height:26px;width:26px;left:4px;bottom:4px;background-color:#fff;-webkit-transition:.4s;transition:.4s;border-radius:50%}input:checked+.slider{background-color:var(--primary-indigo)}input:focus+.slider{box-shadow:0 0 1px var(--primary-indigo)}input:checked+.slider:before{-webkit-transform:translateX(26px);-ms-transform:translateX(26px);transform:translateX(26px)}#toastContainer{position:fixed;bottom:1rem;right:1rem;z-index:2000;display:flex;flex-direction:column;gap:.5rem;max-width:300px}.toast{background-color:#333;color:#fff;padding:.75rem 1rem;border-radius:.5rem;box-shadow:0 4px 12px rgba(0,0,0,.2);opacity:0;transform:translateY(20px);transition:opacity .3s ease-out,transform .3s ease-out}.toast.show{opacity:1;transform:translateY(0)}.toast.info{background-color:var(--info-blue)}.toast.success{background-color:var(--success-green)}.toast.error{background-color:var(--danger-red)}.toast.warning{background-color:var(--warning-orange)}#loadingOverlay{transition:opacity .3s ease-in-out}.loader{border-top-color:var(--primary-indigo);animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}.tooltip-container{position:relative;display:inline-flex;align-items:center;margin-left:.5rem;cursor:help}.tooltip-content{position:absolute;bottom:100%;left:50%;transform:translateX(-50%) translateY(-.5rem);background-color:#333;color:#fff;padding:.5rem .75rem;border-radius:.375rem;font-size:.875rem;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .2s ease-out,transform .2s ease-out;z-index:10}.tooltip-container:hover .tooltip-content{opacity:1;transform:translateX(-50%) translateY(-1rem)}.chart-container{position:relative;width:100%;height:256px;display:flex;align-items:center;justify-content:center;background-color:var(--gray-50);border-radius:8px;overflow:hidden}.chart-placeholder{color:var(--gray-500);font-style:italic;text-align:center;padding:1rem}.progress-bar-container{margin-top:1.5rem}.progress-bar-label{display:flex;justify-content:space-between;align-items:center;font-size:.9rem;font-weight:500;color:var(--gray-700);margin-bottom:.5rem}.progress-bar{width:100%;height:12px;background-color:var(--gray-200);border-radius:9999px;overflow:hidden}.progress-bar-fill{height:100%;width:0;border-radius:9999px;transition:width .5s ease-out,background-color .5s ease-out}.calendar-container{margin-top:1rem}.calendar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}.calendar-header h4{font-size:1.25rem;font-weight:700;color:var(--gray-800)}.calendar-nav button{background:0 0;border:none;cursor:pointer;padding:.5rem;border-radius:50%;transition:background-color .2s}.calendar-nav button:hover{background-color:var(--gray-200)}.calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:5px}.calendar-day-name{text-align:center;font-size:.8rem;font-weight:600;color:var(--gray-500);padding-bottom:.5rem}.calendar-day{position:relative;text-align:center;padding:.5rem 0;border-radius:8px;cursor:pointer;transition:background-color .2s,border-color .2s;border:2px solid transparent}.calendar-day:not(.disabled):hover{background-color:var(--light-indigo)}.calendar-day.today{border-color:var(--primary-indigo)}.calendar-day.has-ot{background-color:var(--primary-indigo);color:#fff;font-weight:600}.calendar-day.has-ot:hover{background-color:var(--dark-indigo)}.calendar-day.disabled{color:var(--gray-400);cursor:not-allowed}.calendar-day .ot-hours{position:absolute;bottom:2px;right:4px;font-size:.7rem;font-weight:700;opacity:.8}</style>
</head>
<body>
<div class=main-wrapper>
<div class=form-content>
<h2 class="text-3xl font-extrabold text-center text-gray-900 mb-6">Enhanced OT Calculator</h2>
<div id=userIdDisplay class=hidden></div>
<div class="bg-blue-50 p-6 rounded-xl border border-blue-200 mb-6">
<div class=collapsible-header data-target=howToUseContent>
<h3 class="text-xl font-bold text-blue-800">How to Use This Calculator</h3>
<svg class="collapsible-icon h-6 w-6 text-blue-600" fill=none viewBox="0 0 24 24" stroke=currentColor>
<path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M9 5l7 7-7 7"/>
</svg>
</div>
<div id=howToUseContent class=collapsible-content>
<ul class="list-disc list-inside text-gray-700 space-y-2">
<li><strong>1. Employee Settings:</strong> Enter your basic monthly salary. Optionally, set a target OT pay and/or min/max total hours.</li>
<li><strong>2. OT Planning Date Range:</strong> Define the period for which you want to calculate or plan your overtime.</li>
<li><strong>3. Public Holiday Management:</strong> Add any public holidays within your planning range.</li>
<li><strong>4. OT Multiplier Settings:</strong> Adjust the overtime rates. Note: Rest Day (Sunday) pay is now automatically split for the first 8 hours and after.</li>
<li><strong>5. Daily Overtime Entries:</strong>
<ul class="list-circle list-inside ml-4 mt-1 space-y-1">
<li>Use the **Interactive Calendar** to manage your schedule. Click on a day to add or edit OT hours.</li>
<li><strong>Allocation Strategy:</strong> Choose how hours are allocated.
<ul>
<li><strong>Target-Driven:</strong> Automatically selected when you have a "Target OT Pay". This now treats your target as a **minimum**. Choose a sub-strategy:
<ul class="list-square list-inside ml-4">
<li><strong>Balanced:</strong> Uses a human-like, randomized approach to meet your target.</li>
<li><strong>Fastest Path:</strong> Prioritizes high-pay days to meet your target with fewer hours.</li>
<li><strong>Cheapest Path:</strong> Prioritizes low-pay days to maximize hours for a given target.</li>
</ul>
</li>
<li><strong>Workload-Driven:</strong> Automatically selected when you have no target. Allocates hours based on a "Workload Preset".</li>
</ul>
</li>
<li>The logic now ensures your **Min Total OT Hours** target is met if possible, after the pay target is secured.</li>
<li>Click "Auto Allocate Hours" to generate entries based on your chosen strategy.</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-6">
<h3 class="text-xl font-bold text-gray-800 mb-4">Employee Settings</h3>
<div class="grid grid-cols-1 md:grid-cols-2 gap-5">
<div class=input-group>
<label for=basicSalary>Basic Monthly Salary (RM)</label>
<div class=input-with-clear>
<input type=number id=basicSalary value=3700.00 min=0 step=0.01 class=shadow-sm>
<button type=button class=clear-input-btn aria-label="Clear Basic Monthly Salary">
<svg xmlns=http://www.w3.org/2000/svg class="h-4 w-4" fill=none viewBox="0 0 24 24" stroke=currentColor>
<path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M6 18L18 6M6 6l12 12"/>
</svg>
</button>
</div>
</div>
<div class=input-group>
<label for=targetOTPaySelect>Target OT Pay (RM) (Optional)</label>
<select id=targetOTPaySelect class="shadow-sm mb-2">
<option value="">No Target</option>
<option value=custom>Other (Enter Manually)</option>
</select>
<div class=input-with-clear>
<input type=number id=customTargetOTPayInput class="shadow-sm hidden" placeholder="Enter custom target pay">
<button type=button class="clear-input-btn hidden" id=clearCustomTargetOTPayBtn aria-label="Clear Custom Target OT Pay">
<svg xmlns=http://www.w3.org/2000/svg class="h-4 w-4" fill=none viewBox="0 0 24 24" stroke=currentColor>
<path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M6 18L18 6M6 6l12 12"/>
</svg>
</button>
</div>
</div>
<div class=input-group>
<label for=minTotalOTHours>Min Total OT Hours (Optional)
<span class=tooltip-container>
<svg xmlns=http://www.w3.org/2000/svg class="h-4 w-4 text-gray-400" fill=none viewBox="0 0 24 24" stroke=currentColor><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
<span class=tooltip-content>The minimum total OT hours to aim for.</span>
</span>
</label>
<div class=input-with-clear>
<input type=number id=minTotalOTHours min=0 step=0.5 class=shadow-sm placeholder="e.g., 140">
<button type=button class=clear-input-btn id=clearMinTotalOTHoursBtn aria-label="Clear Min Total OT Hours">
<svg xmlns=http://www.w3.org/2000/svg class="h-4 w-4" fill=none viewBox="0 0 24 24" stroke=currentColor><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M6 18L18 6M6 6l12 12"/></svg>
</button>
</div>
<div id=minMaxHoursError class=error-message></div>
</div>
<div class=input-group>
<label for=maxTotalOTHours>Max Total OT Hours (Optional)
<span class=tooltip-container>
<svg xmlns=http://www.w3.org/2000/svg class="h-4 w-4 text-gray-400" fill=none viewBox="0 0 24 24" stroke=currentColor><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
<span class=tooltip-content>The maximum total OT hours not to exceed.</span>
</span>
</label>
<div class=input-with-clear>
<input type=number id=maxTotalOTHours min=0 step=0.5 class=shadow-sm placeholder="e.g., 150">
<button type=button class=clear-input-btn id=clearMaxTotalOTHoursBtn aria-label="Clear Max Total OT Hours">
<svg xmlns=http://www.w3.org/2000/svg class="h-4 w-4" fill=none viewBox="0 0 24 24" stroke=currentColor><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M6 18L18 6M6 6l12 12"/></svg>
</button>
</div>
</div>
</div>
<div class=mt-6>
<label class="block text-xl font-bold text-gray-800 mb-3">Auto-Allocate to:</label>
<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
<div class="flex items-center">
<input type=checkbox id=allocateWorkingDay class="h-5 w-5 text-primary-indigo rounded border-gray-300 focus:ring-primary-indigo" checked>
<label for=allocateWorkingDay class="ml-2 text-gray-700 font-medium">Working Day</label>
</div>
<div class="flex items-center">
<input type=checkbox id=allocateOffDay class="h-5 w-5 text-primary-indigo rounded border-gray-300 focus:ring-primary-indigo" checked>
<label for=allocateOffDay class="ml-2 text-gray-700 font-medium">Off Day</label>
</div>
<div class="flex items-center">
<input type=checkbox id=allocateRestDay class="h-5 w-5 text-primary-indigo rounded border-gray-300 focus:ring-primary-indigo" checked>
<label for=allocateRestDay class="ml-2 text-gray-700 font-medium">Rest Day</label>
</div>
<div class="flex items-center">
<input type=checkbox id=allocatePublicHoliday class="h-5 w-5 text-primary-indigo rounded border-gray-300 focus:ring-primary-indigo" checked>
<label for=allocatePublicHoliday class="ml-2 text-gray-700 font-medium">Public Holiday</label>
</div>
</div>
</div>
<p class="text-sm text-gray-600 mt-4">
Working Schedule: 5 days/week, Saturday: Off Day, Sunday: Rest Day. For payroll, employer uses 26 working days monthly.
</p>
</div>
<div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-6">
<h3 class="text-xl font-bold text-gray-800 mb-4">OT Planning Date Range</h3>
<div class=input-group>
<label for=dateRangeInput>Select Date Range</label>
<div class="flex items-center gap-2">
<input id=dateRangeInput class="shadow-sm flex-grow" placeholder="Click to select date range" readonly>
<button type=button id=setThisMonthBtn class="btn btn-secondary p-2" aria-label="Set date range to this month">
This Month
</button>
</div>
<div id=dateRangeError class=error-message></div>
</div>
</div>
<div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-6">
<div class=collapsible-header data-target=publicHolidaysContent>
<h3 class="text-xl font-bold text-gray-800">Public Holiday Management</h3>
<svg class="collapsible-icon h-6 w-6 text-gray-600" fill=none viewBox="0 0 24 24" stroke=currentColor>
<path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M9 5l7 7-7 7"/>
</svg>
</div>
<div id=publicHolidaysContent class=collapsible-content>
<div class="flex flex-col sm:flex-row gap-4 mb-4">
<div class="input-group flex-grow">
<label for=publicHolidayDate>Add Public Holiday Date</label>
<div class="flex items-center gap-2">
<input type=date id=publicHolidayDate class="shadow-sm flex-grow">
<button type=button id=setPublicHolidayTodayBtn class="btn btn-secondary p-2" aria-label="Set public holiday date to today">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor><path fill-rule=evenodd d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule=evenodd /></svg>
</button>
</div>
</div>
<button id=addPublicHolidayDateBtn class="btn btn-secondary mt-auto" aria-label="Add public holiday">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor><path fill-rule=evenodd d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule=evenodd /></svg>
Add Holiday
</button>
</div>
<ul id=publicHolidaysList class="list-disc list-inside ml-4 text-gray-700">
</ul>
</div>
</div>
<div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-6">
<div class=collapsible-header data-target=otMultiplierContent>
<h3 class="text-xl font-bold text-gray-800">OT Multiplier Settings</h3>
<svg class="collapsible-icon h-6 w-6 text-gray-600" fill=none viewBox="0 0 24 24" stroke=currentColor>
<path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M9 5l7 7-7 7"/>
</svg>
</div>
<div id=otMultiplierContent class=collapsible-content>
<div id=otMultiplierInputs class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-4">
</div>
<button id=resetMultipliersBtn class="btn btn-secondary" aria-label="Reset OT multipliers to default">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor><path fill-rule=evenodd d="M4 2a1 1 0 011 1v2.118a1 1 0 01-.293.707l-2.118 2.118A1 1 0 012 8v8a2 2 0 002 2h12a2 2 0 002-2V8a1 1 0 01-.293-.707l-2.118-2.118A1 1 0 0115 5.118V3a1 1 0 011-1h-2a1 1 0 01-1-1V1a1 1 0 10-2 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1V1a1 1 0 10-2 0v1a1 1 0 01-1 1H4zm2 5V4h8v3H6zm-2 4h12V9H4v2zm0 2h12v3H4v-3z" clip-rule=evenodd /></svg>
Reset to Default Multipliers
</button>
</div>
</div>
<div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
<h3 class="text-xl font-bold text-gray-800 mb-4">Daily Overtime Entries</h3>
<div class="input-group mb-4">
<label for=allocationStrategy>Allocation Strategy
<span class=tooltip-container>
<svg xmlns=http://www.w3.org/2000/svg class="h-4 w-4 text-gray-400" fill=none viewBox="0 0 24 24" stroke=currentColor><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
<span class=tooltip-content>This is set automatically based on Target OT Pay.</span>
</span>
</label>
<select id=allocationStrategy class=shadow-sm aria-describedby=allocationStrategyDescription>
<option value=Target-Driven>Target-Driven (using Workload Presets)</option>
<option value=Workload-Driven>Workload-Driven (Fill All Days)</option>
</select>
<p id=allocationStrategyDescription class="text-sm text-gray-600 mt-2"></p>
</div>
<div id=targetDrivenStrategyGroup class="input-group mb-4 hidden">
<label for=targetAllocationStrategy>Target-Driven Strategy
<span class=tooltip-container>
<svg xmlns=http://www.w3.org/2000/svg class="h-4 w-4 text-gray-400" fill=none viewBox="0 0 24 24" stroke=currentColor><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
<span class=tooltip-content>Choose how to meet your OT pay target.</span>
</span>
</label>
<select id=targetAllocationStrategy class=shadow-sm aria-describedby=targetAllocationStrategyDescription>
<option value=Balanced>Balanced (Human-like)</option>
<option value="Fastest Path">Fastest Path (Fewest Hours)</option>
<option value="Cheapest Path">Cheapest Path (Most Hours)</option>
</select>
<p id=targetAllocationStrategyDescription class="text-sm text-gray-600 mt-2"></p>
</div>
<div id=workloadPresetGroup class="input-group mb-4">
<label for=workloadPreset>Workload Preset for Auto Allocation
<span class=tooltip-container>
<svg xmlns=http://www.w3.org/2000/svg class="h-4 w-4 text-gray-400" fill=none viewBox="0 0 24 24" stroke=currentColor><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
<span class=tooltip-content>Defines min/max hours for different day types.</span>
</span>
</label>
<select id=workloadPreset class=shadow-sm aria-describedby=workloadPresetDescription>
<option value="Moderate Workload">Moderate Workload</option>
<option value="Light Workload">Light Workload</option>
<option value="Heavy Workload">Heavy Workload</option>
</select>
<p id=workloadPresetDescription class="text-sm text-gray-600 mt-2"></p>
</div>
<div id=workloadPresetDetails class="text-sm text-gray-700 mb-4 p-3 bg-gray-100 rounded-md border border-gray-200">
</div>
<div class="flex flex-col sm:flex-row gap-4 mb-4">
<button id=autoAllocateBtn class="btn btn-secondary flex-grow" aria-label="Auto allocate hours">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor><path d="M17.293 3.293a1 1 0 011.414 0l-2.293 2.293a1 1 0 01-1.414-1.414l2.293-2.293zM9 12a3 3 0 100-6 3 3 0 000 6z"/><path fill-rule=evenodd d="M15.293 10.293a1 1 0 010 1.414l-2.293 2.293a1 1 0 01-1.414-1.414l2.293-2.293a1 1 0 011.414 0zM4.707 4.707a1 1 0 010 1.414L2.414 8.414a1 1 0 01-1.414-1.414L3.293 4.707a1 1 0 011.414 0zM12 9a3 3 0 10-6 0 3 3 0 006 0z" clip-rule=evenodd /></svg>
Auto Allocate Hours
<span id=autoAllocateLoading class="loading-indicator hidden" aria-live=polite>Allocating...</span>
</button>
<button id=clearAllEntriesBtn class="btn btn-danger flex-grow" aria-label="Clear all OT entries">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor><path fill-rule=evenodd d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule=evenodd /></svg>
Clear All Entries
</button>
</div>
<div id=calendarContainer class=calendar-container></div>
<div class="flex flex-col sm:flex-row gap-4 mt-4">
<button id=saveDataBtn class="btn btn-primary flex-grow" aria-label="Save current data">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor><path d="M7 3a1 1 0 00-1 1v1a1 1 0 001 1h6a1 1 0 001-1V4a1 1 0 00-1-1H7z"/><path fill-rule=evenodd d="M18 8H2a2 2 0 00-2 2v8a2 2 0 002 2h16a2 2 0 002-2v-8a2 2 0 00-2-2zM4 13a1 1 0 011-1h10a1 1 0 011 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-3z" clip-rule=evenodd /></svg>
Save Data
<span id=saveDataStatus class=status-message aria-live=polite></span>
</button>
<button id=loadDataBtn class="btn btn-secondary flex-grow" aria-label="Load saved data">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor><path fill-rule=evenodd d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule=evenodd /></svg>
Load Data
<span id=loadDataStatus class=status-message aria-live=polite></span>
</button>
</div>
</div>
<div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mt-6 flex items-center justify-between">
<label for=firebaseToggle class="text-xl font-bold text-gray-800 cursor-pointer">
Enable Firebase (Save/Load)
</label>
<label class=toggle-switch>
<input type=checkbox id=firebaseToggle>
<span class=slider></span>
</label>
</div>
<p id=firebaseStatusMessage class="text-sm text-gray-600 mt-2 text-center"></p>
<button id=resetAndReallocateBtn class="btn btn-danger w-full mt-4" aria-label="Reset all and re-allocate">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor><path fill-rule=evenodd d="M4 2a1 1 0 011 1v2.118a1 1 0 01-.293.707l-2.118 2.118A1 1 0 012 8v8a2 2 0 002 2h12a2 2 0 002-2V8a1 1 0 01-.293-.707l-2.118-2.118A1 1 0 0115 5.118V3a1 1 0 011-1h-2a1 1 0 01-1-1V1a1 1 0 10-2 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1V1a1 1 0 10-2 0v1a1 1 0 01-1 1H4zm2 5V4h8v3H6zm-2 4h12V9H4v2zm0 2h12v3H4v-3z" clip-rule=evenodd /></svg>
Reset & Re-allocate All
</button>
</div>
<div class=summary-sidebar>
<div id=results class=results-section>
<h3 class="text-2xl font-bold text-gray-900 mb-4">Calculation Summary</h3>
<div id=payProgressContainer class="progress-bar-container hidden">
<div class=progress-bar-label>
<span>Pay Target Progress</span>
<span id=payPercentage>0%</span>
</div>
<div class=progress-bar>
<div id=payProgressBar class=progress-bar-fill></div>
</div>
</div>
<div id=hoursProgressContainer class="progress-bar-container hidden">
<div class=progress-bar-label>
<span>Hours Progress</span>
<span id=hoursPercentage>0%</span>
</div>
<div class=progress-bar>
<div id=hoursProgressBar class=progress-bar-fill></div>
</div>
</div>
<p class="text-xl font-bold text-gray-900 mt-6">Combined OT Pay: <span id=combinedOTPay class=text-indigo-600>RM 0.00</span></p>
<p class="text-xl font-bold text-gray-900 mt-2">Target OT Pay: <span id=targetOTPayDisplay class=text-green-600>RM 0.00</span></p>
<p class="text-xl font-bold mt-2">Difference from Target: <span id=differenceFromTarget>RM 0.00</span></p>
<p class="text-xl font-bold mt-2">Total Monthly OT Hours: <span id=totalMonthlyOTHoursDisplay>0.0 hours</span></p>
<p class="text-xl font-bold mt-2">Total OT Hours Range: <span id=totalOTHoursRangeDisplay>N/A</span></p>
<p class="text-xl font-bold text-gray-900 mt-2">Expected Salary Pay: <span id=expectedSalaryPayDisplay class=text-indigo-600>RM 0.00</span></p>
<h4 class="text-lg font-bold text-gray-800 mt-6 mb-2">OT Pay Distribution</h4>
<div class=chart-container>
<canvas id=otDistributionChart class="w-full h-full"></canvas>
<p id=chartPlaceholder class="chart-placeholder absolute hidden">No OT data to display. Add entries and calculate!</p>
</div>
<div class="summary-inline-group mt-6">
<strong>Total OT Hours by Type:</strong>
<span id=totalHoursByType class=text-gray-700></span>
</div>
<div class=summary-inline-group>
<strong>Total Pay per OT Category:</strong>
<span id=totalPayByCategory class=text-gray-700></span>
</div>
<p class="text-base font-bold text-gray-900 mt-2">Allocation Strategy: <span id=allocationStrategySummary class=text-gray-700></span></p>
<button id=exportSummaryBtn class="btn btn-secondary mt-6" aria-label="Export OT summary to text file">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor><path fill-rule=evenodd d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L10 11.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule=evenodd /></svg>
Export Summary
</button>
</div>
</div>
</div>
<div id=messageBox class="message-box hidden" role=dialog aria-modal=true aria-labelledby=messageBoxTitle aria-describedby=messageBoxContent>
<h4 id=messageBoxTitle></h4>
<p id=messageBoxContent></p>
<div class=message-box-buttons>
<button id=messageBoxCancelBtn class="btn btn-cancel hidden">Cancel</button>
<button id=messageBoxConfirmBtn class=hidden>Confirm</button>
<button id=messageBoxCloseBtn>OK</button>
</div>
</div>
<div id=addDetailedOTEntryModal class="manual-entry-modal hidden" role=dialog aria-modal=true aria-labelledby=detailedEntryModalTitle>
<div class=manual-entry-modal-content>
<h4 id=detailedEntryModalTitle class="text-2xl font-bold text-gray-900 mb-4">Add/Edit OT Entry</h4>
<div class=input-group>
<label for=detailedEntryDate>Date</label>
<input type=date id=detailedEntryDate class=shadow-sm readonly>
</div>
<div class=input-group>
<label for=detailedEntryHours>Hours</label>
<input type=number id=detailedEntryHours value=2.0 min=0 step=0.5 class=shadow-sm>
<div id=detailedEntryHoursError class="error-message text-left"></div>
</div>
<div class=input-group>
<label for=detailedEntryStartTime>Start Time</label>
<input type=time id=detailedEntryStartTime value=18:00 class=shadow-sm>
<div id=detailedEntryStartTimeError class="error-message text-left"></div>
</div>
<div class=input-group>
<label for=detailedEntryEndTime>End Time (Calculated)</label>
<input type=time id=detailedEntryEndTime class=shadow-sm readonly>
</div>
<div class=modal-buttons>
<button id=removeDetailedEntryBtn class="btn btn-danger hidden">Remove</button>
<button id=cancelDetailedEntryBtn class="btn btn-secondary">Cancel</button>
<button id=confirmDetailedEntryBtn class="btn btn-primary">Save</button>
</div>
</div>
</div>
<div id=allocationChoiceModal class="manual-entry-modal hidden allocation-choice-modal" role=dialog aria-modal=true aria-labelledby=allocationChoiceModalTitle>
<div class=manual-entry-modal-content>
<h4 id=allocationChoiceModalTitle class="text-2xl font-bold text-gray-900 mb-4">Auto-Allocation Options</h4>
<p class="text-gray-700 mb-6">How would you like to allocate overtime hours?</p>
<div class=modal-buttons>
<button id=clearAndAllocateBtn class="btn btn-danger">
Auto Allocate
</button>
<button id=fillRemainingBtn class="btn btn-primary mt-4">
Fill Remaining Hours
</button>
<button id=cancelAllocationChoiceBtn class="btn btn-secondary mt-4">
Cancel
</button>
</div>
</div>
</div>
<div id=loadingOverlay class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[3000] hidden">
<div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-16 w-16"></div>
</div>
<div id=toastContainer></div>
<script type=module>import{initializeApp}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";import{getAuth,signInAnonymously,signInWithCustomToken,onAuthStateChanged}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";import{getFirestore,doc,getDoc,setDoc}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";const DEFAULT_OT_MULTIPLIERS={"Normal OT (Weekdays)":1.5,"Off Day (Saturday)":1.5,"Rest Day (Sunday)":.5,"Rest Day (Sunday) - After 8h":2,"Public Holiday":2},DISPLAYABLE_OT_TYPES=["Normal OT (Weekdays)","Off Day (Saturday)","Rest Day (Sunday)","Public Holiday"],PREDEFINED_TARGET_PAYS=[1e3,2e3,3e3,4e3,5e3],CONFIG={WORKING_DAYS_MONTHLY:26,STANDARD_WORK_HOURS_DAILY:8,MAX_DAILY_OT_HOURS:8,ALLOCATION_PRECISION:.01,OT_MULTIPLIERS:{...DEFAULT_OT_MULTIPLIERS},WORKLOAD_PRESETS:{"Light Workload":{"Normal OT (Weekdays)":{minHours:1,maxHours:5},"Off Day (Saturday)":{minHours:2,maxHours:5},"Rest Day (Sunday)":{minHours:2,maxHours:6}},"Moderate Workload":{"Normal OT (Weekdays)":{minHours:2,maxHours:7},"Off Day (Saturday)":{minHours:3,maxHours:8},"Rest Day (Sunday)":{minHours:4,maxHours:8}},"Heavy Workload":{"Normal OT (Weekdays)":{minHours:3,maxHours:8},"Off Day (Saturday)":{minHours:5,maxHours:8},"Rest Day (Sunday)":{minHours:6,maxHours:8}}}};(async()=>{let e,t,a,n,o,s,l,i,r,d,c,u,m,y,g,h,f,L,p,E,v,T,I,O,S,D,x,w,C,F,b,B,_,M,H,A,N,P,k,R,$,Y,U,G,W,j,z,J,X,q,K,V,Z,Q,ee,te,ae,ne,oe,se,le,ie,re,de,ce,ue,me,ye,ge,he,fe,Le,pe,Ee,ve,Te,Ie,Oe,Se,De,xe,we,Ce,Fe,be,Be,_e,Me,He,Ae,Ne,Pe,ke,Re=null,$e=!1,Ye=JSON.parse(localStorage.getItem("isFirebaseEnabled")||"true"),Ue=[],Ge=[],We=0,je="Moderate Workload",ze="Target-Driven",Je=new Date;function Xe(e,t){let a;return function(...n){const o=this;clearTimeout(a),a=setTimeout((()=>e.apply(o,n)),t)}}async function qe(){return new Promise((e=>setTimeout(e,0)))}function Ke(e,t,a="info",n=null){"info"!==a?(K.textContent=e,V.textContent=t,Z.classList.add("hidden"),Q.classList.add("hidden"),ee.classList.add("hidden"),"confirm"===a?(Q.onclick=()=>{q.classList.add("hidden"),q.classList.remove("show"),n&&n(),window.lastFocusedElement&&window.lastFocusedElement.focus()},ee.onclick=()=>{q.classList.add("hidden"),q.classList.remove("show"),window.lastFocusedElement&&window.lastFocusedElement.focus()},Q.classList.remove("hidden"),ee.classList.remove("hidden")):(Z.onclick=()=>{q.classList.add("hidden"),q.classList.remove("show"),window.lastFocusedElement&&window.lastFocusedElement.focus()},Z.classList.remove("hidden")),q.classList.remove("hidden"),q.classList.add("show"),window.lastFocusedElement=document.activeElement,Q.focus()):Ve(t,"info")}function Ve(e,t="info"){const a=document.createElement("div");a.classList.add("toast",t),a.textContent=e,De.appendChild(a),a.offsetWidth,a.classList.add("show"),setTimeout((()=>{a.classList.remove("show"),a.addEventListener("transitionend",(()=>{a.remove()}),{once:!0})}),3e3)}function Ze(){Se.classList.remove("hidden"),Se.style.opacity="0",Se.offsetWidth,Se.style.opacity="1"}function Qe(){Se.style.opacity="0",Se.addEventListener("transitionend",(function e(){Se.classList.add("hidden"),Se.removeEventListener("transitionend",e)}),{once:!0})}function et(e,t,a){e.textContent=t,e.className=`status-message show ${a}`,e.setAttribute("aria-live","polite"),"loading"!==a&&setTimeout((()=>{e.classList.remove("show"),e.removeAttribute("aria-live")}),2e3)}function tt(){if("custom"===s.value){const e=parseFloat(l.value);return isNaN(e)?null:e}return""===s.value?null:parseFloat(s.value)}function at(){const e=parseFloat(r.value),t=parseFloat(c.value);return{minHours:isNaN(e)?null:e,maxHours:isNaN(t)?null:t}}function nt(){const{minHours:e,maxHours:t}=at();return m.textContent="",r.classList.remove("input-error"),c.classList.remove("input-error"),!(null!==e&&null!==t&&e>t)||(m.textContent="Min hours cannot be greater than Max hours.",r.classList.add("input-error"),c.classList.add("input-error"),!1)}function ot(e){return e<=0?0:e/CONFIG.WORKING_DAYS_MONTHLY/CONFIG.STANDARD_WORK_HOURS_DAILY}function st(e,t,a,n){let o=0;const s=Dt(n)?"Public Holiday":a;if("Rest Day (Sunday)"===s){const a=CONFIG.OT_MULTIPLIERS["Rest Day (Sunday)"],n=CONFIG.OT_MULTIPLIERS["Rest Day (Sunday) - After 8h"];if(t<=8)o=e*a*t;else{o=e*a*8+e*n*(t-8)}}else{const a=CONFIG.OT_MULTIPLIERS[s];if(void 0===a)return console.warn(`Unknown OT type or multiplier for type: ${s}`),0;o=e*a*t}return o}function lt(e){return`RM ${e.toFixed(2)}`}function it(e,t){if(!e)return"";const[a,n]=e.split(":").map(Number);let o=60*a+n+60*t,s=Math.floor(o/60)%24,l=Math.round(o%60);return 60===l&&(l=0,s=(s+1)%24),`${String(s).padStart(2,"0")}:${String(l).padStart(2,"0")}`}function rt(e,t=null){const a=Math.floor(4*Math.random())+18,n=[0,15,30,45],o=n[Math.floor(Math.random()*n.length)],s=`${String(a).padStart(2,"0")}:${String(o).padStart(2,"0")}`;e.startTime=s,e.endTime=it(e.startTime,e.hours)}function dt(){Ue=[],We=0,ut()}function ct(e){if(Dt(e))return"Public Holiday";switch(new Date(e).getDay()){case 0:return"Rest Day (Sunday)";case 6:return"Off Day (Saturday)";default:return"Normal OT (Weekdays)"}}function ut(){const e=Je.getFullYear(),t=Je.getMonth(),a=new Date(e,t,1).getDay(),n=new Date(e,t+1,0).getDate(),o=new Date,s=o.getFullYear()===e&&o.getMonth()===t?_t(o):null;let l=`\n                    <div class="calendar-header">\n                        <button id="prevMonthBtn" class="calendar-nav" aria-label="Previous month">\n                            <svg class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>\n                        </button>\n                        <h4>${["January","February","March","April","May","June","July","August","September","October","November","December"][t]} ${e}</h4>\n                        <button id="nextMonthBtn" class="calendar-nav" aria-label="Next month">\n                            <svg class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>\n                        </button>\n                    </div>\n                    <div class="calendar-grid">\n                        ${["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].map((e=>`<div class="calendar-day-name">${e}</div>`)).join("")}\n                `;for(let e=0;e<a;e++)l+='<div class="calendar-day disabled"></div>';for(let a=1;a<=n;a++){const n=`${e}-${String(t+1).padStart(2,"0")}-${String(a).padStart(2,"0")}`,o=Ue.find((e=>e.date===n));let i="calendar-day";n===s&&(i+=" today"),o&&(i+=" has-ot"),l+=`\n                        <div class="${i}" data-date="${n}">\n                            <span>${a}</span>\n                            ${o?`<span class="ot-hours">${o.hours.toFixed(1)}h</span>`:""}\n                        </div>\n                    `}l+="</div>",b.innerHTML=l,document.getElementById("prevMonthBtn").addEventListener("click",(()=>{Je.setMonth(Je.getMonth()-1),ut()})),document.getElementById("nextMonthBtn").addEventListener("click",(()=>{Je.setMonth(Je.getMonth()+1),ut()})),b.querySelector(".calendar-grid").addEventListener("click",(e=>{const t=e.target.closest(".calendar-day");t&&!t.classList.contains("disabled")&&function(e){const t=Ue.find((t=>t.date===e));ne.value=e,oe.value=t?t.hours.toFixed(1):"2.0",le.value=t?t.startTime:"18:00",t?ce.classList.remove("hidden"):ce.classList.add("hidden");se.textContent="",oe.classList.remove("input-error"),ke||(ke=window.flatpickr(le,{enableTime:!0,noCalendar:!0,dateFormat:"H:i",time_24hr:!0,minuteIncrement:15,onChange:Ht}));ke.setDate(le.value,!1),Ht(),te.classList.remove("hidden"),te.classList.add("show"),window.lastFocusedElement=document.activeElement,oe.focus()}(t.dataset.date)}))}function mt(){Ke("Confirm Clear All","Are you sure you want to clear all daily OT entries? This action cannot be undone.","confirm",(()=>{dt(),Ve("All entries cleared!","success"),yt()}))}function yt(){const e=parseFloat(n.value),t=tt(),{minHours:a,maxHours:o}=at(),s=Pe.selectedDates,l=s[0]?s[0].toISOString().split("T")[0]:"",i=s[1]?s[1].toISOString().split("T")[0]:"";if(isNaN(e)||e<=0)return k.innerHTML="",R.innerHTML="",$.textContent=lt(0),G.textContent="0.0 hours",j.textContent=lt(0),Y.textContent="N/A (No target set)",Y.classList.remove("text-green-600"),Y.classList.add("text-gray-600"),U.textContent="N/A (No target set)",U.classList.remove("text-green-600","text-red-600"),U.classList.add("text-gray-600"),X.textContent=ze,W.textContent="N/A",W.classList.remove("text-green-600","text-red-600","text-orange-600"),W.classList.add("text-gray-600"),ht([],[]),void gt(0,0,null,null,null);const r=ot(e);let d={},c={},u=0,m=0;DISPLAYABLE_OT_TYPES.forEach((e=>{d[e]=0,c[e]=0})),Ue.forEach((e=>{const t=new Date(e.date),a=l?new Date(l):null,n=i?new Date(i):null;if(a&&n&&(t.setHours(0,0,0,0),a.setHours(0,0,0,0),n.setHours(0,0,0,0),t<a||t>n))return;const o=parseFloat(e.hours);if(isNaN(o)||o<=0)return;const s=ct(e.date),y=st(r,o,e.type,e.date);d[s]+=o,c[s]+=y,u+=y,m+=o}));const y=e+u;let g=[];DISPLAYABLE_OT_TYPES.forEach((e=>{d[e]>0&&g.push(`<span class="summary-inline-item">${e}: ${d[e].toFixed(1)}h</span>`)})),k.innerHTML=g.join("");let h=[],f=[],L=[];if(DISPLAYABLE_OT_TYPES.forEach((e=>{c[e]>0&&(h.push(`<span class="summary-inline-item">${e}: ${lt(c[e])}</span>`),f.push(e),L.push(c[e]))})),R.innerHTML=h.join(""),ht(f,L,["#6366f1","#ef4444","#f59e0b","#10b981","#3b82f6"]),$.textContent=lt(u),G.textContent=`${m.toFixed(1)} hours`,j.textContent=lt(y),X.textContent=ze,"Target-Driven"===ze){const e=S.options[S.selectedIndex].text;X.textContent+=` (${e})`}if(null===t||t<=0)Y.textContent="N/A (No target set)",Y.classList.remove("text-green-600"),Y.classList.add("text-gray-600"),U.textContent="N/A (No target set)",U.classList.remove("text-green-600","text-red-600"),U.classList.add("text-gray-600");else{Y.textContent=lt(t),Y.classList.remove("text-gray-600"),Y.classList.add("text-green-600");const e=u-t;U.textContent=lt(e),e>=0?(U.classList.remove("text-red-600","text-gray-600"),U.classList.add("text-green-600")):(U.classList.remove("text-green-600","text-gray-600"),U.classList.add("text-red-600"))}W.classList.remove("text-green-600","text-red-600","text-orange-600","text-gray-600"),null!==a&&null!==o?(W.textContent=`${a.toFixed(1)}h - ${o.toFixed(1)}h`,m>=a&&m<=o?W.classList.add("text-green-600"):m<a?W.classList.add("text-orange-600"):W.classList.add("text-red-600")):null!==a?(W.textContent=`Min: ${a.toFixed(1)}h`,m>=a?W.classList.add("text-green-600"):W.classList.add("text-orange-600")):null!==o?(W.textContent=`Max: ${o.toFixed(1)}h`,m<=o?W.classList.add("text-green-600"):W.classList.add("text-red-600")):(W.textContent="N/A",W.classList.add("text-gray-600")),gt(u,m,t,a,o)}function gt(e,t,a,n,o){if(null!==a&&a>0){Be.classList.remove("hidden");const t=Math.min(e/a*100,100);_e.textContent=`${Math.round(t)}%`,Me.style.width=`${t}%`,Me.style.backgroundColor=t>=100?"var(--success-green)":"var(--primary-indigo)"}else Be.classList.add("hidden");if(null!==n||null!==o){He.classList.remove("hidden");let e=0,a="var(--primary-indigo)";if(null!==n&&null!==o)if(t<n)e=t/n*50,a="var(--warning-orange)";else{e=50+(t-n)/(o-n)*50,a="var(--success-green)"}else null!==n?(e=t/n*100,a=t>=n?"var(--success-green)":"var(--warning-orange)"):null!==o&&(e=t/o*100,a="var(--primary-indigo)");null!==o&&t>o&&(e=100,a="var(--danger-red)"),e=Math.max(0,Math.min(e,100)),Ae.textContent=`${t.toFixed(1)}h`,Ne.style.width=`${e}%`,Ne.style.backgroundColor=a}else He.classList.add("hidden")}function ht(e,t,a){const n=document.getElementById("otDistributionChart").getContext("2d");if(0===t.length||t.every((e=>0===e)))return Re&&(Re.destroy(),Re=null),void xe.classList.remove("hidden");xe.classList.add("hidden"),Re?(Re.data.labels=e,Re.data.datasets[0].data=t,Re.data.datasets[0].backgroundColor=a,Re.update()):Re=new Chart(n,{type:"pie",data:{labels:e,datasets:[{label:"OT Pay (RM)",data:t,backgroundColor:a,hoverOffset:4}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"right",labels:{font:{family:"Inter"}}},tooltip:{callbacks:{label:function(e){let t=e.label||"";return t&&(t+=": "),null!==e.parsed&&(t+=lt(e.parsed)),t}},bodyFont:{family:"Inter"},titleFont:{family:"Inter"}}}}})}function ft(){const e=Math.random();if(e<.3)return 2;if(e<.55)return 4;if(e<.7)return 1;if(e<.8)return 3;if(e<.85)return 8;const t=[.5,1.5,2.5,3.5,4.5,5,5.5,6,6.5,7,7.5];return t[Math.floor(Math.random()*t.length)]}function Lt(e,t,a){const n=Ue.findIndex((t=>t.date===e)),o=parseFloat(t.toFixed(1));if(!(o<=CONFIG.ALLOCATION_PRECISION&&-1===n))if(-1!==n)Ue[n].hours+=o,Ue[n].endTime=it(Ue[n].startTime,Ue[n].hours);else{const t={id:"ot-entry-"+We++,date:e,hours:o,type:a,startTime:"",endTime:"",isNew:!0};rt(t),Ue.push(t)}}function pt(){Ue.sort(((e,t)=>{const a=new Date(e.date),n=new Date(t.date);return a-n!=0?a-n:parseInt(e.id.split("-")[2])-parseInt(t.id.split("-")[2])}));let e={};Ue.forEach((t=>{t.startTime&&t.endTime?t.endTime=it(t.startTime,t.hours):rt(t,e[t.date]||null),e[t.date]=t.endTime}))}function Et(){je=x.value;const e=CONFIG.WORKLOAD_PRESETS[je];let t=`<strong>${je} Details:</strong><ul class="list-disc list-inside ml-4">`;DISPLAYABLE_OT_TYPES.forEach((a=>{const n=e[a];n&&(t+=`<li>${a}: ${n.minHours.toFixed(1)} - ${n.maxHours.toFixed(1)} hours</li>`)})),t+="</ul>",F.innerHTML=t,C.textContent="This preset suggests daily OT hours for different day types to guide auto-allocation."}function vt(){const e=tt(),t=null!==e&&e>0;T.value=t?"Target-Driven":"Workload-Driven",ze=T.value,T.disabled=!0,"Target-Driven"===ze?(I.textContent='The calculator will allocate hours to reach your "Target OT Pay".',O.classList.remove("hidden"),w.classList.add("hidden"),F.classList.add("hidden"),Tt()):(I.textContent='Hours will be allocated for all days in your range according to the "Workload Preset".',O.classList.add("hidden"),w.classList.remove("hidden"),F.classList.remove("hidden")),yt()}function Tt(){const e=S.value;let t="";"Balanced"===e?t="Randomly allocates hours across available days to meet the target.":"Fastest Path"===e?t="Prioritizes high-pay days (e.g., Public Holidays) to reach the target with minimum hours.":"Cheapest Path"===e&&(t="Prioritizes low-pay days (e.g., Weekdays) to maximize hours for the target."),D.textContent=t}function It(){if(f._flatpickr){const e=Pe.selectedDates,t=_t(e[0]),a=_t(e[1]);f._flatpickr.set("minDate",t),f._flatpickr.set("maxDate",a),f._flatpickr.redraw()}}function Ot(){const e=f.value,t=Pe.selectedDates,a=t[0]?t[0].toISOString().split("T")[0]:"",n=t[1]?t[1].toISOString().split("T")[0]:"";if(!e)return void Ve("Please select a date for the public holiday.","error");if(!a||!n||new Date(e)<new Date(a)||new Date(e)>new Date(n))return void Ve("Public Holiday date must be within the OT Planning Date Range.","error");if(Ge.includes(e))return void Ve(`${e} is already in the public holidays list.`,"warning");Ge.push(e),Ge.sort(),St();const o=document.querySelector('.collapsible-header[data-target="publicHolidaysContent"]'),s=o?o.querySelector(".collapsible-icon"):null;Le.classList.contains("collapsed")&&Ut(Le,s,!0),ut(),yt(),Ve("Public Holiday added successfully!","success")}function St(){p.innerHTML="",Ge.length>0?Ge.forEach((e=>{const t=document.createElement("li");t.classList.add("flex","justify-between","items-center","py-1"),t.innerHTML=`\n                        <span>${e}</span>\n                        <button type="button" class="text-red-500 hover:text-red-700 ml-4" data-date="${e}" aria-label="Remove public holiday ${e}">\n                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" /></svg>\n                        </button>\n                    `,p.appendChild(t),t.querySelector("button").addEventListener("click",(e=>{const t=e.currentTarget.dataset.date;Ke("Confirm Removal",`Are you sure you want to remove ${t} from public holidays?`,"confirm",(()=>{Ge=Ge.filter((e=>e!==t)),St(),ut(),yt(),Ve("Holiday Removed","success")}))}))})):p.innerHTML='<li class="text-gray-500">No public holidays added yet.</li>'}function Dt(e){return Ge.includes(e)}function xt(){E.innerHTML="",DISPLAYABLE_OT_TYPES.forEach((e=>{const t=document.createElement("div");t.classList.add("input-group");const a=`multiplier-${e.replace(/[^0-9A-Za-z]/g,"")}`;t.innerHTML=`\n                        <label for="${a}">${e} Multiplier</label>\n                        <input type="number" id="${a}" value="${(CONFIG.OT_MULTIPLIERS[e]||0).toFixed(2)}" min="0" step="0.1" class="shadow-sm">\n                    `,E.appendChild(t),t.querySelector("input").addEventListener("input",Xe((t=>{const a=parseFloat(t.target.value);!isNaN(a)&&a>=0&&(CONFIG.OT_MULTIPLIERS[e]=a,yt())}),150))}))}function wt(){Ke("Confirm Reset Multipliers","Are you sure you want to reset all OT multipliers to their default values?","confirm",(()=>{Object.assign(CONFIG.OT_MULTIPLIERS,DEFAULT_OT_MULTIPLIERS),xt(),Ve("OT multipliers have been reset to their default values.","success"),yt()}))}async function Ct(e){Ze(),_.classList.remove("hidden"),_.setAttribute("aria-live","polite"),await qe();try{const t=parseFloat(n.value),a=tt(),{minHours:o,maxHours:s}=at(),l=Pe.selectedDates,i=l[0]?l[0].toISOString().split("T")[0]:"",r=l[1]?l[1].toISOString().split("T")[0]:"";if(isNaN(t)||t<=0||!i||!r||new Date(i)>new Date(r)||!nt())return void Ve("Please ensure all settings (Salary, Date Range, Hour Limits) are valid.","error");let d=0,c=0;const u={};if(e)dt();else{const e=new Date(i),a=new Date(r);Ue=Ue.filter((t=>{const n=new Date(t.date);return n>=e&&n<=a})),Ue.forEach((e=>{const a=parseFloat(e.hours);!isNaN(a)&&a>0&&(d+=st(ot(t),a,e.type,e.date),c+=a,u[e.date]=(u[e.date]||0)+a)}))}if(null!==s&&c>=s-CONFIG.ALLOCATION_PRECISION)return Ve(`Max Total OT Hours (${s.toFixed(1)}h) already met.`,"warning"),void yt();const m=ot(t),y=((e,t)=>{const a=[];let n=new Date(e);const o=new Date(t);for(;n<=o;)a.push({date:n.toISOString().split("T")[0],dayOfWeek:n.getDay()}),n.setDate(n.getDate()+1);return a})(i,r),g={workingDay:we.checked,offDay:Ce.checked,restDay:Fe.checked,publicHoliday:be.checked},h=()=>y.filter((e=>{if((u[e.date]||0)>=CONFIG.MAX_DAILY_OT_HOURS)return!1;const t=Dt(e.date);if(t&&g.publicHoliday)return!0;if(!t){if(e.dayOfWeek>=1&&e.dayOfWeek<=5&&g.workingDay)return!0;if(6===e.dayOfWeek&&g.offDay)return!0;if(0===e.dayOfWeek&&g.restDay)return!0}return!1}));if("Target-Driven"===ze){if(null===a||a<=0)return void Ve("Please enter a valid Target OT Pay (> RM0) for Target-Driven allocation.","error");let e=a-d;e<=CONFIG.ALLOCATION_PRECISION&&Ve("Target OT pay has already been met with existing entries.","info");const t=S.value;let n=h();"Balanced"===t?n=n.sort((()=>Math.random()-.5)):n.sort(((e,a)=>{const n=CONFIG.OT_MULTIPLIERS[ct(e.date)],o=CONFIG.OT_MULTIPLIERS[ct(a.date)];return"Fastest Path"===t?o-n:n-o}));let o=0;const l=20*n.length;for(;e>CONFIG.ALLOCATION_PRECISION&&o<l&&n.length>0;){o++;let l="Balanced"===t?Math.floor(Math.random()*n.length):0;const i=n[l],r=u[i.date]||0;let y=CONFIG.MAX_DAILY_OT_HOURS-r;if(null!==s&&(y=Math.min(y,s-c)),y<=0){n.splice(l,1);continue}let g=ft();g=Math.min(g,y);let h=ct(i.date),f=st(m,r+g,h,i.date)-st(m,r,h,i.date);for(;g>.5&&f>e;)g-=.5,f=st(m,r+g,h,i.date)-st(m,r,h,i.date);f<=e&&g>0&&(Lt(i.date,g,h),d+=f,c+=g,u[i.date]=(u[i.date]||0)+g,e=a-d),"Balanced"!==t&&n.shift(),await qe()}if(d<a-CONFIG.ALLOCATION_PRECISION){Ve(`Target was not fully met (${lt(d)}). Topping up...`,"warning"),await qe();let e=h().filter((e=>(u[e.date]||0)<CONFIG.MAX_DAILY_OT_HOURS));e.sort(((e,t)=>CONFIG.OT_MULTIPLIERS[ct(e.date)]-CONFIG.OT_MULTIPLIERS[ct(t.date)]));let t=0;const n=10*e.length;for(;d<a&&t<n&&e.length>0;){t++;const a=e[0],n=u[a.date]||0;if(CONFIG.MAX_DAILY_OT_HOURS-n<=0){e.shift();continue}const o=.5,s=st(m,n+o,ct(a.date),a.date)-st(m,n,ct(a.date),a.date);Lt(a.date,o,ct(a.date)),d+=s,c+=o,u[a.date]=(u[a.date]||0)+o,e.push(e.shift()),await qe()}}else Ve("Overtime hours allocated to meet your target.","success")}else if("Workload-Driven"===ze){const e=CONFIG.WORKLOAD_PRESETS[je];let t=h().sort((()=>Math.random()-.5));for(const a of t){if(null!==s&&c>=s-CONFIG.ALLOCATION_PRECISION){Ve(`Max Total OT Hours (${s.toFixed(1)}h) reached.`,"info");break}const t=u[a.date]||0,n=CONFIG.MAX_DAILY_OT_HOURS-t,o=ct(a.date),l=e[o];if(!l||n<=0)continue;let i=ft();i=Math.min(i,n,l.maxHours),null!==s&&(i=Math.min(i,s-c)),i>CONFIG.ALLOCATION_PRECISION&&(Lt(a.date,i,o),c+=i,u[a.date]=(u[a.date]||0)+i),await qe()}Ve("Overtime hours allocated based on workload preset.","success")}if(null!==o&&c<o){Ve(`Topping up hours to meet minimum of ${o}h...`,"info"),await qe();let e=h().filter((e=>(u[e.date]||0)<CONFIG.MAX_DAILY_OT_HOURS));e.sort(((e,t)=>CONFIG.OT_MULTIPLIERS[ct(e.date)]-CONFIG.OT_MULTIPLIERS[ct(t.date)]));let t=0;const a=10*e.length;for(;c<o&&t<a&&e.length>0;){t++;const a=e[0],n=u[a.date]||0;if(CONFIG.MAX_DAILY_OT_HOURS-n<=0){e.shift();continue}const o=.5;Lt(a.date,o,ct(a.date)),c+=o,u[a.date]=(u[a.date]||0)+o,e.push(e.shift()),await qe()}c<o&&Ve(`Could not meet minimum hour target. Reached ${c.toFixed(1)}h.`,"warning")}pt(),Ue.forEach((e=>delete e.isNew)),ut(),yt()}catch(e){console.error("Error during auto-allocation:",e),Ve("An error occurred during auto-allocation. Please check console.","error")}finally{Qe(),_.classList.add("hidden"),_.removeAttribute("aria-live")}}function Ft(){try{const e=parseFloat(n.value),t=tt(),{minHours:a,maxHours:o}=at(),s=Pe.selectedDates,l=s[0]?s[0].toISOString().split("T")[0]:"",i=s[1]?s[1].toISOString().split("T")[0]:"",r=ot(e);let d="--- OT Calculation Summary ---\n\n";d+="Employee Settings:\n",d+=`  Basic Monthly Salary: ${lt(e)}\n`,d+=`  Hourly Rate: RM ${r.toFixed(2)}/hour\n\n`,d+=`OT Planning Period: ${l} to ${i}\n`,d+=`Allocation Strategy: ${ze}\n`,d+=`Target OT Pay: ${null===t?"N/A":lt(t)}\n`,d+=`Total OT Hours Range: ${null!==a&&null!==o?`${a.toFixed(1)}h - ${o.toFixed(1)}h`:null!==a?`Min: ${a.toFixed(1)}h`:null!==o?`Max: ${o.toFixed(1)}h`:"N/A"}\n\n`,d+="OT Multipliers Used:\n";for(const e in CONFIG.OT_MULTIPLIERS)d+=`  ${e}: ${CONFIG.OT_MULTIPLIERS[e].toFixed(2)}x\n`;d+="\n";const c={},u=Ue.filter((e=>{const t=new Date(e.date),a=l?new Date(l):null,n=i?new Date(i):null;return!(a&&n&&(t.setHours(0,0,0,0),a.setHours(0,0,0,0),n.setHours(0,0,0,0),t<a||t>n))}));u.forEach((e=>{const t=ct(e.date);(c[t]=c[t]||[]).push(e)})),d+="Daily OT Entries:\n",0===u.length?d+="  No entries recorded for the selected range.\n":DISPLAYABLE_OT_TYPES.forEach((e=>{c[e]&&c[e].length>0&&(d+=`\n--- ${e} ---\n`,c[e].sort(((e,t)=>new Date(e.date)-new Date(t.date))),c[e].forEach((e=>{d+=`  Date: ${e.date}, Hours: ${e.hours.toFixed(1)}h, Type: ${e.type}`,Dt(e.date)&&(d+=" (Public Holiday)"),e.startTime&&e.endTime&&(d+=`, Time: ${e.startTime} - ${e.endTime}`),d+="\n"})))})),d+="\n";let m={},y={},g=0,h=0;DISPLAYABLE_OT_TYPES.forEach((e=>{m[e]=0,y[e]=0})),u.forEach((e=>{const t=parseFloat(e.hours);if(isNaN(t)||t<=0)return;const a=ct(e.date),n=st(r,t,e.type,e.date);m[a]+=t,y[a]+=n,g+=n,h+=t}));const f=e+g;d+="Total OT Hours by Type:\n";let L=[];DISPLAYABLE_OT_TYPES.forEach((e=>{m[e]>0&&L.push(`${e}: ${m[e].toFixed(1)}h`)})),d+=`  ${L.join(", ")}\n\n`,d+="Total Pay per OT Category:\n";let p=[];DISPLAYABLE_OT_TYPES.forEach((e=>{y[e]>0&&(y[e]=parseFloat(y[e].toFixed(2)),p.push(`${e}: ${lt(y[e])}`))})),d+=`  ${p.join(", ")}\n\n`,d+=`Combined OT Pay: ${lt(g)}\n`;const E=g-(null===t?0:t);d+=`Difference from Target: ${null===t?"N/A (No target set)":lt(E)}\n`,d+=`Total Monthly OT Hours: ${h.toFixed(1)} hours\n`,d+=`Expected Salary Pay (Calculated): ${lt(f)}\n\n`,d+="--- End of Summary ---";const v=new Blob([d],{type:"text/plain;charset=utf-8"}),T=URL.createObjectURL(v),I=document.createElement("a");I.href=T,I.download="ot_summary.txt",document.body.appendChild(I),I.click(),Ve("Your OT summary is being downloaded.","info"),setTimeout((()=>{document.body.removeChild(I),URL.revokeObjectURL(T)}),250)}catch(e){console.error("Error during export summary:",e),Ve("Failed to export summary. Please check your browser console for details.","error")}}async function bt(){if(Ye)if($e&&a){Ze(),et(ve,"Saving...","loading");try{const t="undefined"!=typeof __app_id?__app_id:"default-app-id",o=doc(e,`artifacts/${t}/users/${a}/ot_calculator_data`,"user_data"),s=Ue.map((e=>{const t={...e};return delete t.isNew,t})),{minHours:l,maxHours:i}=at(),r={basicSalary:parseFloat(n.value),targetOTPay:tt(),minTotalOTHours:l,maxTotalOTHours:i,startDate:Pe.selectedDates[0]?Pe.selectedDates[0].toISOString().split("T")[0]:"",endDate:Pe.selectedDates[1]?Pe.selectedDates[1].toISOString().split("T")[0]:"",workloadPreset:x.value,allocationStrategy:T.value,targetAllocationStrategy:S.value,otEntries:JSON.stringify(s),publicHolidays:JSON.stringify(Ge),customMultipliers:JSON.stringify(CONFIG.OT_MULTIPLIERS),allocateWorkingDay:we.checked,allocateOffDay:Ce.checked,allocateRestDay:Fe.checked,allocatePublicHoliday:be.checked};await setDoc(o,r),Ue=s,ut(),et(ve,"Saved!","success"),Ve("Data saved successfully!","success")}catch(e){console.error("Error saving document: ",e),et(ve,"Save Failed!","error"),Ve("Failed to save data. Please try again.","error")}finally{Qe()}}else Ve("Firebase authentication not ready. Please try again in a moment.","error");else Ve("Firebase functions (Save/Load) are currently disabled. Please enable them to use this feature.","warning")}async function Bt(t=!1){if(Ye)if($e&&a){t||(Ze(),et(Te,"Loading...","loading"));try{const o="undefined"!=typeof __app_id?__app_id:"default-app-id",d=doc(e,`artifacts/${o}/users/${a}/ot_calculator_data`,"user_data"),u=await getDoc(d);if(u.exists()){const e=u.data();n.value=parseFloat(e.basicSalary);const a=e.targetOTPay;if(null===a?(s.value="",l.classList.add("hidden"),i.classList.add("hidden"),l.value=""):PREDEFINED_TARGET_PAYS.includes(a)?(s.value=a.toFixed(2),l.classList.add("hidden"),i.classList.add("hidden"),l.value=""):(s.value="custom",l.classList.remove("hidden"),i.classList.remove("hidden"),l.value=a.toFixed(2)),r.value=null!==e.minTotalOTHours?e.minTotalOTHours:"",c.value=null!==e.maxTotalOTHours?e.maxTotalOTHours:"",e.startDate&&e.endDate?Pe.setDate([e.startDate,e.endDate],!0):Pe.clear(),x.value=e.workloadPreset||"Moderate Workload",T.value=e.allocationStrategy||"Target-Driven",S.value=e.targetAllocationStrategy||"Balanced",Ue=JSON.parse(e.otEntries||"[]"),Ge=JSON.parse(e.publicHolidays||"[]"),Object.assign(CONFIG.OT_MULTIPLIERS,JSON.parse(e.customMultipliers||"{}")),Object.assign(CONFIG.OT_MULTIPLIERS,{...DEFAULT_OT_MULTIPLIERS,...CONFIG.OT_MULTIPLIERS}),we.checked=void 0===e.allocateWorkingDay||e.allocateWorkingDay,Ce.checked=void 0===e.allocateOffDay||e.allocateOffDay,Fe.checked=void 0===e.allocateRestDay||e.allocateRestDay,be.checked=void 0===e.allocatePublicHoliday||e.allocatePublicHoliday,We=Ue.length>0?Math.max(...Ue.map((e=>parseInt(e.id.split("-")[2]))))+1:0,pt(),ut(),St(),Ge.length>0){const e=document.querySelector('.collapsible-header[data-target="publicHolidaysContent"]'),t=e?e.querySelector(".collapsible-icon"):null;Ut(Le,t,!0)}xt(),yt(),t||(et(Te,"Loaded!","success"),Ve("Data loaded successfully!","success"))}else{const e=new Date,a=new Date(e.getFullYear(),e.getMonth(),1),o=new Date(e.getFullYear(),e.getMonth()+1,0);Pe.setDate([a,o],!0),n.value="3700.00",x.value="Moderate Workload",T.value="Target-Driven",s.value="",l.classList.add("hidden"),i.classList.add("hidden"),r.value="",c.value="",we.checked=!0,Ce.checked=!0,Fe.checked=!0,be.checked=!0,St(),xt(),ut(),yt(),t||et(Te,"No saved data found.","info")}}catch(e){console.error("Error loading document: ",e),t||(et(Te,"Load Failed!","error"),Ve("Failed to load data. Please try again.","error"))}finally{Et(),vt(),t||Qe()}}else t||Ve("Firebase authentication not ready. Please try again in a moment.","error");else t||Ve("Firebase functions (Save/Load) are currently disabled. Please enable them to use this feature.","warning")}function _t(e){return e?`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`:""}function Mt(){te.classList.add("hidden"),te.classList.remove("show"),window.lastFocusedElement&&window.lastFocusedElement.focus()}function Ht(){const e=le.value,t=parseFloat(oe.value);e&&!isNaN(t)&&t>=0?ie.value=it(e,t):ie.value=""}function At(){const e=ne.value,t=parseFloat(oe.value),a=le.value,n=ie.value;se.textContent="",oe.classList.remove("input-error");let o=!0;if(isNaN(t)||t<0?(se.textContent="Hours must be a positive number or zero.",oe.classList.add("input-error"),o=!1):t>CONFIG.MAX_DAILY_OT_HOURS&&(se.textContent=`Max hours per day is ${CONFIG.MAX_DAILY_OT_HOURS}.`,oe.classList.add("input-error"),o=!1),o){const o=Ue.findIndex((t=>t.date===e));if(0===t)-1!==o&&(Ue.splice(o,1),Ve(`Entry for ${e} removed.`,"success"));else if(-1!==o)Ue[o].hours=t,Ue[o].startTime=a,Ue[o].endTime=n,Ve(`Entry for ${e} updated.`,"success");else{const o={id:"ot-entry-"+We++,date:e,hours:t,type:ct(e),startTime:a,endTime:n,isNew:!0};Ue.push(o),Ve(`New entry for ${e} added.`,"success")}ut(),yt(),Mt()}}function Nt(){const e=ne.value,t=Ue.findIndex((t=>t.date===e));-1!==t&&(Ue.splice(t,1),Ve(`Entry for ${e} removed.`,"success")),ut(),yt(),Mt()}function Pt(){ue.classList.remove("hidden"),ue.classList.add("show"),window.lastFocusedElement=document.activeElement,me.focus()}function kt(){ue.classList.add("hidden"),ue.classList.remove("show"),window.lastFocusedElement&&window.lastFocusedElement.focus()}async function Rt(){if(!Ye)return Oe.textContent="Firebase (Save/Load) is currently disabled.",void J.classList.add("hidden");Oe.textContent="Initializing Firebase...";try{const n="undefined"!=typeof __firebase_config?__firebase_config:"{}",o=JSON.parse(n);if(0===Object.keys(o).length)throw new Error("Firebase configuration is empty or invalid.");const s=initializeApp(o);e=getFirestore(s),t=getAuth(s),onAuthStateChanged(t,(async e=>{if(e)a=e.uid,$e=!0,J.textContent=`User ID: ${a}`,J.classList.remove("hidden"),Oe.textContent="Firebase enabled and connected.",await Bt(!0);else try{const e=await signInAnonymously(t);a=e.user.uid,$e=!0,J.textContent=`User ID: ${a}`,J.classList.remove("hidden"),Oe.textContent="Firebase enabled and connected (anonymous).",await Bt(!0)}catch(e){console.error("Anonymous sign-in failed:",e),Oe.textContent="Firebase connection failed. Check console.",Ve("Failed to sign in. Data saving/loading may not work.","error")}$t()}))}catch(e){console.error("Firebase initialization failed:",e),Oe.textContent=`Firebase init failed: ${e.message}.`,Ve(`Firebase could not be initialized: ${e.message||"Unknown error"}.`,"error"),Ye=!1,Ie.checked=!1,localStorage.setItem("isFirebaseEnabled","false"),$t(),J.classList.add("hidden")}}function $t(){const e=!Ye||!$e;A.disabled=e,N.disabled=e}async function Yt(){Ye=Ie.checked,localStorage.setItem("isFirebaseEnabled",Ye),Ye?await Rt():(e=null,t=null,a=null,$e=!1,J.classList.add("hidden"),Oe.textContent="Firebase (Save/Load) is now disabled."),$t()}function Ut(e,t,a=!1){a||e.classList.contains("collapsed")?(e.style.maxHeight=e.scrollHeight+"px",e.classList.remove("collapsed"),t&&t.classList.add("rotated"),e.addEventListener("transitionend",(function t(){e.style.maxHeight="none",e.removeEventListener("transitionend",t)}),{once:!0})):(e.style.maxHeight=e.scrollHeight+"px",e.offsetWidth,e.classList.add("collapsed"),t&&t.classList.remove("rotated"),e.addEventListener("transitionend",(function t(){e.classList.contains("collapsed")&&(e.style.maxHeight="0"),e.removeEventListener("transitionend",t)}),{once:!0}))}function Gt(){n.addEventListener("input",Xe(yt,150)),l.addEventListener("input",Xe((()=>{vt()}),150)),r.addEventListener("input",Xe((()=>{nt(),yt()}),150)),c.addEventListener("input",Xe((()=>{nt(),yt()}),150)),Pe=window.flatpickr(y,{mode:"range",dateFormat:"Y-m-d",onChange:function(e,t,a){2===e.length&&(Je=new Date(e[0]),ut()),yt(),It(),g.textContent="",y.classList.remove("input-error")}}),h.addEventListener("click",(()=>{const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),1),a=new Date(e.getFullYear(),e.getMonth()+1,0);Pe.setDate([t,a],!0),Ve("Date range set to current month.","info")})),B.addEventListener("click",Pt),me.addEventListener("click",(()=>{kt(),Ct(!0)})),ye.addEventListener("click",(()=>{kt(),Ct(!1)})),ge.addEventListener("click",kt),M.addEventListener("click",(()=>{Ke("Confirm Reset & Re-allocate","Are you sure you want to clear ALL existing OT entries and re-allocate from scratch? This action cannot be undone.","confirm",(()=>Ct(!0)))})),H.addEventListener("click",mt),z.addEventListener("click",Ft),A.addEventListener("click",bt),N.addEventListener("click",(()=>Bt(!1))),x.addEventListener("change",Et),S.addEventListener("change",Tt),L.addEventListener("click",Ot),v.addEventListener("click",wt),s.addEventListener("change",(()=>{"custom"===s.value?(l.classList.remove("hidden"),i.classList.remove("hidden"),l.focus()):(l.classList.add("hidden"),i.classList.add("hidden"),l.value=""),vt()})),o.addEventListener("click",(()=>{n.value="",yt(),Ve("Basic Salary cleared.","info")})),i.addEventListener("click",(()=>{l.value="",vt(),Ve("Custom Target OT Pay cleared.","info")})),d.addEventListener("click",(()=>{r.value="",nt(),yt(),Ve("Min Total OT Hours cleared.","info")})),u.addEventListener("click",(()=>{c.value="",nt(),yt(),Ve("Max Total OT Hours cleared.","info")})),window.flatpickr(f,{dateFormat:"Y-m-d"}),he.addEventListener("click",(()=>{f.value=function(){const e=new Date;return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}(),f._flatpickr&&f._flatpickr.setDate(f.value,!0),Ve("Public Holiday date set to today.","info")})),fe.forEach((e=>{e.addEventListener("click",(()=>{const t=e.dataset.target;Ut(document.getElementById(t),e.querySelector(".collapsible-icon"))}))})),re.addEventListener("click",At),de.addEventListener("click",Mt),ce.addEventListener("click",Nt),oe.addEventListener("input",Ht),le.addEventListener("input",Ht),Ie.addEventListener("change",Yt),[we,Ce,Fe,be].forEach((e=>{e.addEventListener("change",yt)}))}document.addEventListener("DOMContentLoaded",(async()=>{n=document.getElementById("basicSalary"),o=n.nextElementSibling,s=document.getElementById("targetOTPaySelect"),l=document.getElementById("customTargetOTPayInput"),i=document.getElementById("clearCustomTargetOTPayBtn"),r=document.getElementById("minTotalOTHours"),d=document.getElementById("clearMinTotalOTHoursBtn"),c=document.getElementById("maxTotalOTHours"),u=document.getElementById("clearMaxTotalOTHoursBtn"),m=document.getElementById("minMaxHoursError"),y=document.getElementById("dateRangeInput"),g=document.getElementById("dateRangeError"),h=document.getElementById("setThisMonthBtn"),f=document.getElementById("publicHolidayDate"),L=document.getElementById("addPublicHolidayDateBtn"),p=document.getElementById("publicHolidaysList"),E=document.getElementById("otMultiplierInputs"),v=document.getElementById("resetMultipliersBtn"),T=document.getElementById("allocationStrategy"),I=document.getElementById("allocationStrategyDescription"),O=document.getElementById("targetDrivenStrategyGroup"),S=document.getElementById("targetAllocationStrategy"),D=document.getElementById("targetAllocationStrategyDescription"),x=document.getElementById("workloadPreset"),w=document.getElementById("workloadPresetGroup"),C=document.getElementById("workloadPresetDescription"),F=document.getElementById("workloadPresetDetails"),b=document.getElementById("calendarContainer"),B=document.getElementById("autoAllocateBtn"),_=document.getElementById("autoAllocateLoading"),M=document.getElementById("resetAndReallocateBtn"),H=document.getElementById("clearAllEntriesBtn"),A=document.getElementById("saveDataBtn"),N=document.getElementById("loadDataBtn"),P=document.getElementById("results"),k=document.getElementById("totalHoursByType"),R=document.getElementById("totalPayByCategory"),$=document.getElementById("combinedOTPay"),Y=document.getElementById("targetOTPayDisplay"),U=document.getElementById("differenceFromTarget"),G=document.getElementById("totalMonthlyOTHoursDisplay"),W=document.getElementById("totalOTHoursRangeDisplay"),j=document.getElementById("expectedSalaryPayDisplay"),z=document.getElementById("exportSummaryBtn"),J=document.getElementById("userIdDisplay"),X=document.getElementById("allocationStrategySummary"),q=document.getElementById("messageBox"),K=document.getElementById("messageBoxTitle"),V=document.getElementById("messageBoxContent"),Z=document.getElementById("messageBoxCloseBtn"),Q=document.getElementById("messageBoxConfirmBtn"),ee=document.getElementById("messageBoxCancelBtn"),te=document.getElementById("addDetailedOTEntryModal"),ae=document.getElementById("detailedEntryModalTitle"),ne=document.getElementById("detailedEntryDate"),oe=document.getElementById("detailedEntryHours"),se=document.getElementById("detailedEntryHoursError"),le=document.getElementById("detailedEntryStartTime"),ie=document.getElementById("detailedEntryEndTime"),re=document.getElementById("confirmDetailedEntryBtn"),de=document.getElementById("cancelDetailedEntryBtn"),ce=document.getElementById("removeDetailedEntryBtn"),ue=document.getElementById("allocationChoiceModal"),me=document.getElementById("clearAndAllocateBtn"),ye=document.getElementById("fillRemainingBtn"),ge=document.getElementById("cancelAllocationChoiceBtn"),he=document.getElementById("setPublicHolidayTodayBtn"),fe=document.querySelectorAll(".collapsible-header"),Le=document.getElementById("publicHolidaysContent"),pe=document.getElementById("otMultiplierContent"),Ee=document.getElementById("howToUseContent"),ve=document.getElementById("saveDataStatus"),Te=document.getElementById("loadDataStatus"),Ie=document.getElementById("firebaseToggle"),Oe=document.getElementById("firebaseStatusMessage"),Se=document.getElementById("loadingOverlay"),De=document.getElementById("toastContainer"),xe=document.getElementById("chartPlaceholder"),we=document.getElementById("allocateWorkingDay"),Ce=document.getElementById("allocateOffDay"),Fe=document.getElementById("allocateRestDay"),be=document.getElementById("allocatePublicHoliday"),Be=document.getElementById("payProgressContainer"),_e=document.getElementById("payPercentage"),Me=document.getElementById("payProgressBar"),He=document.getElementById("hoursProgressContainer"),Ae=document.getElementById("hoursPercentage"),Ne=document.getElementById("hoursProgressBar"),Ie.checked=Ye,await Rt(),$t(),Gt(),function(){const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),1),a=new Date(e.getFullYear(),e.getMonth()+1,0);Pe.setDate([t,a],!0),s.innerHTML='<option value="">No Target</option>',PREDEFINED_TARGET_PAYS.forEach((e=>{const t=document.createElement("option");t.value=e.toFixed(2),t.textContent=`RM ${e.toFixed(2)}`,s.appendChild(t)}));const n=document.createElement("option");n.value="custom",n.textContent="Other (Enter Manually)",s.appendChild(n),xt(),Ee.classList.add("collapsed"),Le.classList.add("collapsed"),pe.classList.add("collapsed"),vt(),Et(),It(),ut()}()}))})()</script>
</body>
</html>
