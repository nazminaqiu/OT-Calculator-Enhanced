<!doctype html>
<html lang=en>
<head>
<meta charset=UTF-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>Enhanced OT Calculator</title>
<script src=https://cdn.tailwindcss.com></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css>
<script src=https://cdn.jsdelivr.net/npm/flatpickr></script>
<script src=https://cdn.jsdelivr.net/npm/chart.js></script>
<style>:root{--primary-indigo:#6366f1;--dark-indigo:#4f46e5;--light-indigo:#e0e7ff;--lightest-indigo:#c7d2fe;--danger-red:#ef4444;--dark-red:#dc2626;--success-green:#10b981;--info-blue:#3b82f6;--warning-orange:#f59e0b;--gray-900:#1f2937;--gray-800:#374151;--gray-700:#4b5563;--gray-600:#6b7280;--gray-500:#9ca3af;--gray-400:#d1d5db;--gray-300:#e5e7eb;--gray-200:#f3f4f6;--gray-100:#f9fafb;--gray-50:#f9fafb}body{font-family:Inter,sans-serif;background-color:var(--gray-200);display:flex;justify-content:center;align-items:flex-start;min-height:100vh;padding:20px;box-sizing:border-box}.main-wrapper{display:flex;flex-direction:column;gap:25px;max-width:1200px;width:100%}@media (min-width:1024px){.main-wrapper{flex-direction:row;align-items:flex-start}}.form-content{background-color:#fff;padding:30px;border-radius:15px;box-shadow:0 10px 25px rgba(0,0,0,.1);flex-grow:1;width:100%}@media (min-width:1024px){.form-content{min-width:600px}}.summary-sidebar{background-color:#fff;padding:25px;border-radius:15px;box-shadow:0 10px 25px rgba(0,0,0,.1);position:sticky;top:20px;align-self:flex-start;width:100%;min-width:300px;flex-shrink:0}@media (min-width:1024px){.summary-sidebar{width:350px}}.input-group label{font-weight:600;color:var(--gray-800);margin-bottom:8px;display:block}.input-group input,.input-group select{width:100%;padding:12px;border:1px solid var(--gray-400);border-radius:8px;font-size:1rem;color:var(--gray-700);transition:border-color .2s ease-in-out,box-shadow .2s ease-in-out}.input-group input:focus,.input-group select:focus{outline:0;border-color:var(--primary-indigo);box-shadow:0 0 0 3px rgba(99,102,241,.2)}.input-group select:disabled{background-color:var(--gray-200);cursor:not-allowed}.btn{padding:12px 20px;border-radius:8px;font-weight:600;cursor:pointer;transition:background-color .2s ease-in-out,transform .1s ease-in-out;display:inline-flex;align-items:center;justify-content:center;gap:8px}.btn-primary{background-color:var(--primary-indigo);color:#fff}.btn-primary:hover{background-color:var(--dark-indigo);transform:translateY(-1px)}.btn-secondary{background-color:var(--light-indigo);color:var(--dark-indigo)}.btn-secondary:hover{background-color:var(--lightest-indigo);transform:translateY(-1px)}.btn-danger{background-color:var(--danger-red);color:#fff}.btn-danger:hover{background-color:var(--dark-red);transform:translateY(-1px)}.results-section h3{font-size:1.5rem;font-weight:700;color:var(--gray-900);margin-bottom:15px}.results-section p{font-size:1.1rem;margin-bottom:8px;color:var(--gray-800)}.results-section p strong{color:var(--gray-900)}.ot-entry-row{display:flex;flex-direction:column;gap:15px;align-items:stretch;margin-bottom:15px;padding:15px;background-color:var(--gray-100);border-radius:8px;border:1px solid var(--gray-300)}.ot-entry-row .input-group{margin-bottom:0}.ot-entry-row .input-group label{font-size:.85rem;margin-bottom:4px}.ot-entry-row input,.ot-entry-row select{padding:8px;font-size:.9rem}.message-box{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background-color:#fff;padding:30px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.2);z-index:1000;text-align:center;min-width:300px;max-width:90%;border:1px solid var(--gray-400);opacity:0;transform:translate(-50%,-50%) scale(.9);transition:opacity .3s ease-out,transform .3s ease-out}.message-box.show{opacity:1;transform:translate(-50%,-50%) scale(1)}.message-box h4{font-size:1.5rem;font-weight:700;color:var(--gray-900);margin-bottom:15px}.message-box p{font-size:1.1rem;color:var(--gray-700);margin-bottom:25px}.message-box-buttons{display:flex;justify-content:center;gap:15px}.message-box button{background-color:var(--primary-indigo);color:#fff;padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer;transition:background-color .2s ease-in-out}.message-box button:hover{background-color:var(--dark-indigo)}.message-box .btn-cancel{background-color:var(--gray-300);color:var(--gray-700)}.message-box .btn-cancel:hover{background-color:var(--gray-400)}.manual-entry-modal{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);display:flex;justify-content:center;align-items:center;z-index:1000;opacity:0;transition:opacity .3s ease-out}.manual-entry-modal.show{opacity:1}.manual-entry-modal-content{background-color:#fff;padding:30px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.2);text-align:center;min-width:350px;max-width:90%;border:1px solid var(--gray-400);transform:scale(.9);transition:transform .3s ease-out}.manual-entry-modal.show .manual-entry-modal-content{transform:scale(1)}.manual-entry-modal-content h4{font-size:1.5rem;font-weight:700;color:var(--gray-900);margin-bottom:15px}.manual-entry-modal-content .input-group{margin-bottom:20px}.manual-entry-modal-content .modal-buttons{display:flex;justify-content:center;gap:15px}@media (max-width:768px){.form-content,.summary-sidebar{padding:20px}.ot-entry-row .remove-btn-container{display:flex;justify-content:flex-end;margin-top:10px}}.ot-group-section{margin-bottom:20px;padding:15px;background-color:#f0f4f8;border-radius:10px;border:1px solid #e2e8f0}.ot-group-section h4{font-size:1.25rem;font-weight:700;color:#2d3748;margin-bottom:10px;border-bottom:1px solid #cbd5e0;padding-bottom:5px}.loading-indicator{margin-left:10px;font-size:.9em;color:var(--primary-indigo);font-weight:500}#userIdDisplay{font-size:.8em;color:var(--gray-600);text-align:right;margin-top:-15px;margin-bottom:15px;word-break:break-all}.highlight-new{animation:highlightFade 2s ease-out forwards}@keyframes highlightFade{from{background-color:#e0f2fe}to{background-color:var(--gray-100)}}.new-badge{background-color:var(--success-green);color:#fff;padding:2px 8px;border-radius:9999px;font-size:.75rem;font-weight:600;margin-left:8px;display:inline-block;vertical-align:middle}.summary-inline-group{display:flex;flex-wrap:wrap;gap:10px;font-size:1rem;color:var(--gray-800);margin-bottom:8px}.summary-inline-group strong{display:block;width:100%;margin-bottom:4px}.summary-inline-item{display:inline-block;padding:4px 8px;background-color:var(--light-indigo);border-radius:6px;color:var(--dark-indigo);font-weight:500}.collapsible-header{display:flex;justify-content:space-between;align-items:center;cursor:pointer;padding:10px 0;border-bottom:1px solid #cbd5e0;margin-bottom:15px}.collapsible-header h3{margin-bottom:0}.collapsible-content{overflow:hidden;transition:max-height .3s ease-out}.collapsible-content.collapsed{max-height:0!important}.collapsible-icon{transition:transform .3s ease-out}.collapsible-icon.rotated{transform:rotate(90deg)}.input-error{border-color:var(--danger-red);box-shadow:0 0 0 3px rgba(239,68,68,.2)}.error-message{color:var(--danger-red);font-size:.85rem;margin-top:4px}.status-message{margin-left:10px;font-size:.9em;font-weight:500;opacity:0;transition:opacity .3s ease-in-out}.status-message.show{opacity:1}.status-message.loading{color:var(--primary-indigo)}.status-message.success{color:var(--success-green)}.status-message.error{color:var(--danger-red)}.no-entries-message{text-align:center;color:var(--gray-600);padding:20px;border:1px dashed var(--gray-400);border-radius:8px;margin-top:15px}.input-with-clear{position:relative;display:flex;align-items:center}.input-with-clear input{padding-right:36px}.clear-input-btn{position:absolute;right:8px;background:0 0;border:none;cursor:pointer;color:var(--gray-500);padding:4px;border-radius:50%;transition:background-color .2s ease-in-out,color .2s ease-in-out;display:flex;align-items:center;justify-content:center}.clear-input-btn:hover{background-color:var(--gray-300);color:var(--gray-700)}.allocation-choice-modal .modal-buttons button{width:100%}.allocation-choice-modal .modal-buttons{flex-direction:column}.toggle-switch{position:relative;display:inline-block;width:60px;height:34px}.toggle-switch input{opacity:0;width:0;height:0}.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;-webkit-transition:.4s;transition:.4s;border-radius:34px}.slider:before{position:absolute;content:"";height:26px;width:26px;left:4px;bottom:4px;background-color:#fff;-webkit-transition:.4s;transition:.4s;border-radius:50%}input:checked+.slider{background-color:var(--primary-indigo)}input:focus+.slider{box-shadow:0 0 1px var(--primary-indigo)}input:checked+.slider:before{-webkit-transform:translateX(26px);-ms-transform:translateX(26px);transform:translateX(26px)}#toastContainer{position:fixed;bottom:1rem;right:1rem;z-index:2000;display:flex;flex-direction:column;gap:.5rem;max-width:300px}.toast{background-color:#333;color:#fff;padding:.75rem 1rem;border-radius:.5rem;box-shadow:0 4px 12px rgba(0,0,0,.2);opacity:0;transform:translateY(20px);transition:opacity .3s ease-out,transform .3s ease-out}.toast.show{opacity:1;transform:translateY(0)}.toast.info{background-color:var(--info-blue)}.toast.success{background-color:var(--success-green)}.toast.error{background-color:var(--danger-red)}.toast.warning{background-color:var(--warning-orange)}#loadingOverlay{transition:opacity .3s ease-in-out}.loader{border-top-color:var(--primary-indigo);animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}.tooltip-container{position:relative;display:inline-flex;align-items:center;margin-left:.5rem;cursor:help}.tooltip-content{position:absolute;bottom:100%;left:50%;transform:translateX(-50%) translateY(-.5rem);background-color:#333;color:#fff;padding:.5rem .75rem;border-radius:.375rem;font-size:.875rem;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .2s ease-out,transform .2s ease-out;z-index:10}.tooltip-container:hover .tooltip-content{opacity:1;transform:translateX(-50%) translateY(-1rem)}.chart-container{position:relative;width:100%;height:256px;display:flex;align-items:center;justify-content:center;background-color:var(--gray-50);border-radius:8px;overflow:hidden}.chart-placeholder{color:var(--gray-500);font-style:italic;text-align:center;padding:1rem}</style>
</head>
<body>
<div class=main-wrapper>
<div class=form-content>
<h2 class="text-3xl font-extrabold text-center text-gray-900 mb-6">Enhanced OT Calculator</h2>
<div id=userIdDisplay class=hidden></div>
<div class="bg-blue-50 p-6 rounded-xl border border-blue-200 mb-6">
<div class=collapsible-header data-target=howToUseContent>
<h3 class="text-xl font-bold text-blue-800">How to Use This Calculator</h3>
<svg class="collapsible-icon h-6 w-6 text-blue-600" fill=none viewBox="0 0 24 24" stroke=currentColor>
<path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M9 5l7 7-7 7"/>
</svg>
</div>
<div id=howToUseContent class=collapsible-content>
<ul class="list-disc list-inside text-gray-700 space-y-2">
<li><strong>1. Employee Settings:</strong> Enter your basic monthly salary. Optionally, set a target OT pay and/or min/max total hours.</li>
<li><strong>2. OT Planning Date Range:</strong> Define the period for which you want to calculate or plan your overtime.</li>
<li><strong>3. Public Holiday Management:</strong> Add any public holidays within your planning range.</li>
<li><strong>4. OT Multiplier Settings:</strong> Adjust the overtime rates. Note: Rest Day (Sunday) pay is now automatically split for the first 8 hours and after.</li>
<li><strong>5. Daily Overtime Entries:</strong>
<ul class="list-circle list-inside ml-4 mt-1 space-y-1">
<li><strong>Allocation Strategy:</strong> Choose how hours are allocated.
<ul>
<li><strong>Target-Driven:</strong> Automatically selected when you have a "Target OT Pay". This now treats your target as a **minimum**. Choose a sub-strategy:
<ul class="list-square list-inside ml-4">
<li><strong>Balanced:</strong> Uses a human-like, randomized approach to meet your target.</li>
<li><strong>Fastest Path:</strong> Prioritizes high-pay days to meet your target with fewer hours.</li>
<li><strong>Cheapest Path:</strong> Prioritizes low-pay days to maximize hours for a given target.</li>
</ul>
</li>
<li><strong>Workload-Driven:</strong> Automatically selected when you have no target. Allocates hours based on a "Workload Preset".</li>
</ul>
</li>
<li>The logic now ensures your **Min Total OT Hours** target is met if possible, after the pay target is secured.</li>
<li>Click "Auto Allocate Hours" to generate entries based on your chosen strategy.</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-6">
<h3 class="text-xl font-bold text-gray-800 mb-4">Employee Settings</h3>
<div class="grid grid-cols-1 md:grid-cols-2 gap-5">
<div class=input-group>
<label for=basicSalary>Basic Monthly Salary (RM)</label>
<div class=input-with-clear>
<input type=number id=basicSalary value=3700.00 min=0 step=0.01 class=shadow-sm>
<button type=button class=clear-input-btn aria-label="Clear Basic Monthly Salary">
<svg xmlns=http://www.w3.org/2000/svg class="h-4 w-4" fill=none viewBox="0 0 24 24" stroke=currentColor>
<path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M6 18L18 6M6 6l12 12"/>
</svg>
</button>
</div>
</div>
<div class=input-group>
<label for=targetOTPaySelect>Target OT Pay (RM) (Optional)</label>
<select id=targetOTPaySelect class="shadow-sm mb-2">
<option value="">No Target</option>
<option value=custom>Other (Enter Manually)</option>
</select>
<div class=input-with-clear>
<input type=number id=customTargetOTPayInput class="shadow-sm hidden" placeholder="Enter custom target pay">
<button type=button class="clear-input-btn hidden" id=clearCustomTargetOTPayBtn aria-label="Clear Custom Target OT Pay">
<svg xmlns=http://www.w3.org/2000/svg class="h-4 w-4" fill=none viewBox="0 0 24 24" stroke=currentColor>
<path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M6 18L18 6M6 6l12 12"/>
</svg>
</button>
</div>
</div>
<div class=input-group>
<label for=minTotalOTHours>Min Total OT Hours (Optional)
<span class=tooltip-container>
<svg xmlns=http://www.w3.org/2000/svg class="h-4 w-4 text-gray-400" fill=none viewBox="0 0 24 24" stroke=currentColor><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
<span class=tooltip-content>The minimum total OT hours to aim for.</span>
</span>
</label>
<div class=input-with-clear>
<input type=number id=minTotalOTHours min=0 step=0.5 class=shadow-sm placeholder="e.g., 140">
<button type=button class=clear-input-btn id=clearMinTotalOTHoursBtn aria-label="Clear Min Total OT Hours">
<svg xmlns=http://www.w3.org/2000/svg class="h-4 w-4" fill=none viewBox="0 0 24 24" stroke=currentColor><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M6 18L18 6M6 6l12 12"/></svg>
</button>
</div>
<div id=minMaxHoursError class=error-message></div>
</div>
<div class=input-group>
<label for=maxTotalOTHours>Max Total OT Hours (Optional)
<span class=tooltip-container>
<svg xmlns=http://www.w3.org/2000/svg class="h-4 w-4 text-gray-400" fill=none viewBox="0 0 24 24" stroke=currentColor><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
<span class=tooltip-content>The maximum total OT hours not to exceed.</span>
</span>
</label>
<div class=input-with-clear>
<input type=number id=maxTotalOTHours min=0 step=0.5 class=shadow-sm placeholder="e.g., 150">
<button type=button class=clear-input-btn id=clearMaxTotalOTHoursBtn aria-label="Clear Max Total OT Hours">
<svg xmlns=http://www.w3.org/2000/svg class="h-4 w-4" fill=none viewBox="0 0 24 24" stroke=currentColor><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M6 18L18 6M6 6l12 12"/></svg>
</button>
</div>
</div>
</div>
<div class=mt-6>
<label class="block text-xl font-bold text-gray-800 mb-3">Auto-Allocate to:</label>
<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
<div class="flex items-center">
<input type=checkbox id=allocateWorkingDay class="h-5 w-5 text-primary-indigo rounded border-gray-300 focus:ring-primary-indigo" checked>
<label for=allocateWorkingDay class="ml-2 text-gray-700 font-medium">Working Day</label>
</div>
<div class="flex items-center">
<input type=checkbox id=allocateOffDay class="h-5 w-5 text-primary-indigo rounded border-gray-300 focus:ring-primary-indigo" checked>
<label for=allocateOffDay class="ml-2 text-gray-700 font-medium">Off Day</label>
</div>
<div class="flex items-center">
<input type=checkbox id=allocateRestDay class="h-5 w-5 text-primary-indigo rounded border-gray-300 focus:ring-primary-indigo" checked>
<label for=allocateRestDay class="ml-2 text-gray-700 font-medium">Rest Day</label>
</div>
<div class="flex items-center">
<input type=checkbox id=allocatePublicHoliday class="h-5 w-5 text-primary-indigo rounded border-gray-300 focus:ring-primary-indigo" checked>
<label for=allocatePublicHoliday class="ml-2 text-gray-700 font-medium">Public Holiday</label>
</div>
</div>
</div>
<p class="text-sm text-gray-600 mt-4">
Working Schedule: 5 days/week, Saturday: Off Day, Sunday: Rest Day. For payroll, employer uses 26 working days monthly.
</p>
</div>
<div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-6">
<h3 class="text-xl font-bold text-gray-800 mb-4">OT Planning Date Range</h3>
<div class=input-group>
<label for=dateRangeInput>Select Date Range</label>
<div class="flex items-center gap-2">
<input id=dateRangeInput class="shadow-sm flex-grow" placeholder="Click to select date range" readonly>
<button type=button id=setThisMonthBtn class="btn btn-secondary p-2" aria-label="Set date range to this month">
This Month
</button>
</div>
<div id=dateRangeError class=error-message></div>
</div>
</div>
<div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-6">
<div class=collapsible-header data-target=publicHolidaysContent>
<h3 class="text-xl font-bold text-gray-800">Public Holiday Management</h3>
<svg class="collapsible-icon h-6 w-6 text-gray-600" fill=none viewBox="0 0 24 24" stroke=currentColor>
<path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M9 5l7 7-7 7"/>
</svg>
</div>
<div id=publicHolidaysContent class=collapsible-content>
<div class="flex flex-col sm:flex-row gap-4 mb-4">
<div class="input-group flex-grow">
<label for=publicHolidayDate>Add Public Holiday Date</label>
<div class="flex items-center gap-2">
<input type=date id=publicHolidayDate class="shadow-sm flex-grow">
<button type=button id=setPublicHolidayTodayBtn class="btn btn-secondary p-2" aria-label="Set public holiday date to today">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor><path fill-rule=evenodd d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule=evenodd /></svg>
</button>
</div>
</div>
<button id=addPublicHolidayDateBtn class="btn btn-secondary mt-auto" aria-label="Add public holiday">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor><path fill-rule=evenodd d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule=evenodd /></svg>
Add Holiday
</button>
</div>
<ul id=publicHolidaysList class="list-disc list-inside ml-4 text-gray-700">
</ul>
</div>
</div>
<div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-6">
<div class=collapsible-header data-target=otMultiplierContent>
<h3 class="text-xl font-bold text-gray-800">OT Multiplier Settings</h3>
<svg class="collapsible-icon h-6 w-6 text-gray-600" fill=none viewBox="0 0 24 24" stroke=currentColor>
<path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M9 5l7 7-7 7"/>
</svg>
</div>
<div id=otMultiplierContent class=collapsible-content>
<div id=otMultiplierInputs class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-4">
</div>
<button id=resetMultipliersBtn class="btn btn-secondary" aria-label="Reset OT multipliers to default">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor><path fill-rule=evenodd d="M4 2a1 1 0 011 1v2.118a1 1 0 01-.293.707l-2.118 2.118A1 1 0 012 8v8a2 2 0 002 2h12a2 2 0 002-2V8a1 1 0 01-.293-.707l-2.118-2.118A1 1 0 0115 5.118V3a1 1 0 011-1h-2a1 1 0 01-1-1V1a1 1 0 10-2 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1V1a1 1 0 10-2 0v1a1 1 0 01-1 1H4zm2 5V4h8v3H6zm-2 4h12V9H4v2zm0 2h12v3H4v-3z" clip-rule=evenodd /></svg>
Reset to Default Multipliers
</button>
</div>
</div>
<div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
<h3 class="text-xl font-bold text-gray-800 mb-4">Daily Overtime Entries</h3>
<div class="input-group mb-4">
<label for=allocationStrategy>Allocation Strategy
<span class=tooltip-container>
<svg xmlns=http://www.w3.org/2000/svg class="h-4 w-4 text-gray-400" fill=none viewBox="0 0 24 24" stroke=currentColor><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
<span class=tooltip-content>This is set automatically based on Target OT Pay.</span>
</span>
</label>
<select id=allocationStrategy class=shadow-sm aria-describedby=allocationStrategyDescription>
<option value=Target-Driven>Target-Driven (using Workload Presets)</option>
<option value=Workload-Driven>Workload-Driven (Fill All Days)</option>
</select>
<p id=allocationStrategyDescription class="text-sm text-gray-600 mt-2"></p>
</div>
<div id=targetDrivenStrategyGroup class="input-group mb-4 hidden">
<label for=targetAllocationStrategy>Target-Driven Strategy
<span class=tooltip-container>
<svg xmlns=http://www.w3.org/2000/svg class="h-4 w-4 text-gray-400" fill=none viewBox="0 0 24 24" stroke=currentColor><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
<span class=tooltip-content>Choose how to meet your OT pay target.</span>
</span>
</label>
<select id=targetAllocationStrategy class=shadow-sm aria-describedby=targetAllocationStrategyDescription>
<option value=Balanced>Balanced (Human-like)</option>
<option value="Fastest Path">Fastest Path (Fewest Hours)</option>
<option value="Cheapest Path">Cheapest Path (Most Hours)</option>
</select>
<p id=targetAllocationStrategyDescription class="text-sm text-gray-600 mt-2"></p>
</div>
<div id=workloadPresetGroup class="input-group mb-4">
<label for=workloadPreset>Workload Preset for Auto Allocation
<span class=tooltip-container>
<svg xmlns=http://www.w3.org/2000/svg class="h-4 w-4 text-gray-400" fill=none viewBox="0 0 24 24" stroke=currentColor><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
<span class=tooltip-content>Defines min/max hours for different day types.</span>
</span>
</label>
<select id=workloadPreset class=shadow-sm aria-describedby=workloadPresetDescription>
<option value="Moderate Workload">Moderate Workload</option>
<option value="Light Workload">Light Workload</option>
<option value="Heavy Workload">Heavy Workload</option>
</select>
<p id=workloadPresetDescription class="text-sm text-gray-600 mt-2"></p>
</div>
<div id=workloadPresetDetails class="text-sm text-gray-700 mb-4 p-3 bg-gray-100 rounded-md border border-gray-200">
</div>
<div class="flex flex-col sm:flex-row gap-4 mb-4">
<button id=autoAllocateBtn class="btn btn-secondary flex-grow" aria-label="Auto allocate hours">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor><path d="M17.293 3.293a1 1 0 011.414 0l-2.293 2.293a1 1 0 01-1.414-1.414l2.293-2.293zM9 12a3 3 0 100-6 3 3 0 000 6z"/><path fill-rule=evenodd d="M15.293 10.293a1 1 0 010 1.414l-2.293 2.293a1 1 0 01-1.414-1.414l2.293-2.293a1 1 0 011.414 0zM4.707 4.707a1 1 0 010 1.414L2.414 8.414a1 1 0 01-1.414-1.414L3.293 4.707a1 1 0 011.414 0zM12 9a3 3 0 10-6 0 3 3 0 006 0z" clip-rule=evenodd /></svg>
Auto Allocate Hours
<span id=autoAllocateLoading class="loading-indicator hidden" aria-live=polite>Allocating...</span>
</button>
</div>
<div id=otEntriesContainer>
<p id=noEntriesMessage class="no-entries-message hidden">No OT entries yet. Click "Add OT Entry" or "Auto Allocate Hours" to get started!</p>
</div>
<div class="flex flex-col sm:flex-row gap-4 mt-4">
<button id=addOTEntryBtn class="btn btn-secondary flex-grow" aria-label="Add new OT entry">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor><path fill-rule=evenodd d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule=evenodd /></svg>
Add OT Entry
</button>
<button id=clearAllEntriesBtn class="btn btn-danger flex-grow" aria-label="Clear all OT entries">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor><path fill-rule=evenodd d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule=evenodd /></svg>
Clear All Entries
</button>
</div>
<div class="flex flex-col sm:flex-row gap-4 mt-4">
<button id=saveDataBtn class="btn btn-primary flex-grow" aria-label="Save current data">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor><path d="M7 3a1 1 0 00-1 1v1a1 1 0 001 1h6a1 1 0 001-1V4a1 1 0 00-1-1H7z"/><path fill-rule=evenodd d="M18 8H2a2 2 0 00-2 2v8a2 2 0 002 2h16a2 2 0 002-2v-8a2 2 0 00-2-2zM4 13a1 1 0 011-1h10a1 1 0 011 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-3z" clip-rule=evenodd /></svg>
Save Data
<span id=saveDataStatus class=status-message aria-live=polite></span>
</button>
<button id=loadDataBtn class="btn btn-secondary flex-grow" aria-label="Load saved data">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor><path fill-rule=evenodd d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule=evenodd /></svg>
Load Data
<span id=loadDataStatus class=status-message aria-live=polite></span>
</button>
</div>
</div>
<div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mt-6 flex items-center justify-between">
<label for=firebaseToggle class="text-xl font-bold text-gray-800 cursor-pointer">
Enable Firebase (Save/Load)
</label>
<label class=toggle-switch>
<input type=checkbox id=firebaseToggle>
<span class=slider></span>
</label>
</div>
<p id=firebaseStatusMessage class="text-sm text-gray-600 mt-2 text-center"></p>
<button id=resetAndReallocateBtn class="btn btn-danger w-full mt-4" aria-label="Reset all and re-allocate">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor><path fill-rule=evenodd d="M4 2a1 1 0 011 1v2.118a1 1 0 01-.293.707l-2.118 2.118A1 1 0 012 8v8a2 2 0 002 2h12a2 2 0 002-2V8a1 1 0 01-.293-.707l-2.118-2.118A1 1 0 0115 5.118V3a1 1 0 011-1h-2a1 1 0 01-1-1V1a1 1 0 10-2 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1V1a1 1 0 10-2 0v1a1 1 0 01-1 1H4zm2 5V4h8v3H6zm-2 4h12V9H4v2zm0 2h12v3H4v-3z" clip-rule=evenodd /></svg>
Reset & Re-allocate All
</button>
</div>
<div class=summary-sidebar>
<div id=results class=results-section>
<h3 class="text-2xl font-bold text-gray-900 mb-4">Calculation Summary</h3>
<div class=summary-inline-group>
<strong>Total OT Hours by Type:</strong>
<span id=totalHoursByType class=text-gray-700></span>
</div>
<div class=summary-inline-group>
<strong>Total Pay per OT Category:</strong>
<span id=totalPayByCategory class=text-gray-700></span>
</div>
<p class="text-base font-bold text-gray-900 mt-2">Allocation Strategy: <span id=allocationStrategySummary class=text-gray-700></span></p>
<p class="text-xl font-bold text-gray-900 mt-6">Combined OT Pay: <span id=combinedOTPay class=text-indigo-600>RM 0.00</span></p>
<p class="text-xl font-bold text-gray-900 mt-2">Target OT Pay: <span id=targetOTPayDisplay class=text-green-600>RM 0.00</span></p>
<p class="text-xl font-bold mt-2">Difference from Target: <span id=differenceFromTarget>RM 0.00</span></p>
<p class="text-xl font-bold mt-2">Total Monthly OT Hours: <span id=totalMonthlyOTHoursDisplay>0.0 hours</span></p>
<p class="text-xl font-bold mt-2">Total OT Hours Range: <span id=totalOTHoursRangeDisplay>N/A</span></p>
<p class="text-xl font-bold text-gray-900 mt-2">Expected Salary Pay: <span id=expectedSalaryPayDisplay class=text-indigo-600>RM 0.00</span></p>
<h4 class="text-lg font-bold text-gray-800 mt-6 mb-2">OT Pay Distribution</h4>
<div class=chart-container>
<canvas id=otDistributionChart class="w-full h-full"></canvas>
<p id=chartPlaceholder class="chart-placeholder absolute hidden">No OT data to display. Add entries and calculate!</p>
</div>
<button id=exportSummaryBtn class="btn btn-secondary mt-6" aria-label="Export OT summary to text file">
<svg xmlns=http://www.w3.org/2000/svg class="h-5 w-5" viewBox="0 0 20 20" fill=currentColor><path fill-rule=evenodd d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L10 11.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule=evenodd /></svg>
Export Summary
</button>
</div>
</div>
</div>
<div id=messageBox class="message-box hidden" role=dialog aria-modal=true aria-labelledby=messageBoxTitle aria-describedby=messageBoxContent>
<h4 id=messageBoxTitle></h4>
<p id=messageBoxContent></p>
<div class=message-box-buttons>
<button id=messageBoxCancelBtn class="btn btn-cancel hidden">Cancel</button>
<button id=messageBoxConfirmBtn class=hidden>Confirm</button>
<button id=messageBoxCloseBtn>OK</button>
</div>
</div>
<div id=addDetailedOTEntryModal class="manual-entry-modal hidden" role=dialog aria-modal=true aria-labelledby=detailedEntryModalTitle>
<div class=manual-entry-modal-content>
<h4 id=detailedEntryModalTitle class="text-2xl font-bold text-gray-900 mb-4">Add Detailed OT Entry</h4>
<div class=input-group>
<label for=detailedEntryDate>Select Date</label>
<input type=date id=detailedEntryDate class=shadow-sm>
<div id=detailedEntryDateError class="error-message text-left"></div>
</div>
<div class=input-group>
<label for=detailedEntryHours>Hours</label>
<input type=number id=detailedEntryHours value=2.0 min=0.5 step=0.5 class=shadow-sm>
<div id=detailedEntryHoursError class="error-message text-left"></div>
</div>
<div class=input-group>
<label for=detailedEntryStartTime>Start Time</label>
<input type=time id=detailedEntryStartTime value=18:00 class=shadow-sm>
<div id=detailedEntryStartTimeError class="error-message text-left"></div>
</div>
<div class=input-group>
<label for=detailedEntryEndTime>End Time (Calculated)</label>
<input type=time id=detailedEntryEndTime class=shadow-sm readonly>
</div>
<div class=modal-buttons>
<button id=cancelDetailedEntryBtn class="btn btn-cancel">Cancel</button>
<button id=confirmDetailedEntryBtn class="btn btn-primary">Add Entry</button>
</div>
</div>
</div>
<div id=allocationChoiceModal class="manual-entry-modal hidden allocation-choice-modal" role=dialog aria-modal=true aria-labelledby=allocationChoiceModalTitle>
<div class=manual-entry-modal-content>
<h4 id=allocationChoiceModalTitle class="text-2xl font-bold text-gray-900 mb-4">Auto-Allocation Options</h4>
<p class="text-gray-700 mb-6">How would you like to allocate overtime hours?</p>
<div class=modal-buttons>
<button id=clearAndAllocateBtn class="btn btn-danger">
Auto Allocate
</button>
<button id=fillRemainingBtn class="btn btn-primary mt-4">
Fill Remaining Hours
</button>
<button id=cancelAllocationChoiceBtn class="btn btn-secondary mt-4">
Cancel
</button>
</div>
</div>
</div>
<div id=loadingOverlay class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[3000] hidden">
<div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-16 w-16"></div>
</div>
<div id=toastContainer></div>
<script type=module>import{initializeApp}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";import{getAuth,signInAnonymously,signInWithCustomToken,onAuthStateChanged}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";import{getFirestore,doc,getDoc,setDoc}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";const DEFAULT_OT_MULTIPLIERS={"Normal OT (Weekdays)":1.5,"Off Day (Saturday)":1.5,"Rest Day (Sunday)":.5,"Rest Day (Sunday) - After 8h":2,"Public Holiday":2},DISPLAYABLE_OT_TYPES=["Normal OT (Weekdays)","Off Day (Saturday)","Rest Day (Sunday)","Public Holiday"],PREDEFINED_TARGET_PAYS=[1e3,2e3,3e3,4e3,5e3],CONFIG={WORKING_DAYS_MONTHLY:26,STANDARD_WORK_HOURS_DAILY:8,MAX_DAILY_OT_HOURS:8,ALLOCATION_PRECISION:.01,OT_MULTIPLIERS:{...DEFAULT_OT_MULTIPLIERS},WORKLOAD_PRESETS:{"Light Workload":{"Normal OT (Weekdays)":{minHours:1,maxHours:5},"Off Day (Saturday)":{minHours:2,maxHours:5},"Rest Day (Sunday)":{minHours:2,maxHours:6}},"Moderate Workload":{"Normal OT (Weekdays)":{minHours:2,maxHours:7},"Off Day (Saturday)":{minHours:3,maxHours:8},"Rest Day (Sunday)":{minHours:4,maxHours:8}},"Heavy Workload":{"Normal OT (Weekdays)":{minHours:3,maxHours:8},"Off Day (Saturday)":{minHours:5,maxHours:8},"Rest Day (Sunday)":{minHours:6,maxHours:8}}}};(async()=>{let e,t,a,n,o,s,i,r,l,d,c,u,m,y,g,f,h,p,L,T,v,E,I,O,D,S,w,x,C,b,F,_,H,A,B,N,P,M,$,R,k,Y,U,G,W,j,q,z,X,J,K,V,Z,Q,ee,te,ae,ne,oe,se,ie,re,le,de,ce,ue,me,ye,ge,fe,he,pe,Le,Te,ve,Ee,Ie,Oe,De,Se,we,xe,Ce,be,Fe,_e,He,Ae,Be,Ne,Pe,Me=null,$e=!1,Re=JSON.parse(localStorage.getItem("isFirebaseEnabled")||"true"),ke=[],Ye=[],Ue=0,Ge="Moderate Workload",We="Target-Driven";function je(e,t){let a;return function(...n){const o=this;clearTimeout(a),a=setTimeout((()=>e.apply(o,n)),t)}}async function qe(){return new Promise((e=>setTimeout(e,0)))}function ze(e,t,a="info",n=null){"info"!==a?(Z.textContent=e,Q.textContent=t,ee.classList.add("hidden"),te.classList.add("hidden"),ae.classList.add("hidden"),"confirm"===a?(te.onclick=()=>{V.classList.add("hidden"),V.classList.remove("show"),n&&n(),window.lastFocusedElement&&window.lastFocusedElement.focus()},ae.onclick=()=>{V.classList.add("hidden"),V.classList.remove("show"),window.lastFocusedElement&&window.lastFocusedElement.focus()},te.classList.remove("hidden"),ae.classList.remove("hidden")):(ee.onclick=()=>{V.classList.add("hidden"),V.classList.remove("show"),window.lastFocusedElement&&window.lastFocusedElement.focus()},ee.classList.remove("hidden")),V.classList.remove("hidden"),V.classList.add("show"),window.lastFocusedElement=document.activeElement,te.focus()):Xe(t,"info")}function Xe(e,t="info"){const a=document.createElement("div");a.classList.add("toast",t),a.textContent=e,Ce.appendChild(a),a.offsetWidth,a.classList.add("show"),setTimeout((()=>{a.classList.remove("show"),a.addEventListener("transitionend",(()=>{a.remove()}),{once:!0})}),3e3)}function Je(){xe.classList.remove("hidden"),xe.style.opacity="0",xe.offsetWidth,xe.style.opacity="1"}function Ke(){xe.style.opacity="0",xe.addEventListener("transitionend",(function e(){xe.classList.add("hidden"),xe.removeEventListener("transitionend",e)}),{once:!0})}function Ve(e,t,a){e.textContent=t,e.className=`status-message show ${a}`,e.setAttribute("aria-live","polite"),"loading"!==a&&setTimeout((()=>{e.classList.remove("show"),e.removeAttribute("aria-live")}),2e3)}function Ze(){if("custom"===s.value){const e=parseFloat(i.value);return isNaN(e)?null:e}return""===s.value?null:parseFloat(s.value)}function Qe(){const e=parseFloat(l.value),t=parseFloat(c.value);return{minHours:isNaN(e)?null:e,maxHours:isNaN(t)?null:t}}function et(){const{minHours:e,maxHours:t}=Qe();return m.textContent="",l.classList.remove("input-error"),c.classList.remove("input-error"),!(null!==e&&null!==t&&e>t)||(m.textContent="Min hours cannot be greater than Max hours.",l.classList.add("input-error"),c.classList.add("input-error"),!1)}function tt(e){return e<=0?0:e/CONFIG.WORKING_DAYS_MONTHLY/CONFIG.STANDARD_WORK_HOURS_DAILY}function at(e,t,a,n){let o=0;const s=Ot(n)?"Public Holiday":a;if("Rest Day (Sunday)"===s){const a=CONFIG.OT_MULTIPLIERS["Rest Day (Sunday)"],n=CONFIG.OT_MULTIPLIERS["Rest Day (Sunday) - After 8h"];if(t<=8)o=e*a*t;else{o=e*a*8+e*n*(t-8)}}else{const a=CONFIG.OT_MULTIPLIERS[s];if(void 0===a)return console.warn(`Unknown OT type or multiplier for type: ${s}`),0;o=e*a*t}return o}function nt(e){return`RM ${e.toFixed(2)}`}function ot(){const e=new Date;return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function st(e,t){if(!e)return"";const[a,n]=e.split(":").map(Number);let o=60*a+n+60*t,s=Math.floor(o/60)%24,i=Math.round(o%60);return 60===i&&(i=0,s=(s+1)%24),`${String(s).padStart(2,"0")}:${String(i).padStart(2,"0")}`}function it(e,t=null){const a=Math.floor(4*Math.random())+18,n=[0,15,30,45],o=n[Math.floor(Math.random()*n.length)],s=`${String(a).padStart(2,"0")}:${String(o).padStart(2,"0")}`;e.startTime=s,e.endTime=st(e.startTime,e.hours)}function rt(){ke=[],F.innerHTML="",Ue=0,_.classList.remove("hidden")}function lt(e){if(Ot(e))return"Public Holiday";switch(new Date(e).getDay()){case 0:return"Rest Day (Sunday)";case 6:return"Off Day (Saturday)";default:return"Normal OT (Weekdays)"}}async function dt(){F.innerHTML="";const e=Be.selectedDates,t=e[0]?new Date(e[0].toISOString().split("T")[0]):null,a=e[1]?new Date(e[1].toISOString().split("T")[0]):null;let n=ke;t&&a&&(n=ke.filter((e=>{const n=new Date(e.date);return n.setHours(0,0,0,0),n>=t&&n<=a}))),0===n.length?_.classList.remove("hidden"):_.classList.add("hidden");const o=n.map((e=>({...e,displayType:lt(e.date)}))).reduce(((e,t)=>((e[t.displayType]=e[t.displayType]||[]).push(t),e)),{}),s=DISPLAYABLE_OT_TYPES;for(const t of s)if(o[t]&&o[t].length>0){const a=document.createElement("div");a.classList.add("ot-group-section");const n=document.createElement("h4");n.textContent=t,a.appendChild(n),o[t].sort(((e,t)=>new Date(e.date)-new Date(t.date)));for(const n of o[t])await new Promise((t=>requestAnimationFrame((()=>{const o=n.id,s=document.createElement("div");s.classList.add("ot-entry-row","flex","flex-col","gap-4"),s.setAttribute("data-id",o),n.isNew&&(s.classList.add("highlight-new"),setTimeout((()=>{s.classList.remove("highlight-new");const e=ke.findIndex((e=>e.id===o));-1!==e&&delete ke[e].isNew}),2e3));const i=lt(n.date);s.innerHTML=`\n                                    <div class="grid grid-cols-2 gap-4 items-end">\n                                        <div class="input-group">\n                                            <label for="${o}-date">Date${n.isNew?'<span class="new-badge">New</span>':""}</label>\n                                            <input type="date" id="${o}-date" value="${n.date}" class="shadow-sm">\n                                        </div>\n                                        <div class="input-group">\n                                            <label for="${o}-hours">Hours</label>\n                                            <input type="number" id="${o}-hours" value="${n.hours.toFixed(1)}" min="0" step="0.5" class="shadow-sm">\n                                            <div id="${o}-hours-error" class="error-message"></div>\n                                        </div>\n                                    </div>\n                                    <div class="flex gap-4">\n                                        <div class="input-group flex-1">\n                                            <label for="${o}-start-time">Start Time</label>\n                                            <input type="time" id="${o}-start-time" value="${n.startTime}" class="shadow-sm">\n                                            <div id="${o}-start-time-error" class="error-message"></div>\n                                        </div>\n                                        <div class="input-group flex-1">\n                                            <label for="${o}-end-time">End Time</label>\n                                            <input type="time" id="${o}-end-time" class="shadow-sm" readonly>\n                                        </div>\n                                    </div>\n                                    <div class="grid grid-cols-[1.8fr_auto] gap-4 items-end">\n                                        <div class="input-group">\n                                            <label for="${o}-type">OT Type</label>\n                                            <select id="${o}-type" class="shadow-sm" disabled>\n                                                ${DISPLAYABLE_OT_TYPES.map((e=>`<option value="${e}">${e}</option>`)).join("")}\n                                            </select>\n                                        </div>\n                                        <div class="remove-btn-container flex justify-end">\n                                            <button type="button" class="btn btn-danger btn-sm remove-ot-entry-btn" data-id="${o}" aria-label="Remove OT entry for ${n.date}">\n                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" /></svg>\n                                            </button>\n                                        </div>\n                                    </div>\n                                `,a.appendChild(s);const r=s.querySelector(`#${o}-type`);r&&(r.value=i);const l=s.querySelector(`#${o}-end-time`);l&&(l.value=n.endTime);const d=s.querySelector(`#${o}-date`);if(d){const t=ke.filter((e=>e.id!==o)).map((e=>e.date));window.flatpickr(d,{dateFormat:"Y-m-d",minDate:e[0]?e[0]:null,maxDate:e[1]?e[1]:null,disable:t,onChange:function(e,t,a){ct(o,"date",t)}})}const c=s.querySelector(`#${o}-start-time`);c&&window.flatpickr(c,{enableTime:!0,noCalendar:!0,dateFormat:"H:i",time_24hr:!0,minuteIncrement:15,onChange:function(e,t,a){ct(o,"startTime",t)}});const u=s.querySelector(`#${o}-hours`),m=s.querySelector(`#${o}-hours-error`);u.addEventListener("input",(e=>{const t=parseFloat(e.target.value);isNaN(t)||t<0?(u.classList.add("input-error"),m.textContent="Hours must be a positive number."):t>CONFIG.MAX_DAILY_OT_HOURS?(u.classList.add("input-error"),m.textContent=`Max hours per day is ${CONFIG.MAX_DAILY_OT_HOURS}.`):(u.classList.remove("input-error"),m.textContent="",ct(o,"hours",t))})),s.querySelector(".remove-ot-entry-btn").addEventListener("click",(()=>{ze("Confirm Removal","Are you sure you want to remove this OT entry? This action cannot be undone.","confirm",(()=>{ke=ke.filter((e=>e.id!==o)),dt(),mt(),Xe("Entry Removed","success")}))})),t()}))));F.appendChild(a)}}function ct(e,t,a){const n=ke.findIndex((t=>t.id===e));if(-1===n)return;const o={...ke[n]};if("date"===t){const t=a,s=Be.selectedDates,i=s[0]?new Date(s[0].toISOString().split("T")[0]):null,r=s[1]?new Date(s[1].toISOString().split("T")[0]):null,l=new Date(t);if(i&&r&&(l<i||l>r))return Xe(`Date ${t} is outside the current planning range.`,"error"),void(document.querySelector(`#${e}-date`).value=o.date);if(ke.some((a=>a.id!==e&&a.date===t)))return ze("Duplicate Date Warning",`An OT entry already exists for ${t}. Please choose a different date.`),void(document.querySelector(`#${e}-date`).value=o.date);ke[n].date=t,ke[n].type=lt(t)}else if("hours"===t){const e=parseFloat(a);e<=0?(ke.splice(n,1),Xe("Entry removed as hours were set to 0 or less.","info")):(ke[n].hours=e,ke[n].endTime=st(ke[n].startTime,ke[n].hours))}else"startTime"===t?(ke[n].startTime=a,ke[n].endTime=st(ke[n].startTime,ke[n].hours)):ke[n][t]=a;dt(),mt()}function ut(){ze("Confirm Clear All","Are you sure you want to clear all daily OT entries? This action cannot be undone.","confirm",(()=>{rt(),Xe("All entries cleared!","success"),mt()}))}function mt(){const e=parseFloat(n.value),t=Ze(),{minHours:a,maxHours:o}=Qe(),s=Be.selectedDates,i=s[0]?s[0].toISOString().split("T")[0]:"",r=s[1]?s[1].toISOString().split("T")[0]:"";if(isNaN(e)||e<=0)return k.innerHTML="",Y.innerHTML="",U.textContent=nt(0),j.textContent="0.0 hours",z.textContent=nt(0),G.textContent="N/A (No target set)",G.classList.remove("text-green-600"),G.classList.add("text-gray-600"),W.textContent="N/A (No target set)",W.classList.remove("text-green-600","text-red-600"),W.classList.add("text-gray-600"),K.textContent=We,q.textContent="N/A",q.classList.remove("text-green-600","text-red-600","text-orange-600"),q.classList.add("text-gray-600"),void yt([],[]);const l=tt(e);let d={},c={},u=0,m=0;DISPLAYABLE_OT_TYPES.forEach((e=>{d[e]=0,c[e]=0})),ke.forEach((e=>{const t=new Date(e.date),a=i?new Date(i):null,n=r?new Date(r):null;if(a&&n&&(t.setHours(0,0,0,0),a.setHours(0,0,0,0),n.setHours(0,0,0,0),t<a||t>n))return;const o=parseFloat(e.hours);if(isNaN(o)||o<=0)return;const s=lt(e.date),y=at(l,o,e.type,e.date);d[s]+=o,c[s]+=y,u+=y,m+=o}));const y=e+u;let g=[];DISPLAYABLE_OT_TYPES.forEach((e=>{d[e]>0&&g.push(`<span class="summary-inline-item">${e}: ${d[e].toFixed(1)}h</span>`)})),k.innerHTML=g.join("");let f=[],h=[],p=[];if(DISPLAYABLE_OT_TYPES.forEach((e=>{c[e]>0&&(f.push(`<span class="summary-inline-item">${e}: ${nt(c[e])}</span>`),h.push(e),p.push(c[e]))})),Y.innerHTML=f.join(""),yt(h,p,["#6366f1","#ef4444","#f59e0b","#10b981","#3b82f6"]),U.textContent=nt(u),j.textContent=`${m.toFixed(1)} hours`,z.textContent=nt(y),K.textContent=We,"Target-Driven"===We){const e=D.options[D.selectedIndex].text;K.textContent+=` (${e})`}if(null===t||t<=0)G.textContent="N/A (No target set)",G.classList.remove("text-green-600"),G.classList.add("text-gray-600"),W.textContent="N/A (No target set)",W.classList.remove("text-green-600","text-red-600"),W.classList.add("text-gray-600");else{G.textContent=nt(t),G.classList.remove("text-gray-600"),G.classList.add("text-green-600");const e=u-t;W.textContent=nt(e),e>=0?(W.classList.remove("text-red-600","text-gray-600"),W.classList.add("text-green-600")):(W.classList.remove("text-green-600","text-gray-600"),W.classList.add("text-red-600"))}q.classList.remove("text-green-600","text-red-600","text-orange-600","text-gray-600"),null!==a&&null!==o?(q.textContent=`${a.toFixed(1)}h - ${o.toFixed(1)}h`,m>=a&&m<=o?q.classList.add("text-green-600"):m<a?q.classList.add("text-orange-600"):q.classList.add("text-red-600")):null!==a?(q.textContent=`Min: ${a.toFixed(1)}h`,m>=a?q.classList.add("text-green-600"):q.classList.add("text-orange-600")):null!==o?(q.textContent=`Max: ${o.toFixed(1)}h`,m<=o?q.classList.add("text-green-600"):q.classList.add("text-red-600")):(q.textContent="N/A",q.classList.add("text-gray-600"))}function yt(e,t,a){const n=document.getElementById("otDistributionChart").getContext("2d");if(0===t.length||t.every((e=>0===e)))return Me&&(Me.destroy(),Me=null),void be.classList.remove("hidden");be.classList.add("hidden"),Me?(Me.data.labels=e,Me.data.datasets[0].data=t,Me.data.datasets[0].backgroundColor=a,Me.update()):Me=new Chart(n,{type:"pie",data:{labels:e,datasets:[{label:"OT Pay (RM)",data:t,backgroundColor:a,hoverOffset:4}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"right",labels:{font:{family:"Inter"}}},tooltip:{callbacks:{label:function(e){let t=e.label||"";return t&&(t+=": "),null!==e.parsed&&(t+=nt(e.parsed)),t}},bodyFont:{family:"Inter"},titleFont:{family:"Inter"}}}}})}function gt(){const e=Math.random();if(e<.3)return 2;if(e<.55)return 4;if(e<.7)return 1;if(e<.8)return 3;if(e<.85)return 8;const t=[.5,1.5,2.5,3.5,4.5,5,5.5,6,6.5,7,7.5];return t[Math.floor(Math.random()*t.length)]}function ft(e,t,a){const n=ke.findIndex((t=>t.date===e)),o=parseFloat(t.toFixed(1));if(!(o<=CONFIG.ALLOCATION_PRECISION&&-1===n))if(-1!==n)ke[n].hours+=o,ke[n].endTime=st(ke[n].startTime,ke[n].hours);else{const t={id:"ot-entry-"+Ue++,date:e,hours:o,type:a,startTime:"",endTime:"",isNew:!0};it(t),ke.push(t)}}function ht(){ke.sort(((e,t)=>{const a=new Date(e.date),n=new Date(t.date);return a-n!=0?a-n:parseInt(e.id.split("-")[2])-parseInt(t.id.split("-")[2])}));let e={};ke.forEach((t=>{t.startTime&&t.endTime?t.endTime=st(t.startTime,t.hours):it(t,e[t.date]||null),e[t.date]=t.endTime}))}function pt(){Ge=w.value;const e=CONFIG.WORKLOAD_PRESETS[Ge];let t=`<strong>${Ge} Details:</strong><ul class="list-disc list-inside ml-4">`;DISPLAYABLE_OT_TYPES.forEach((a=>{const n=e[a];n&&(t+=`<li>${a}: ${n.minHours.toFixed(1)} - ${n.maxHours.toFixed(1)} hours</li>`)})),t+="</ul>",b.innerHTML=t,C.textContent="This preset suggests daily OT hours for different day types to guide auto-allocation."}function Lt(){const e=Ze(),t=null!==e&&e>0;E.value=t?"Target-Driven":"Workload-Driven",We=E.value,E.disabled=!0,"Target-Driven"===We?(I.textContent='The calculator will allocate hours to reach your "Target OT Pay".',O.classList.remove("hidden"),x.classList.add("hidden"),b.classList.add("hidden"),Tt()):(I.textContent='Hours will be allocated for all days in your range according to the "Workload Preset".',O.classList.add("hidden"),x.classList.remove("hidden"),b.classList.remove("hidden")),mt()}function Tt(){const e=D.value;let t="";"Balanced"===e?t="Randomly allocates hours across available days to meet the target.":"Fastest Path"===e?t="Prioritizes high-pay days (e.g., Public Holidays) to reach the target with minimum hours.":"Cheapest Path"===e&&(t="Prioritizes low-pay days (e.g., Weekdays) to maximize hours for the target."),S.textContent=t}function vt(){if(h._flatpickr){const e=Be.selectedDates,t=Ft(e[0]),a=Ft(e[1]);h._flatpickr.set("minDate",t),h._flatpickr.set("maxDate",a),h._flatpickr.redraw()}}function Et(){const e=h.value,t=Be.selectedDates,a=t[0]?t[0].toISOString().split("T")[0]:"",n=t[1]?t[1].toISOString().split("T")[0]:"";if(!e)return void Xe("Please select a date for the public holiday.","error");if(!a||!n||new Date(e)<new Date(a)||new Date(e)>new Date(n))return void Xe("Public Holiday date must be within the OT Planning Date Range.","error");if(Ye.includes(e))return void Xe(`${e} is already in the public holidays list.`,"warning");Ye.push(e),Ye.sort(),It();const o=document.querySelector('.collapsible-header[data-target="publicHolidaysContent"]'),s=o?o.querySelector(".collapsible-icon"):null;ve.classList.contains("collapsed")&&kt(ve,s,!0),dt(),mt(),Xe("Public Holiday added successfully!","success")}function It(){L.innerHTML="",Ye.length>0?Ye.forEach((e=>{const t=document.createElement("li");t.classList.add("flex","justify-between","items-center","py-1"),t.innerHTML=`\n                        <span>${e}</span>\n                        <button type="button" class="text-red-500 hover:text-red-700 ml-4" data-date="${e}" aria-label="Remove public holiday ${e}">\n                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" /></svg>\n                        </button>\n                    `,L.appendChild(t),t.querySelector("button").addEventListener("click",(e=>{const t=e.currentTarget.dataset.date;ze("Confirm Removal",`Are you sure you want to remove ${t} from public holidays?`,"confirm",(()=>{Ye=Ye.filter((e=>e!==t)),It(),dt(),mt(),Xe("Holiday Removed","success")}))}))})):L.innerHTML='<li class="text-gray-500">No public holidays added yet.</li>'}function Ot(e){return Ye.includes(e)}function Dt(){T.innerHTML="",DISPLAYABLE_OT_TYPES.forEach((e=>{const t=document.createElement("div");t.classList.add("input-group");const a=`multiplier-${e.replace(/[^0-9A-Za-z]/g,"")}`;t.innerHTML=`\n                        <label for="${a}">${e} Multiplier</label>\n                        <input type="number" id="${a}" value="${(CONFIG.OT_MULTIPLIERS[e]||0).toFixed(2)}" min="0" step="0.1" class="shadow-sm">\n                    `,T.appendChild(t),t.querySelector("input").addEventListener("input",je((t=>{const a=parseFloat(t.target.value);!isNaN(a)&&a>=0&&(CONFIG.OT_MULTIPLIERS[e]=a,mt())}),150))}))}function St(){ze("Confirm Reset Multipliers","Are you sure you want to reset all OT multipliers to their default values?","confirm",(()=>{Object.assign(CONFIG.OT_MULTIPLIERS,DEFAULT_OT_MULTIPLIERS),Dt(),Xe("OT multipliers have been reset to their default values.","success"),mt()}))}async function wt(e){Je(),B.classList.remove("hidden"),B.setAttribute("aria-live","polite"),await qe();try{const t=parseFloat(n.value),a=Ze(),{minHours:o,maxHours:s}=Qe(),i=Be.selectedDates,r=i[0]?i[0].toISOString().split("T")[0]:"",l=i[1]?i[1].toISOString().split("T")[0]:"";if(isNaN(t)||t<=0||!r||!l||new Date(r)>new Date(l)||!et())return void Xe("Please ensure all settings (Salary, Date Range, Hour Limits) are valid.","error");let d=0,c=0;const u={};if(e)rt();else{const e=new Date(r),a=new Date(l);ke=ke.filter((t=>{const n=new Date(t.date);return n>=e&&n<=a})),ke.forEach((e=>{const a=parseFloat(e.hours);!isNaN(a)&&a>0&&(d+=at(tt(t),a,e.type,e.date),c+=a,u[e.date]=(u[e.date]||0)+a)}))}if(null!==s&&c>=s-CONFIG.ALLOCATION_PRECISION)return Xe(`Max Total OT Hours (${s.toFixed(1)}h) already met.`,"warning"),void mt();const m=tt(t),y=((e,t)=>{const a=[];let n=new Date(e);const o=new Date(t);for(;n<=o;)a.push({date:n.toISOString().split("T")[0],dayOfWeek:n.getDay()}),n.setDate(n.getDate()+1);return a})(r,l),g={workingDay:Fe.checked,offDay:_e.checked,restDay:He.checked,publicHoliday:Ae.checked},f=()=>y.filter((e=>{if((u[e.date]||0)>=CONFIG.MAX_DAILY_OT_HOURS)return!1;const t=Ot(e.date);if(t&&g.publicHoliday)return!0;if(!t){if(e.dayOfWeek>=1&&e.dayOfWeek<=5&&g.workingDay)return!0;if(6===e.dayOfWeek&&g.offDay)return!0;if(0===e.dayOfWeek&&g.restDay)return!0}return!1}));if("Target-Driven"===We){if(null===a||a<=0)return void Xe("Please enter a valid Target OT Pay (> RM0) for Target-Driven allocation.","error");let e=a-d;e<=CONFIG.ALLOCATION_PRECISION&&Xe("Target OT pay has already been met with existing entries.","info");const t=D.value;let n=f();"Balanced"===t?n=n.sort((()=>Math.random()-.5)):n.sort(((e,a)=>{const n=CONFIG.OT_MULTIPLIERS[lt(e.date)],o=CONFIG.OT_MULTIPLIERS[lt(a.date)];return"Fastest Path"===t?o-n:n-o}));let o=0;const i=20*n.length;for(;e>CONFIG.ALLOCATION_PRECISION&&o<i&&n.length>0;){o++;let i="Balanced"===t?Math.floor(Math.random()*n.length):0;const r=n[i],l=u[r.date]||0;let y=CONFIG.MAX_DAILY_OT_HOURS-l;if(null!==s&&(y=Math.min(y,s-c)),y<=0){n.splice(i,1);continue}let g=gt();g=Math.min(g,y);let f=lt(r.date),h=at(m,l+g,f,r.date)-at(m,l,f,r.date);for(;g>.5&&h>e;)g-=.5,h=at(m,l+g,f,r.date)-at(m,l,f,r.date);h<=e&&g>0&&(ft(r.date,g,f),d+=h,c+=g,u[r.date]=(u[r.date]||0)+g,e=a-d),"Balanced"!==t&&n.shift(),await qe()}if(d<a-CONFIG.ALLOCATION_PRECISION){Xe(`Target was not fully met (${nt(d)}). Topping up...`,"warning"),await qe();let e=f().filter((e=>(u[e.date]||0)<CONFIG.MAX_DAILY_OT_HOURS));e.sort(((e,t)=>CONFIG.OT_MULTIPLIERS[lt(e.date)]-CONFIG.OT_MULTIPLIERS[lt(t.date)]));let t=0;const n=10*e.length;for(;d<a&&t<n&&e.length>0;){t++;const a=e[0],n=u[a.date]||0;if(CONFIG.MAX_DAILY_OT_HOURS-n<=0){e.shift();continue}const o=.5,s=at(m,n+o,lt(a.date),a.date)-at(m,n,lt(a.date),a.date);ft(a.date,o,lt(a.date)),d+=s,c+=o,u[a.date]=(u[a.date]||0)+o,e.push(e.shift()),await qe()}}else Xe("Overtime hours allocated to meet your target.","success")}else if("Workload-Driven"===We){const e=CONFIG.WORKLOAD_PRESETS[Ge];let t=f().sort((()=>Math.random()-.5));for(const a of t){if(null!==s&&c>=s-CONFIG.ALLOCATION_PRECISION){Xe(`Max Total OT Hours (${s.toFixed(1)}h) reached.`,"info");break}const t=u[a.date]||0,n=CONFIG.MAX_DAILY_OT_HOURS-t,o=lt(a.date),i=e[o];if(!i||n<=0)continue;let r=gt();r=Math.min(r,n,i.maxHours),null!==s&&(r=Math.min(r,s-c)),r>CONFIG.ALLOCATION_PRECISION&&(ft(a.date,r,o),c+=r,u[a.date]=(u[a.date]||0)+r),await qe()}Xe("Overtime hours allocated based on workload preset.","success")}if(null!==o&&c<o){Xe(`Topping up hours to meet minimum of ${o}h...`,"info"),await qe();let e=f().filter((e=>(u[e.date]||0)<CONFIG.MAX_DAILY_OT_HOURS));e.sort(((e,t)=>CONFIG.OT_MULTIPLIERS[lt(e.date)]-CONFIG.OT_MULTIPLIERS[lt(t.date)]));let t=0;const a=10*e.length;for(;c<o&&t<a&&e.length>0;){t++;const a=e[0],n=u[a.date]||0;if(CONFIG.MAX_DAILY_OT_HOURS-n<=0){e.shift();continue}const o=.5;ft(a.date,o,lt(a.date)),c+=o,u[a.date]=(u[a.date]||0)+o,e.push(e.shift()),await qe()}c<o&&Xe(`Could not meet minimum hour target. Reached ${c.toFixed(1)}h.`,"warning")}ht(),ke.forEach((e=>delete e.isNew)),await dt(),mt()}catch(e){console.error("Error during auto-allocation:",e),Xe("An error occurred during auto-allocation. Please check console.","error")}finally{Ke(),B.classList.add("hidden"),B.removeAttribute("aria-live")}}function xt(){try{const e=parseFloat(n.value),t=Ze(),{minHours:a,maxHours:o}=Qe(),s=Be.selectedDates,i=s[0]?s[0].toISOString().split("T")[0]:"",r=s[1]?s[1].toISOString().split("T")[0]:"",l=tt(e);let d="--- OT Calculation Summary ---\n\n";d+="Employee Settings:\n",d+=`  Basic Monthly Salary: ${nt(e)}\n`,d+=`  Hourly Rate: RM ${l.toFixed(2)}/hour\n\n`,d+=`OT Planning Period: ${i} to ${r}\n`,d+=`Allocation Strategy: ${We}\n`,d+=`Target OT Pay: ${null===t?"N/A":nt(t)}\n`,d+=`Total OT Hours Range: ${null!==a&&null!==o?`${a.toFixed(1)}h - ${o.toFixed(1)}h`:null!==a?`Min: ${a.toFixed(1)}h`:null!==o?`Max: ${o.toFixed(1)}h`:"N/A"}\n\n`,d+="OT Multipliers Used:\n";for(const e in CONFIG.OT_MULTIPLIERS)d+=`  ${e}: ${CONFIG.OT_MULTIPLIERS[e].toFixed(2)}x\n`;d+="\n";const c={},u=ke.filter((e=>{const t=new Date(e.date),a=i?new Date(i):null,n=r?new Date(r):null;return!(a&&n&&(t.setHours(0,0,0,0),a.setHours(0,0,0,0),n.setHours(0,0,0,0),t<a||t>n))}));u.forEach((e=>{const t=lt(e.date);(c[t]=c[t]||[]).push(e)})),d+="Daily OT Entries:\n",0===u.length?d+="  No entries recorded for the selected range.\n":DISPLAYABLE_OT_TYPES.forEach((e=>{c[e]&&c[e].length>0&&(d+=`\n--- ${e} ---\n`,c[e].sort(((e,t)=>new Date(e.date)-new Date(t.date))),c[e].forEach((e=>{d+=`  Date: ${e.date}, Hours: ${e.hours.toFixed(1)}h, Type: ${e.type}`,Ot(e.date)&&(d+=" (Public Holiday)"),e.startTime&&e.endTime&&(d+=`, Time: ${e.startTime} - ${e.endTime}`),d+="\n"})))})),d+="\n";let m={},y={},g=0,f=0;DISPLAYABLE_OT_TYPES.forEach((e=>{m[e]=0,y[e]=0})),u.forEach((e=>{const t=parseFloat(e.hours);if(isNaN(t)||t<=0)return;const a=lt(e.date),n=at(l,t,e.type,e.date);m[a]+=t,y[a]+=n,g+=n,f+=t}));const h=e+g;d+="Total OT Hours by Type:\n";let p=[];DISPLAYABLE_OT_TYPES.forEach((e=>{m[e]>0&&p.push(`${e}: ${m[e].toFixed(1)}h`)})),d+=`  ${p.join(", ")}\n\n`,d+="Total Pay per OT Category:\n";let L=[];DISPLAYABLE_OT_TYPES.forEach((e=>{y[e]>0&&(y[e]=parseFloat(y[e].toFixed(2)),L.push(`${e}: ${nt(y[e])}`))})),d+=`  ${L.join(", ")}\n\n`,d+=`Combined OT Pay: ${nt(g)}\n`;const T=g-(null===t?0:t);d+=`Difference from Target: ${null===t?"N/A (No target set)":nt(T)}\n`,d+=`Total Monthly OT Hours: ${f.toFixed(1)} hours\n`,d+=`Expected Salary Pay (Calculated): ${nt(h)}\n\n`,d+="--- End of Summary ---";const v=new Blob([d],{type:"text/plain;charset=utf-8"}),E=URL.createObjectURL(v),I=document.createElement("a");I.href=E,I.download="ot_summary.txt",document.body.appendChild(I),I.click(),Xe("Your OT summary is being downloaded.","info"),setTimeout((()=>{document.body.removeChild(I),URL.revokeObjectURL(E)}),250)}catch(e){console.error("Error during export summary:",e),Xe("Failed to export summary. Please check your browser console for details.","error")}}async function Ct(){if(Re)if($e&&a){Je(),Ve(Oe,"Saving...","loading");try{const t="undefined"!=typeof __app_id?__app_id:"default-app-id",o=doc(e,`artifacts/${t}/users/${a}/ot_calculator_data`,"user_data"),s=ke.map((e=>{const t={...e};return delete t.isNew,t})),{minHours:i,maxHours:r}=Qe(),l={basicSalary:parseFloat(n.value),targetOTPay:Ze(),minTotalOTHours:i,maxTotalOTHours:r,startDate:Be.selectedDates[0]?Be.selectedDates[0].toISOString().split("T")[0]:"",endDate:Be.selectedDates[1]?Be.selectedDates[1].toISOString().split("T")[0]:"",workloadPreset:w.value,allocationStrategy:E.value,targetAllocationStrategy:D.value,otEntries:JSON.stringify(s),publicHolidays:JSON.stringify(Ye),customMultipliers:JSON.stringify(CONFIG.OT_MULTIPLIERS),allocateWorkingDay:Fe.checked,allocateOffDay:_e.checked,allocateRestDay:He.checked,allocatePublicHoliday:Ae.checked};await setDoc(o,l),ke=s,dt(),Ve(Oe,"Saved!","success"),Xe("Data saved successfully!","success")}catch(e){console.error("Error saving document: ",e),Ve(Oe,"Save Failed!","error"),Xe("Failed to save data. Please try again.","error")}finally{Ke()}}else Xe("Firebase authentication not ready. Please try again in a moment.","error");else Xe("Firebase functions (Save/Load) are currently disabled. Please enable them to use this feature.","warning")}async function bt(t=!1){if(Re)if($e&&a){t||(Je(),Ve(De,"Loading...","loading"));try{const o="undefined"!=typeof __app_id?__app_id:"default-app-id",d=doc(e,`artifacts/${o}/users/${a}/ot_calculator_data`,"user_data"),u=await getDoc(d);if(u.exists()){const e=u.data();n.value=parseFloat(e.basicSalary);const a=e.targetOTPay;if(null===a?(s.value="",i.classList.add("hidden"),r.classList.add("hidden"),i.value=""):PREDEFINED_TARGET_PAYS.includes(a)?(s.value=a.toFixed(2),i.classList.add("hidden"),r.classList.add("hidden"),i.value=""):(s.value="custom",i.classList.remove("hidden"),r.classList.remove("hidden"),i.value=a.toFixed(2)),l.value=null!==e.minTotalOTHours?e.minTotalOTHours:"",c.value=null!==e.maxTotalOTHours?e.maxTotalOTHours:"",e.startDate&&e.endDate?Be.setDate([e.startDate,e.endDate],!0):Be.clear(),w.value=e.workloadPreset||"Moderate Workload",E.value=e.allocationStrategy||"Target-Driven",D.value=e.targetAllocationStrategy||"Balanced",ke=JSON.parse(e.otEntries||"[]"),Ye=JSON.parse(e.publicHolidays||"[]"),Object.assign(CONFIG.OT_MULTIPLIERS,JSON.parse(e.customMultipliers||"{}")),Object.assign(CONFIG.OT_MULTIPLIERS,{...DEFAULT_OT_MULTIPLIERS,...CONFIG.OT_MULTIPLIERS}),Fe.checked=void 0===e.allocateWorkingDay||e.allocateWorkingDay,_e.checked=void 0===e.allocateOffDay||e.allocateOffDay,He.checked=void 0===e.allocateRestDay||e.allocateRestDay,Ae.checked=void 0===e.allocatePublicHoliday||e.allocatePublicHoliday,Ue=ke.length>0?Math.max(...ke.map((e=>parseInt(e.id.split("-")[2]))))+1:0,ht(),await dt(),It(),Ye.length>0){const e=document.querySelector('.collapsible-header[data-target="publicHolidaysContent"]'),t=e?e.querySelector(".collapsible-icon"):null;kt(ve,t,!0)}Dt(),mt(),t||(Ve(De,"Loaded!","success"),Xe("Data loaded successfully!","success"))}else{const e=new Date,a=new Date(e.getFullYear(),e.getMonth(),1),o=new Date(e.getFullYear(),e.getMonth()+1,0);Be.setDate([a,o],!0),n.value="3700.00",w.value="Moderate Workload",E.value="Target-Driven",s.value="",i.classList.add("hidden"),r.classList.add("hidden"),l.value="",c.value="",Fe.checked=!0,_e.checked=!0,He.checked=!0,Ae.checked=!0,It(),Dt(),await dt(),mt(),t||Ve(De,"No saved data found.","info")}}catch(e){console.error("Error loading document: ",e),t||(Ve(De,"Load Failed!","error"),Xe("Failed to load data. Please try again.","error"))}finally{pt(),Lt(),t||Ke()}}else t||Xe("Firebase authentication not ready. Please try again in a moment.","error");else t||Xe("Firebase functions (Save/Load) are currently disabled. Please enable them to use this feature.","warning")}function Ft(e){return e?`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`:""}function _t(){const e=Be.selectedDates,t=Ft(e[0]),a=Ft(e[1]);if(!t||!a||new Date(t)>new Date(a))return void Xe('Please set a valid "OT Planning Date Range" before adding a manual entry.',"error");ie.textContent="",le.textContent="",ce.textContent="",se.classList.remove("input-error"),re.classList.remove("input-error"),de.classList.remove("input-error");const n=[];let o=new Date(t);const s=new Date(a);for(;o.getTime()<=s.getTime();)n.push(Ft(o)),o.setDate(o.getDate()+1);const i=n.filter((e=>!ke.some((t=>t.date===e))));let r=null;r=i.length>0?i[0]:t||ot(),Ne?(Ne.set("minDate",t),Ne.set("maxDate",a),Ne.set("disable",ke.map((e=>e.date))),Ne.setDate(r),Ne.redraw()):Ne=window.flatpickr(se,{dateFormat:"Y-m-d",minDate:t,maxDate:a,disable:ke.map((e=>e.date)),defaultDate:r,onChange:function(e,t,a){ie.textContent="",se.classList.remove("input-error");const n=e[0];if(n){const e=Be.selectedDates,t=e[0]?new Date(e[0].toISOString().split("T")[0]):null,o=e[1]?new Date(e[1].toISOString().split("T")[0]):null;t&&o&&(n<t||n>o)&&(ie.textContent="Date must be within range.",se.classList.add("input-error"),a.clear(),se.value="",Xe("Selected date is outside the planning range and has been cleared.","error"))}}}),se.value=r||"",Pe?Pe.setDate("18:00",!1):Pe=window.flatpickr(de,{enableTime:!0,noCalendar:!0,dateFormat:"H:i",time_24hr:!0,defaultHour:18,defaultMinute:0,minuteIncrement:15,onChange:function(e,t,a){ce.textContent="",de.classList.remove("input-error"),At()}}),re.value="2.0",At(),ne.classList.remove("hidden"),ne.classList.add("show"),window.lastFocusedElement=document.activeElement,se.focus()}function Ht(){ne.classList.add("hidden"),ne.classList.remove("show"),window.lastFocusedElement&&window.lastFocusedElement.focus()}function At(){const e=de.value,t=parseFloat(re.value);e&&!isNaN(t)&&t>0?ue.value=st(e,t):ue.value=""}function Bt(){const e=se.value,t=parseFloat(re.value),a=de.value,n=ue.value;ie.textContent="",le.textContent="",ce.textContent="",se.classList.remove("input-error"),re.classList.remove("input-error"),de.classList.remove("input-error");let o=!0;e||(ie.textContent="Please select a date.",se.classList.add("input-error"),o=!1),isNaN(t)||t<=0?(le.textContent="Hours must be a positive number.",re.classList.add("input-error"),o=!1):t>CONFIG.MAX_DAILY_OT_HOURS&&(le.textContent=`Max hours per day is ${CONFIG.MAX_DAILY_OT_HOURS}.`,re.classList.add("input-error"),o=!1),a||(ce.textContent="Please set a start time.",de.classList.add("input-error"),o=!1);const s=Be.selectedDates,i=Ft(s[0]),r=Ft(s[1]),l=new Date(e).setHours(0,0,0,0),d=new Date(i).setHours(0,0,0,0),c=new Date(r).setHours(0,0,0,0);if((l<d||l>c)&&(ie.textContent=`Date must be within ${i} and ${r}.`,se.classList.add("input-error"),o=!1),ke.some((t=>t.date===e))&&(ie.textContent=`An OT entry already exists for ${e}.`,se.classList.add("input-error"),o=!1),o){const o={id:"ot-entry-"+Ue++,date:e,hours:t,type:lt(e),startTime:a,endTime:n,isNew:!0};ke.push(o),dt(),mt(),setTimeout((()=>{const e=F.querySelector(`[data-id="${o.id}"]`);e&&e.scrollIntoView({behavior:"smooth",block:"center"})}),100),Ht(),Xe(`New OT entry added for ${e} (${t}h, ${a}-${n}).`,"success")}}function Nt(){ge.classList.remove("hidden"),ge.classList.add("show"),window.lastFocusedElement=document.activeElement,fe.focus()}function Pt(){ge.classList.add("hidden"),ge.classList.remove("show"),window.lastFocusedElement&&window.lastFocusedElement.focus()}async function Mt(){if(!Re)return we.textContent="Firebase (Save/Load) is currently disabled.",void J.classList.add("hidden");we.textContent="Initializing Firebase...";try{const n="undefined"!=typeof __firebase_config?__firebase_config:"{}",o=JSON.parse(n);if(0===Object.keys(o).length)throw new Error("Firebase configuration is empty or invalid.");const s=initializeApp(o);e=getFirestore(s),t=getAuth(s),onAuthStateChanged(t,(async e=>{if(e)a=e.uid,$e=!0,J.textContent=`User ID: ${a}`,J.classList.remove("hidden"),we.textContent="Firebase enabled and connected.",await bt(!0);else try{const e=await signInAnonymously(t);a=e.user.uid,$e=!0,J.textContent=`User ID: ${a}`,J.classList.remove("hidden"),we.textContent="Firebase enabled and connected (anonymous).",await bt(!0)}catch(e){console.error("Anonymous sign-in failed:",e),we.textContent="Firebase connection failed. Check console.",Xe("Failed to sign in. Data saving/loading may not work.","error")}$t()}))}catch(e){console.error("Firebase initialization failed:",e),we.textContent=`Firebase init failed: ${e.message}.`,Xe(`Firebase could not be initialized: ${e.message||"Unknown error"}.`,"error"),Re=!1,Se.checked=!1,localStorage.setItem("isFirebaseEnabled","false"),$t(),J.classList.add("hidden")}}function $t(){const e=!Re||!$e;M.disabled=e,$.disabled=e}async function Rt(){Re=Se.checked,localStorage.setItem("isFirebaseEnabled",Re),Re?await Mt():(e=null,t=null,a=null,$e=!1,J.classList.add("hidden"),we.textContent="Firebase (Save/Load) is now disabled."),$t()}function kt(e,t,a=!1){a||e.classList.contains("collapsed")?(e.style.maxHeight=e.scrollHeight+"px",e.classList.remove("collapsed"),t&&t.classList.add("rotated"),e.addEventListener("transitionend",(function t(){e.style.maxHeight="none",e.removeEventListener("transitionend",t)}),{once:!0})):(e.style.maxHeight=e.scrollHeight+"px",e.offsetWidth,e.classList.add("collapsed"),t&&t.classList.remove("rotated"),e.addEventListener("transitionend",(function t(){e.classList.contains("collapsed")&&(e.style.maxHeight="0"),e.removeEventListener("transitionend",t)}),{once:!0}))}function Yt(){n.addEventListener("input",je(mt,150)),i.addEventListener("input",je((()=>{Lt()}),150)),l.addEventListener("input",je((()=>{et(),mt()}),150)),c.addEventListener("input",je((()=>{et(),mt()}),150)),Be=window.flatpickr(y,{mode:"range",dateFormat:"Y-m-d",onChange:function(e,t,a){mt(),function(){if(Ne){const e=Be.selectedDates,t=Ft(e[0]),a=Ft(e[1]);let n=null;const o=[];if(t&&a){let e=new Date(t);const n=new Date(a);for(;e.getTime()<=n.getTime();)o.push(Ft(e)),e.setDate(e.getDate()+1)}const s=o.filter((e=>!ke.some((t=>t.date===e))));n=s.length>0?s[0]:t||ot(),Ne.set("minDate",t),Ne.set("maxDate",a),Ne.set("disable",ke.map((e=>e.date))),Ne.setDate(n),Ne.redraw(),se.value=n||""}}(),vt(),g.textContent="",y.classList.remove("input-error")}}),f.addEventListener("click",(()=>{const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),1),a=new Date(e.getFullYear(),e.getMonth()+1,0);Be.setDate([t,a],!0),Xe("Date range set to current month.","info")})),A.addEventListener("click",Nt),fe.addEventListener("click",(()=>{Pt(),wt(!0)})),he.addEventListener("click",(()=>{Pt(),wt(!1)})),pe.addEventListener("click",Pt),N.addEventListener("click",(()=>{ze("Confirm Reset & Re-allocate","Are you sure you want to clear ALL existing OT entries and re-allocate from scratch? This action cannot be undone.","confirm",(()=>wt(!0)))})),P.addEventListener("click",ut),X.addEventListener("click",xt),M.addEventListener("click",Ct),$.addEventListener("click",(()=>bt(!1))),w.addEventListener("change",pt),D.addEventListener("change",Tt),p.addEventListener("click",Et),v.addEventListener("click",St),s.addEventListener("change",(()=>{"custom"===s.value?(i.classList.remove("hidden"),r.classList.remove("hidden"),i.focus()):(i.classList.add("hidden"),r.classList.add("hidden"),i.value=""),Lt()})),o.addEventListener("click",(()=>{n.value="",mt(),Xe("Basic Salary cleared.","info")})),r.addEventListener("click",(()=>{i.value="",Lt(),Xe("Custom Target OT Pay cleared.","info")})),d.addEventListener("click",(()=>{l.value="",et(),mt(),Xe("Min Total OT Hours cleared.","info")})),u.addEventListener("click",(()=>{c.value="",et(),mt(),Xe("Max Total OT Hours cleared.","info")})),window.flatpickr(h,{dateFormat:"Y-m-d"}),Le.addEventListener("click",(()=>{h.value=ot(),h._flatpickr&&h._flatpickr.setDate(h.value,!0),Xe("Public Holiday date set to today.","info")})),Te.forEach((e=>{e.addEventListener("click",(()=>{const t=e.dataset.target;kt(document.getElementById(t),e.querySelector(".collapsible-icon"))}))})),H.addEventListener("click",_t),me.addEventListener("click",Bt),ye.addEventListener("click",Ht),re.addEventListener("input",At),de.addEventListener("input",At),Se.addEventListener("change",Rt),[Fe,_e,He,Ae].forEach((e=>{e.addEventListener("change",mt)}))}document.addEventListener("DOMContentLoaded",(async()=>{n=document.getElementById("basicSalary"),o=n.nextElementSibling,s=document.getElementById("targetOTPaySelect"),i=document.getElementById("customTargetOTPayInput"),r=document.getElementById("clearCustomTargetOTPayBtn"),l=document.getElementById("minTotalOTHours"),d=document.getElementById("clearMinTotalOTHoursBtn"),c=document.getElementById("maxTotalOTHours"),u=document.getElementById("clearMaxTotalOTHoursBtn"),m=document.getElementById("minMaxHoursError"),y=document.getElementById("dateRangeInput"),g=document.getElementById("dateRangeError"),f=document.getElementById("setThisMonthBtn"),h=document.getElementById("publicHolidayDate"),p=document.getElementById("addPublicHolidayDateBtn"),L=document.getElementById("publicHolidaysList"),T=document.getElementById("otMultiplierInputs"),v=document.getElementById("resetMultipliersBtn"),E=document.getElementById("allocationStrategy"),I=document.getElementById("allocationStrategyDescription"),O=document.getElementById("targetDrivenStrategyGroup"),D=document.getElementById("targetAllocationStrategy"),S=document.getElementById("targetAllocationStrategyDescription"),w=document.getElementById("workloadPreset"),x=document.getElementById("workloadPresetGroup"),C=document.getElementById("workloadPresetDescription"),b=document.getElementById("workloadPresetDetails"),F=document.getElementById("otEntriesContainer"),_=document.getElementById("noEntriesMessage"),H=document.getElementById("addOTEntryBtn"),A=document.getElementById("autoAllocateBtn"),B=document.getElementById("autoAllocateLoading"),N=document.getElementById("resetAndReallocateBtn"),P=document.getElementById("clearAllEntriesBtn"),M=document.getElementById("saveDataBtn"),$=document.getElementById("loadDataBtn"),R=document.getElementById("results"),k=document.getElementById("totalHoursByType"),Y=document.getElementById("totalPayByCategory"),U=document.getElementById("combinedOTPay"),G=document.getElementById("targetOTPayDisplay"),W=document.getElementById("differenceFromTarget"),j=document.getElementById("totalMonthlyOTHoursDisplay"),q=document.getElementById("totalOTHoursRangeDisplay"),z=document.getElementById("expectedSalaryPayDisplay"),X=document.getElementById("exportSummaryBtn"),J=document.getElementById("userIdDisplay"),K=document.getElementById("allocationStrategySummary"),V=document.getElementById("messageBox"),Z=document.getElementById("messageBoxTitle"),Q=document.getElementById("messageBoxContent"),ee=document.getElementById("messageBoxCloseBtn"),te=document.getElementById("messageBoxConfirmBtn"),ae=document.getElementById("messageBoxCancelBtn"),ne=document.getElementById("addDetailedOTEntryModal"),oe=document.getElementById("detailedEntryModalTitle"),se=document.getElementById("detailedEntryDate"),ie=document.getElementById("detailedEntryDateError"),re=document.getElementById("detailedEntryHours"),le=document.getElementById("detailedEntryHoursError"),de=document.getElementById("detailedEntryStartTime"),ce=document.getElementById("detailedEntryStartTimeError"),ue=document.getElementById("detailedEntryEndTime"),me=document.getElementById("confirmDetailedEntryBtn"),ye=document.getElementById("cancelDetailedEntryBtn"),ge=document.getElementById("allocationChoiceModal"),fe=document.getElementById("clearAndAllocateBtn"),he=document.getElementById("fillRemainingBtn"),pe=document.getElementById("cancelAllocationChoiceBtn"),Le=document.getElementById("setPublicHolidayTodayBtn"),Te=document.querySelectorAll(".collapsible-header"),ve=document.getElementById("publicHolidaysContent"),Ee=document.getElementById("otMultiplierContent"),Ie=document.getElementById("howToUseContent"),Oe=document.getElementById("saveDataStatus"),De=document.getElementById("loadDataStatus"),Se=document.getElementById("firebaseToggle"),we=document.getElementById("firebaseStatusMessage"),xe=document.getElementById("loadingOverlay"),Ce=document.getElementById("toastContainer"),be=document.getElementById("chartPlaceholder"),Fe=document.getElementById("allocateWorkingDay"),_e=document.getElementById("allocateOffDay"),He=document.getElementById("allocateRestDay"),Ae=document.getElementById("allocatePublicHoliday"),Se.checked=Re,await Mt(),$t(),Yt(),function(){const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),1),a=new Date(e.getFullYear(),e.getMonth()+1,0);Be.setDate([t,a],!0),s.innerHTML='<option value="">No Target</option>',PREDEFINED_TARGET_PAYS.forEach((e=>{const t=document.createElement("option");t.value=e.toFixed(2),t.textContent=`RM ${e.toFixed(2)}`,s.appendChild(t)}));const n=document.createElement("option");n.value="custom",n.textContent="Other (Enter Manually)",s.appendChild(n),Dt(),Ie.classList.add("collapsed"),ve.classList.add("collapsed"),Ee.classList.add("collapsed"),Lt(),pt(),vt()}()}))})()</script>
</body>
</html>
