<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart OT Calculator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 30px; text-align: center; color: white; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); }
        .header p { font-size: 1.2rem; opacity: 0.9; }
        .content { padding: 40px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-bottom: 40px; }
        .form-group { background: #f8f9fa; padding: 25px; border-radius: 15px; border-left: 5px solid #4facfe; }
        .form-group h3 { color: #333; margin-bottom: 20px; font-size: 1.3rem; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; color: #555; font-weight: 600; }
        .input-group input { width: 100%; padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px; }
        .btn { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; padding: 15px 30px; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; width: 100%; margin-top: 20px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3); }
        .settings-controls { display: flex; gap: 10px; justify-content: flex-end; margin-bottom: 15px; }
        .btn-secondary { background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 0.9rem; cursor: pointer; }
        .holiday-list { margin-top: 10px; max-height: 120px; overflow-y: auto; }
        .holiday-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #fff; border-radius: 5px; margin-bottom: 5px; border: 1px solid #e9ecef; }
        .remove-holiday-btn { background: #ff4d4d; color: white; border: none; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; font-weight: bold; }
        .add-holiday-btn { padding: 0 15px; background: #28a745; color: white; border: none; border-radius: 10px; cursor: pointer; }
        .holiday-checklist { max-height: 150px; overflow-y: auto; background: #fff; padding: 10px; border-radius: 10px; border: 1px solid #e9ecef; }
        .holiday-checkbox-item { display: flex; align-items: center; justify-content: space-between; padding: 8px; border-radius: 5px; }
        .holiday-checkbox-item label { font-size: 0.9rem; color: #333; cursor: pointer; flex-grow: 1; display: flex; justify-content: space-between; align-items: center; }
        .hourly-rate-display { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 15px; border-radius: 10px; text-align: center; margin-top: 15px; font-weight: bold; }
        .results { margin-top: 40px; display: none; }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .summary-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; text-align: center; }
        .summary-card h4 { font-size: 0.9rem; opacity: 0.9; margin-bottom: 10px; }
        .summary-card .value { font-size: 1.8rem; font-weight: bold; }
        .ot-table { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05); }
        .ot-table table { width: 100%; border-collapse: collapse; }
        .ot-table th { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 15px; text-align: left; }
        .ot-table td { padding: 12px 15px; border-bottom: 1px solid #f1f3f4; }
        .overtime-type { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .ot-weekend { background: #e3f2fd; color: #1976d2; }
        .ot-weekday { background: #e8f5e8; color: #2e7d32; }
        .ot-holiday { background: #fff3e0; color: #f57c00; }
        .ot-restday { background: #f3e5f5; color: #7b1fa2; }
        .breakdown-section { margin-top: 40px; margin-bottom: 20px; }
        .breakdown-section h4 { margin-bottom: 15px; font-size: 1.3rem; color: #333; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
             <h1>üïí Smart OT Calculator</h1>
             <p>Automatically allocate overtime hours to reach your target pay</p>
        </div>
        <div class="content">
            <div class="form-grid">
                 <div class="form-group">
                    <h3>üí∞ Salary Information</h3>
                    <div class="input-group">
                        <label for="basicSalary">Basic Salary (RM)</label>
                        <input type="number" id="basicSalary" placeholder="3700" step="0.01">
                    </div>
                    <div id="hourlyRateDisplay" class="hourly-rate-display" style="display: none;"></div>
                </div>
                <div class="form-group">
                    <h3>üéØ Target & Dates</h3>
                    <div class="input-group">
                        <label for="targetPay">Target OT Pay (RM)</label>
                        <input type="number" id="targetPay" placeholder="4000" step="0.01">
                    </div>
                    <div class="input-group">
                        <label for="startDate">Start Date</label>
                        <input type="date" id="startDate">
                    </div>
                    <div class="input-group">
                        <label for="endDate">End Date</label>
                        <input type="date" id="endDate">
                    </div>
                </div>
                <div class="form-group">
                    <h3>üèñÔ∏è Public Holidays (2025)</h3>
                    <div id="holidayChecklist" class="holiday-checklist"></div>
                    <hr style="margin: 20px 0;">
                    <div class="input-group">
                        <label for="holidayPicker">Add Custom Holiday</label>
                        <div style="display: flex; gap: 10px; align-items: end;">
                            <input type="date" id="holidayPicker" style="flex: 1;">
                            <button type="button" class="add-holiday-btn" onclick="addHoliday()">+ Add</button>
                        </div>
                    </div>
                    <div id="holidayList" class="holiday-list"></div>
                </div>
            </div>
            <div class="settings-controls">
                <button type="button" class="btn-secondary" onclick="saveSettings()">üíæ Save Settings</button>
                <button type="button" class="btn-secondary" onclick="loadSettings()">üîÑ Load Settings</button>
            </div>
            <button class="btn" onclick="calculateOT()"> ‚ú® Calculate Smart OT Allocation </button>
            <div id="results" class="results"></div>
        </div>
    </div>
    
    <script>
        let publicHolidays = [];
        let calculatedDailyHours = [];
        const predefinedHolidays2025 = [
            { date: '2025-01-01', name: 'New Year\'s Day' }, { date: '2025-01-21', name: 'Thaipusam' },
            { date: '2025-01-29', name: 'Chinese New Year' }, { date: '2025-01-30', name: 'Chinese New Year Day 2' },
            { date: '2025-03-29', name: 'Nuzul Al-Quran' }, { date: '2025-03-31', name: 'Hari Raya Aidilfitri' },
            { date: '2025-04-01', name: 'Hari Raya Aidilfitri Day 2' }, { date: '2025-05-01', name: 'Labour Day' },
            { date: '2025-05-12', name: 'Wesak Day' }, { date: '2025-06-02', name: 'Agong\'s Birthday' },
            { date: '2025-06-07', name: 'Hari Raya Haji' }, { date: '2025-06-27', name: 'Awal Muharram' },
            { date: '2025-09-01', name: 'Merdeka Day (Holiday)' }, { date: '2025-09-05', name: 'Prophet Muhammad\'s Birthday' },
            { date: '2025-09-16', name: 'Malaysia Day' }, { date: '2025-10-20', name: 'Deepavali' },
            { date: '2025-12-11', name: 'Sultan of Selangor\'s Birthday' }, { date: '2025-12-25', name: 'Christmas Day' },
        ];
        
        // NEW: Helper function to format dates correctly without timezone issues
        function formatDateToYyyyMmDd(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // MODIFIED: This function is updated to use the new date formatter
        document.addEventListener('DOMContentLoaded', function() {
            const salaryInput = document.getElementById('basicSalary');
            salaryInput.value = '3700.00';
            salaryInput.dispatchEvent(new Event('input'));
            
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();

            const startOfCurrentMonth = new Date(currentYear, currentMonth, 1);
            document.getElementById('startDate').value = formatDateToYyyyMmDd(startOfCurrentMonth);
            
            const endOfNextMonth = new Date(currentYear, currentMonth + 2, 0);
            document.getElementById('endDate').value = formatDateToYyyyMmDd(endOfNextMonth);
            
            document.getElementById('startDate').setAttribute('data-default-month', `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`);
            document.getElementById('endDate').setAttribute('data-default-month', `${currentYear}-${String(currentMonth + 2).padStart(2, '0')}`);
            document.getElementById('holidayPicker').setAttribute('data-default-month', `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`);

            populateHolidayChecklist();
            loadSettings();
        });

        // --- All other functions are unchanged ---
        function populateHolidayChecklist() {
            const checklistContainer = document.getElementById('holidayChecklist');
            checklistContainer.innerHTML = predefinedHolidays2025.map(holiday => {
                const holidayDate = new Date(holiday.date + 'T00:00:00');
                const dateString = holidayDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
                return `<div class="holiday-checkbox-item"><label for="holiday-${holiday.date}"><span>${holiday.name}</span><span class="date">${dateString}</span></label><input type="checkbox" id="holiday-${holiday.date}" name="predefinedHolidays" value="${holiday.date}" checked></div>`;
            }).join('');
        }

        function saveSettings() {
            const checkedHolidays = Array.from(document.querySelectorAll('input[name="predefinedHolidays"]:checked')).map(cb => cb.value);
            const settings = { salary: document.getElementById('basicSalary').value, target: document.getElementById('targetPay').value, checkedHolidays: checkedHolidays, customHolidays: publicHolidays };
            localStorage.setItem('otCalculatorSettings', JSON.stringify(settings));
            alert('Your settings have been saved to this browser.');
        }

        function loadSettings() {
            const savedSettings = localStorage.getItem('otCalculatorSettings');
            if (!savedSettings) return;
            try {
                const settings = JSON.parse(savedSettings);
                if (settings.salary) { const salaryInput = document.getElementById('basicSalary'); salaryInput.value = settings.salary; salaryInput.dispatchEvent(new Event('input')); }
                if (settings.target) { document.getElementById('targetPay').value = settings.target; }
                if (Array.isArray(settings.checkedHolidays)) { document.querySelectorAll('input[name="predefinedHolidays"]').forEach(checkbox => { checkbox.checked = settings.checkedHolidays.includes(checkbox.value); }); }
                if (Array.isArray(settings.customHolidays)) { publicHolidays = settings.customHolidays; updateHolidayList(); }
            } catch (e) {
                console.error("Error loading settings:", e);
                localStorage.removeItem('otCalculatorSettings');
                alert("Could not load settings. They have been reset.");
            }
        }
        
        function addHoliday() { const holidayPicker = document.getElementById('holidayPicker'); const selectedDate = holidayPicker.value; if (!selectedDate || publicHolidays.includes(selectedDate)) return; publicHolidays.push(selectedDate); updateHolidayList(); holidayPicker.value = ''; }
        function removeHoliday(date) { publicHolidays = publicHolidays.filter(holiday => holiday !== date); updateHolidayList(); }
        function updateHolidayList() { const holidayList = document.getElementById('holidayList'); publicHolidays.sort(); holidayList.innerHTML = publicHolidays.map(date => { const holidayDate = new Date(date + 'T00:00:00'); const dayName = getDayOfWeek(holidayDate); const formattedDate = holidayDate.toLocaleDateString('en-GB', { year: 'numeric', month: 'short', day: 'numeric' }); return `<div class="holiday-item"><div><span>${formattedDate}</span> <span class="day">(${dayName})</span></div><button class="remove-holiday-btn" onclick="removeHoliday('${date}')">&times;</button></div>`; }).join('');}
        
        document.getElementById('basicSalary').addEventListener('input', function() { const basicSalary = parseFloat(this.value) || 0; const hourlyRate = basicSalary > 0 ? (basicSalary / 208).toFixed(2) : '0.00'; const display = document.getElementById('hourlyRateDisplay'); display.innerHTML = `Hourly Rate: RM <span id="hourlyRateValue">${hourlyRate}</span>`; display.style.display = basicSalary > 0 ? 'block' : 'none'; });

        function getDayOfWeek(date) { return ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"][date.getDay()]; }
        function getOvertimeTypeClass(type) { if (type.includes('Rest Day')) return 'ot-restday'; if (type.includes('Public Holiday')) return 'ot-holiday'; if (type.includes('Off Day')) return 'ot-weekend'; return 'ot-weekday'; }
        function roundToNearestFiveMinutes(hour, minute) { let totalMinutes = hour * 60 + minute; let roundedMinutes = Math.round(totalMinutes / 5) * 5; return [Math.floor(roundedMinutes / 60) % 24, roundedMinutes % 60]; }
        function generateRandomStartTime(dayOfWeek) { let startHour = (dayOfWeek === 0 || dayOfWeek === 6) ? Math.floor(Math.random() * 9) + 9 : Math.floor(Math.random() * 6) + 18; let startMinute = Math.floor(Math.random() * 60); [startHour, startMinute] = roundToNearestFiveMinutes(startHour, startMinute); return `${String(startHour).padStart(2, '0')}:${String(startMinute).padStart(2, '0')}`; }
        function calculateEndTime(startTime, otHours) { const [startHour, startMinute] = startTime.split(':').map(Number); let totalMinutes = startHour * 60 + startMinute + (otHours * 60); let [endHour, endMinute] = roundToNearestFiveMinutes(0, totalMinutes); return `${String(endHour).padStart(2, '0')}:${String(endMinute).padStart(2, '0')}`; }
        
        function calculateOT() {
            const checkedHolidays = Array.from(document.querySelectorAll('input[name="predefinedHolidays"]:checked')).map(cb => cb.value);
            const allHolidays = [...new Set([...checkedHolidays, ...publicHolidays])];
            const basicSalary = parseFloat(document.getElementById('basicSalary').value);
            const targetPay = parseFloat(document.getElementById('targetPay').value);
            const startDate = new Date(document.getElementById('startDate').value + 'T00:00:00');
            const endDate = new Date(document.getElementById('endDate').value + 'T00:00:00');
            if (!basicSalary || !targetPay || !startDate || !endDate) { alert('Please fill in all required fields!'); return; }
            const hourlyRate = basicSalary / 208;
            const rates = { OT_Rest_Day: hourlyRate * 0.6, OT_1_5: hourlyRate * 1.5, OT_2: hourlyRate * 2.0, OT_1_5_Off_Day: hourlyRate * 1.5 };
            let daysInRange = [], currentDate = new Date(startDate);
            while (currentDate <= endDate) { daysInRange.push(new Date(currentDate)); currentDate.setDate(currentDate.getDate() + 1); }
            let dailyHours = [];
            daysInRange.forEach(date => {
                let dayOfWeek = date.getDay(), randomHours = Math.random() * (8 - 3) + 3, dateString = formatDateToYyyyMmDd(date);
                let overtimeType = "", rate = 0;
                if (allHolidays.includes(dateString)) { overtimeType = "Overtime 2.0x (Public Holiday)"; rate = rates.OT_2; } 
                else if (dayOfWeek === 0) { overtimeType = "Rest Day OT (0.6x)"; rate = rates.OT_Rest_Day; } 
                else if (dayOfWeek === 6) { overtimeType = "Off Day 1.5x (Saturday)"; rate = rates.OT_1_5_Off_Day; } 
                else { overtimeType = "Overtime 1.5x (Weekday)"; rate = rates.OT_1_5; }
                dailyHours.push({ date: dateString, day: getDayOfWeek(date), hours: randomHours, pay: randomHours * rate, type: overtimeType, rate: rate, startTime: generateRandomStartTime(dayOfWeek) });
            });
            const totalAllocatedPay = dailyHours.reduce((acc, day) => acc + day.pay, 0);
            const scaleFactor = totalAllocatedPay > 0 ? targetPay / totalAllocatedPay : 0;
            calculatedDailyHours = dailyHours.map(day => {
                const scaledHours = day.hours * scaleFactor;
                return { ...day, hours: Math.round(scaledHours * 4) / 4, pay: scaledHours * day.rate, endTime: calculateEndTime(day.startTime, scaledHours) };
            });
            displayResults(calculatedDailyHours, targetPay);
        }

        function displayResults(dailyHours, targetPay) {
            const totalHours = dailyHours.reduce((acc, day) => acc + day.hours, 0);
            const totalPay = dailyHours.reduce((acc, day) => acc + day.pay, 0);
            const totalDays = dailyHours.filter(day => day.hours > 0).length;
            
            const breakdown = dailyHours.reduce((acc, day) => {
                if (day.hours > 0) {
                    if (!acc[day.type]) { acc[day.type] = { hours: 0, pay: 0 }; }
                    acc[day.type].hours += day.hours; acc[day.type].pay += day.pay;
                }
                return acc;
            }, {});
            const breakdownHTML = Object.entries(breakdown).map(([type, data]) => `<tr><td><span class="overtime-type ${getOvertimeTypeClass(type)}">${type}</span></td><td><strong>${data.hours.toFixed(2)}h</strong></td><td><strong>RM ${data.pay.toFixed(2)}</strong></td></tr>`).join('');
            
            const tableRows = dailyHours.filter(day => day.hours > 0).map(day => `<tr><td>${day.date}</td><td>${day.day}</td><td><span class="overtime-type ${getOvertimeTypeClass(day.type)}">${day.type}</span></td><td>${day.startTime}</td><td>${day.endTime}</td><td><strong>${day.hours.toFixed(2)}h</strong></td><td><strong>RM ${day.pay.toFixed(2)}</strong></td></tr>`).join('');
            
            const resultsHTML = `<div class="summary-cards">
                    <div class="summary-card"><h4>Total OT Hours</h4><div class="value">${totalHours.toFixed(1)}h</div></div>
                    <div class="summary-card"><h4>Achieved OT Pay</h4><div class="value">RM ${totalPay.toFixed(2)}</div></div>
                    <div class="summary-card"><h4>Days with OT</h4><div class="value">${totalDays}</div></div>
                    <div class="summary-card"><h4>Target Achievement</h4><div class="value">${targetPay > 0 ? ((totalPay / targetPay) * 100).toFixed(1) : '0.0'}%</div></div>
                </div>
                <div class="breakdown-section"><h4>üìä Pay & Hours Breakdown</h4><div class="ot-table"><table><thead><tr><th>Overtime Category</th><th>Total Hours</th><th>Total Pay</th></tr></thead><tbody>${breakdownHTML}</tbody></table></div></div>
                <button class="btn" onclick="exportToCSV()" style="margin-bottom: 20px; background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">üìÑ Export Schedule to CSV</button>
                <div class="ot-table"><table><thead><tr><th>Date</th><th>Day</th><th>OT Type</th><th>Start Time</th><th>End Time</th><th>Hours</th><th>Pay</th></tr></thead><tbody>${tableRows}</tbody></table></div>`;
            
            const resultsEl = document.getElementById('results');
            resultsEl.innerHTML = resultsHTML;
            resultsEl.style.display = 'block';
            resultsEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function exportToCSV() {
            if (calculatedDailyHours.length === 0) { alert("No data to export."); return; }
            const headers = ["Date", "Day", "OT Type", "Start Time", "End Time", "Hours", "Pay (RM)"];
            const rows = calculatedDailyHours.filter(day => day.hours > 0).map(day => [day.date, day.day, `"${day.type}"`, day.startTime, day.endTime, day.hours.toFixed(2), day.pay.toFixed(2)].join(','));
            const csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.join("\n");
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "overtime_schedule.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
